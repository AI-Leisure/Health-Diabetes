<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>Camera All-in-One Tester</title>
<style>
:root{--w:min(100vw,480px)}
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
               "Helvetica Neue",Arial,sans-serif;
  margin:0;padding:1.2rem;display:flex;flex-direction:column;align-items:center}
h1{font-size:1.25rem;margin:.2rem 0 .8rem}
button{margin:.4rem 0;padding:.4rem 1.2rem;font-size:1rem}
video,canvas,img{width:var(--w);max-width:100%;border:1px solid #666}
#log{width:var(--w);max-width:100%;margin-top:.8rem;
     font-size:.9rem;white-space:pre-wrap;background:#111;color:#0f0;padding:.6rem}
</style>

<h1>📷 Camera Tester</h1>

<button id="openBtn">🎥 開相機</button>
<button id="shotBtn" style="display:none">📸 擷取</button>
<button id="stopBtn" style="display:none">⏹️ 關閉</button><br>

<video id="preview" playsinline muted></video>
<canvas id="cvs" style="display:none"></canvas>

<!-- 後備方案：在 getUserMedia 失敗時觸發 -->
<input id="fileInput" type="file"
       accept="image/jpeg"
       capture="environment"
       style="display:none">

<pre id="log">👉 按「開相機」開始測試…</pre>

<script>
/* ========= DOM 快捷 ============ */
const $ = id => document.getElementById(id);
const log = msg => $.log.textContent = msg;

/* ========= 主要元素 ============ */
const openBtn  = $('openBtn');
const shotBtn  = $('shotBtn');
const stopBtn  = $('stopBtn');
const videoEl  = $('preview');
const cvs      = $('cvs');
const fileIn   = $('fileInput');

let stream;     // MediaStream 供關閉用

/* ========= 開相機（優先 getUserMedia） ============ */
openBtn.onclick = async () => {
  // 必須 HTTPS 或 localhost
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    log('🚫 需在 HTTPS 執行，否則無法使用相機！');
    return;
  }

  try {
    stream = await navigator.mediaDevices.getUserMedia(
              { video: { facingMode: { exact:'environment' } } });
    videoEl.srcObject = stream;
    await videoEl.play();
    shotBtn.style.display = stopBtn.style.display = 'inline-block';
    log('✅ getUserMedia 成功，鏡頭已開啟');
  } catch (err) {
    log('⚠️ getUserMedia 失敗：' + err.name +
        '\n→ 改用 <input capture> 後備方案');
    // 退回 input capture
    fileIn.click();
  }
};

/* ========= 擷取一張照片 ============ */
shotBtn.onclick = () => {
  const { videoWidth: w, videoHeight: h } = videoEl;
  if (!w) { log('⚠️ video 未就緒'); return; }
  cvs.width = w; cvs.height = h;
  cvs.getContext('2d').drawImage(videoEl, 0, 0, w, h);
  cvs.toBlob(blob => {
    const kb = (blob.size / 1024).toFixed(1);
    log(`📎 擷取完成：${kb} KB\n（此處可上傳 blob 或做預覽）`);
  }, 'image/jpeg', 0.92);
};

/* ========= 關閉相機 ============ */
stopBtn.onclick = () => {
  stream?.getTracks().forEach(t => t.stop());
  videoEl.srcObject = null;
  shotBtn.style.display = stopBtn.style.display = 'none';
  log('⏹️ 相機已關閉');
};

/* ========= <input capture> 回傳檔案 ============ */
fileIn.onchange = e => {
  const f = e.target.files[0];
  if (f) {
    log('✅ 由 <input> 取得：' + f.name +
        '\n檔案大小：' + (f.size/1024).toFixed(1) + ' KB');
  } else {
    log('🚫 未選擇任何檔案');
  }
};
</script>
</html>
