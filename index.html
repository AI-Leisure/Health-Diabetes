<!DOCTYPE html>
<!--  =======================================================
      ç³–å°¿ç—…å¥åº·ç®¡ç†  v2.1   (2024-06-19)
      â€¢ æ¯å¼µç›¸ç‰‡å¯è¼¸å…¥ã€Œç³–ä»½ g/100gã€â†’ caption é¡¯ç¤º
      â€¢ é»ç¸®åœ–å³ä¸Š âœï¸ ç·¨è¼¯ï¼›æœªå¡«é¡¯ç¤º ? g
    ======================================================= -->
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ç³–å°¿ç—…å¥åº·ç®¡ç†</title>
<style>
:root{--c1:#1976d2;--c2:#d32f2f;--r:8px;
      font-family:system-ui,-apple-system,"Noto Sans","Segoe UI",sans-serif}
*{box-sizing:border-box;margin:0}
body{background:#fafafa;color:#333;display:flex;flex-direction:column;min-height:100vh}
header{background:var(--c1);color:#fff;padding:1rem;text-align:center}
nav{display:flex}
nav button{flex:1;padding:.7rem;border:0;background:#eee;font-size:1rem}
nav button.active{color:var(--c1);background:#fff;font-weight:700;border-bottom:3px solid var(--c1)}
main{flex:1;width:95%;max-width:900px;margin:1rem auto}
section{display:none}section.active{display:block}

form{background:#fff;padding:1rem;border-radius:var(--r);box-shadow:0 2px 6px #0001;display:flex;flex-direction:column;gap:.8rem}
label{display:flex;flex-direction:column;font-weight:600;font-size:.9rem}
input,select,button{padding:.55rem .6rem;font-size:1rem;border:1px solid #ccc;border-radius:var(--r)}
input[type=checkbox]{width:1.2rem;height:1.2rem;margin-right:.45rem}
.inline{flex-direction:row;align-items:center;gap:.45rem}

#photosWrap{display:flex;flex-wrap:wrap;gap:.45rem;margin-top:.4rem}
.photo-thumb{width:80px;height:80px;border:1px solid #ccc;border-radius:var(--r);
             position:relative;overflow:hidden}
.photo-thumb img{width:100%;height:100%;object-fit:cover}
.photo-thumb span.del{position:absolute;top:-6px;right:-6px;background:#fff;border:1px solid #999;
                  border-radius:50%;font-size:.7rem;width:18px;height:18px;line-height:16px;text-align:center;cursor:pointer}
.photo-thumb span.edit{position:absolute;bottom:-6px;right:-6px;background:#fff;border:1px solid #999;
                  border-radius:50%;font-size:.7rem;width:18px;height:18px;line-height:16px;text-align:center;cursor:pointer}
.photo-thumb em{position:absolute;left:0;right:0;bottom:0;background:#0008;color:#fff;
                font-size:.65rem;text-align:center}

#listTools{display:flex;align-items:center;gap:.7rem;margin-bottom:1rem}
#subTabs{display:flex;margin-bottom:1rem}
#subTabs button{flex:1;padding:.6rem;border:0;background:#eee;border-radius:var(--r)}
#subTabs button.active{background:var(--c1);color:#fff}

#listBox .card{background:#fff;padding:1rem;border-radius:var(--r);box-shadow:0 2px 4px #0001;margin-bottom:.9rem}
.card h4{margin-bottom:.35rem;color:var(--c1)}
.attach{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.4rem}
.attach figure{margin:0;position:relative}
.attach img{width:64px;height:64px;object-fit:cover;border-radius:var(--r);border:1px solid #ccc}
.attach figcaption{position:absolute;left:0;right:0;bottom:0;font-size:.6rem;
                   background:#0008;color:#fff;text-align:center;border-radius:0 0 var(--r) var(--r)}

.calendar{width:100%;border-collapse:collapse}
.calendar th,.calendar td{border:1px solid #ddd;width:14.28%;height:88px;vertical-align:top;padding:2px;font-size:.74rem}
.calendar th{background:#f0f0f0}

.chartWrap{margin-top:1.5rem}
canvas{max-width:100%}

/* ======= ç›¸æ©Ÿå…¨è¢å¹• modal ======= */
#camModal{position:fixed;inset:0;background:#000d;display:none;justify-content:center;align-items:center;z-index:99}
#camModal video{width:100vw;height:100vh;object-fit:cover}
#camModal button{position:fixed;bottom:40px;left:50%;transform:translateX(-50%);
                 width:72px;height:72px;border-radius:50%;border:4px solid #fff;background:#fff4;font-size:0}
#camClose{position:fixed;top:20px;right:20px;background:#fff;border:none;
          border-radius:50%;width:38px;height:38px;font-size:1.2rem;line-height:34px}

/* ======= è¼¸å…¥ç³–ä»½å°è©±æ¡† ======= */
#dlg{position:fixed;inset:0;background:#0005;display:none;justify-content:center;align-items:center;z-index:100}
#dlgBox{background:#fff;padding:1.2rem;border-radius:var(--r);width:280px;display:flex;flex-direction:column;gap:.8rem}
</style>
</head>
<body>
<header><h1>ç³–å°¿ç—…å¥åº·ç®¡ç†</h1></header>

<nav>
  <button id="tabForm" class="active">æ–°å¢ç´€éŒ„</button>
  <button id="tabList">ç´€&nbsp;éŒ„</button>
</nav>

<main>
  <!-- ========= A. æ–°å¢ç´€éŒ„ ========= -->
  <section id="formSec" class="active">
    <form id="recordForm">
      <label class="inline">
        <input type="checkbox" id="showInfo"> é¡¯ç¤ºå€‹äººè³‡æ–™
      </label>

      <label>å§“å
        <input id="name" required>
      </label>

      <label>å¹´é½¡
        <input id="age" type="number" min="1" max="120" required>
      </label>

      <label>æ—¥æœŸ
        <input id="date" type="date" required>
      </label>

      <label>é¤æ¬¡
        <select id="meal">
          <option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option>
        </select>
      </label>

      <label>è¡€ç³– (mg/dLï¼Œå¯ç•™ç©º)
        <input id="sugar" type="number" min="20" max="600">
      </label>

      <!-- é£Ÿç‰©ç…§ç‰‡ -->
      <label class="inline">æ‹ç…§
        <button id="captureBtn" type="button">ğŸ“· æ‹ç…§</button>
        <input id="captureIn" type="file" accept="image/jpeg" capture="environment" style="display:none">
      </label>

      <label class="inline">ä¸Šè¼‰é£Ÿç‰©ç…§ç‰‡
        <button id="uploadBtn" type="button">ğŸ“‘ é¸æ“‡æª”æ¡ˆ</button>
        <input id="uploadIn" type="file" accept="image/*" multiple style="display:none">
      </label>
      <small style="color:#666">é» âœï¸ è¼¸å…¥æ¯ 100 g å«ç³– (g)ã€‚é» âœ– åˆªé™¤ç›¸ç‰‡ã€‚</small>

      <div id="photosWrap"></div>

      <button type="submit" style="background:var(--c1);color:#fff">å„²å­˜ç´€éŒ„</button>
    </form>
  </section>

  <!-- ========= B. ç´€éŒ„ ========= -->
  <section id="listSec">
    <div id="listTools">
      <label style="display:flex;flex-direction:column;font-weight:600;font-size:.9rem">
        æœˆä»½
        <input id="filterMonth" type="month">
      </label>
      <button id="toggleChart" style="background:#eee;border:1px solid #ccc;border-radius:var(--r);padding:.45rem .9rem">åˆ†æåœ–è¡¨</button>
    </div>

    <div id="subTabs">
      <button id="subList" class="active">åˆ—è¡¨</button>
      <button id="subCal">æœˆæ›†</button>
    </div>

    <div id="listBox"></div>
    <div id="calBox" style="display:none"></div>

    <div class="chartWrap" style="display:none">
      <canvas id="sugarChart"></canvas>
    </div>
  </section>
</main>

<!-- ========= ç›¸æ©Ÿ Modal ========= -->
<div id="camModal">
  <video id="camPrev" playsinline></video>
  <button id="shutter"></button>
  <button id="camClose">âœ•</button>
</div>

<!-- ========= è¼¸å…¥ç³–ä»½å°è©±æ¡† ========= -->
<div id="dlg">
  <div id="dlgBox">
    <h3 style="margin:0;font-size:1.05rem">æ¯ 100 g å«ç³– (g)</h3>
    <input id="dlgInput" type="number" min="0" step="0.1">
    <div style="display:flex;gap:.6rem;justify-content:flex-end">
      <button id="dlgOK" style="background:var(--c1);color:#fff">ç¢ºå®š</button>
      <button id="dlgCancel">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ---------- å…¨å±€è®Šæ•¸ ---------- */
let photos=[], records=[], chart, chartVisible=false;
let stream;  // camera stream
let dlgIndex=-1; // æ­£åœ¨ç·¨è¼¯çš„ç…§ç‰‡ index

/* ---------- DOM ---------- */
const $=id=>document.getElementById(id);
const dateInput=$('date');
const showInfoChk=$('showInfo');
const sugarInput=$('sugar');
const capBtn=$('captureBtn'), upBtn=$('uploadBtn');
const capIn=$('captureIn'),   upIn=$('uploadIn');
const photosWrap=$('photosWrap');
const filterMonth=$('filterMonth');
const toggleChartBtn=$('toggleChart');
const chartWrap=document.querySelector('.chartWrap');
const listBox=$('listBox'), calBox=$('calBox');
const tabForm=$('tabForm'), tabList=$('tabList');
const formSec=$('formSec'), listSec=$('listSec');
const subList=$('subList'), subCal=$('subCal');

/* ---- dlg ---- */
const dlg=$('dlg'), dlgInput=$('dlgInput');

/* ---------- åˆå§‹åŒ– ---------- */
dateInput.value=new Date().toISOString().split('T')[0];
showInfoChk.checked=false;

/* ---------- äº‹ä»¶ ---------- */
tabForm.onclick=()=>switchTab(true);
tabList.onclick=()=>switchTab(false);
subList.onclick=()=>toggleSub(true);
subCal.onclick=()=>toggleSub(false);
filterMonth.onchange=refresh;
toggleChartBtn.onclick=toggleChart;
showInfoChk.onchange=refresh;
sugarInput.oninput=()=>renderPhotos();

capBtn.onclick=handleCaptureClick;
upBtn.onclick =()=>upIn.click();
capIn.onchange=e=>addFiles(e.target.files);
upIn.onchange =e=>addFiles(e.target.files);

photosWrap.onclick=photoClick;

/* ---------- åˆ†é  ---------- */
function switchTab(show){
  tabForm.classList.toggle('active',show);
  tabList.classList.toggle('active',!show);
  formSec.classList.toggle('active',show);
  listSec.classList.toggle('active',!show);
  if(!show)refresh();
}
function toggleSub(listOn){
  subList.classList.toggle('active',listOn);
  subCal.classList.toggle('active',!listOn);
  listBox.style.display=listOn?'block':'none';
  calBox.style.display=listOn?'none':'block';
}

/* ---------- åœ–ç‰‡å£“ç¸® ---------- */
function compressFile(file){
  return new Promise(res=>{
    const img=new Image();
    img.onload=()=>{
      const max=1024;let {width:w,height:h}=img;
      if(Math.max(w,h)>max){const r=max/Math.max(w,h);w*=r;h*=r;}
      const cvs=document.createElement('canvas');cvs.width=w;cvs.height=h;
      cvs.getContext('2d').drawImage(img,0,0,w,h);
      cvs.toBlob(b=>res(URL.createObjectURL(b)),'image/jpeg',0.7);
    };
    img.src=URL.createObjectURL(file);
  });
}

/* ---------- æ–°å¢ç›¸ç‰‡ ---------- */
async function addFiles(files){
  for(const f of files){
    if(!f.type.startsWith('image/'))continue;
    const url=await compressFile(f);
    photos.push({url,name:f.name,sugarPer100:null});
  }
  renderPhotos();
}

/* ---------- ç¸®åœ–æ¸²æŸ“ ---------- */
function renderPhotos(){
  photosWrap.innerHTML='';
  photos.forEach((p,i)=>{
    const emTxt=p.sugarPer100!==null?`${p.sugarPer100} g`:'? g';
    const d=document.createElement('div');d.className='photo-thumb';
    d.innerHTML=`
      <img src="${p.url}">
      <span class="del" data-del="${i}">âœ–</span>
      <span class="edit" data-edit="${i}">âœï¸</span>
      <em>${emTxt}</em>`;
    photosWrap.appendChild(d);
  });
}

/* ---------- åˆªé™¤ / ç·¨è¼¯ ç³–ä»½ ---------- */
function photoClick(e){
  if(e.target.dataset.del!==undefined){
    photos.splice(+e.target.dataset.del,1);
    renderPhotos();
  }else if(e.target.dataset.edit!==undefined){
    dlgIndex=+e.target.dataset.edit;
    dlgInput.value=photos[dlgIndex].sugarPer100??'';
    dlg.style.display='flex';dlgInput.focus();
  }
}

/* ---------- å°è©±æ¡† ---------- */
$('dlgOK').onclick=()=>{
  const v=parseFloat(dlgInput.value);
  if(!isNaN(v)&&v>=0){photos[dlgIndex].sugarPer100=+v;renderPhotos();}
  dlg.style.display='none';
};
$('dlgCancel').onclick=()=>dlg.style.display='none';
dlg.onclick=e=>{if(e.target===dlg)dlg.style.display='none';};

/* ---------- å„²å­˜ç´€éŒ„ ---------- */
$('recordForm').onsubmit=e=>{
  e.preventDefault();
  const sugarMg=parseFloat(sugarInput.value)||null;
  records.unshift({
    name:$('name').value.trim(),
    age:+$('age').value,
    date:dateInput.value,
    meal:$('meal').value,
    sugarMg,
    sugarMmol:sugarMg? +(sugarMg/18).toFixed(1): null,
    photos:[...photos]   // deep copy
  });
  e.target.reset();photos=[];renderPhotos();
  dateInput.value=new Date().toISOString().split('T')[0];
  refresh();
  alert('å·²å„²å­˜ï¼');
};

/* ---------- åˆ—è¡¨/æ—¥æ›†/åœ–è¡¨ ---------- */
function refresh(){buildList();buildCalendar();if(chartVisible)buildChart();}

function buildList(){
  listBox.innerHTML='';
  const ym=filterMonth.value, show=showInfoChk.checked;
  records.filter(r=>!ym||r.date.startsWith(ym)).forEach(r=>{
    const c=document.createElement('div');c.className='card';
    const name=show?r.name:'****', age=show?r.age:'**';
    c.innerHTML=`
      <h4>${r.date}ï¼ˆ${r.meal}ï¼‰</h4>
      <p>å§“åï¼š${name}ã€€å¹´é½¡ï¼š${age}</p>
      ${r.sugarMg?`<p>è¡€ç³–ï¼š<strong>${r.sugarMg}</strong> mg/dL â‰ˆ ${r.sugarMmol} mmol/L</p>`:'<p>æœªé‡è¡€ç³–</p>'}`;
    if(r.photos.length){
      const at=document.createElement('div');at.className='attach';
      r.photos.forEach(p=>{
        const fig=document.createElement('figure');
        fig.innerHTML=`
          <img src="${p.url}">
          <figcaption>${p.sugarPer100!==null?p.sugarPer100+' g':'? g'}</figcaption>`;
        at.appendChild(fig);
      });
      c.appendChild(at);
    }
    listBox.appendChild(c);
  });
}

function buildCalendar(){
  const ym=filterMonth.value||new Date().toISOString().slice(0,7);
  const [y,m]=ym.split('-').map(Number);
  const first=new Date(y,m-1,1), total=new Date(y,m,0).getDate();
  let html='<table class="calendar"><thead><tr>';
  'æ—¥ä¸€äºŒä¸‰å››äº”å…­'.split('').forEach(d=>html+=`<th>${d}</th>`);html+='</tr></thead><tbody><tr>';
  for(let i=0;i<first.getDay();i++)html+='<td></td>';
  for(let d=1;d<=total;d++){
    const ds=`${ym}-${String(d).padStart(2,'0')}`;
    const rows=records.filter(r=>r.date===ds);
    const sugars=rows.flatMap(r=>r.photos.map(p=>p.sugarPer100).filter(v=>v!==null));
    const avg=sugars.reduce((s,v)=>s+v,0)/(sugars.length||1);
    html+=`<td><strong>${d}</strong><br>${rows.length?`ç­†:${rows.length}<br>Avg:${avg?avg.toFixed(1)+'g':''}`:''}</td>`;
    if((first.getDay()+d)%7===0&&d!==total)html+='</tr><tr>';
  }
  const rest=(first.getDay()+total)%7;if(rest)for(let i=0;i<7-rest;i++)html+='<td></td>';
  html+='</tr></tbody></table>';
  calBox.innerHTML=html;
}

function toggleChart(){
  if(!chartVisible&&getChartRows().length===0){alert('ç›®å‰æ²’æœ‰æ•¸æ“š');return;}
  chartVisible=!chartVisible;
  toggleChartBtn.textContent=chartVisible?'éš±è—åœ–è¡¨':'åˆ†æåœ–è¡¨';
  buildChart();
}

function getChartRows(){
  const ym=filterMonth.value;
  return records.filter(r=>(!ym||r.date.startsWith(ym)) && r.sugarMg);
}
function buildChart(){
  if(!chartVisible){chartWrap.style.display='none';return;}
  const rows=getChartRows();
  if(!rows.length){chartWrap.style.display='none';return;}
  const labels=rows.map(r=>r.date+' '+r.meal);
  const data=rows.map(r=>r.sugarMg);
  chartWrap.style.display='block';
  chart?.destroy();
  chart=new Chart($('sugarChart'),{
    type:'line',
    data:{labels,datasets:[{label:'è¡€ç³– (mg/dL)',data,
      borderColor:'#d32f2f',backgroundColor:'#d32f2f33',
      tension:.25,pointRadius:4,pointBackgroundColor:'#d32f2f'}]},
    options:{scales:{y:{beginAtZero:false}}}
  });
}

/* ---------- CSS var ---------- */
function getCss(n){return getComputedStyle(document.documentElement).getPropertyValue(n).trim();}

/* ---------- ç›¸æ©Ÿ ---------- */
const camModal=$('camModal'), camPrev=$('camPrev'), shutter=$('shutter'), camClose=$('camClose');
async function handleCaptureClick(){
  if(camModal.style.display==='flex')return;
  if(location.protocol!=='https:'&&location.hostname!=='localhost'){capIn.click();return;}
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    camPrev.srcObject=stream;await camPrev.play();
    camModal.style.display='flex';
  }catch{capIn.click();}
}
function takeShot(){
  const w=camPrev.videoWidth,h=camPrev.videoHeight;if(!w)return;
  const max=1024, r=max/Math.max(w,h);const nw=r<1?w*r:w, nh=r<1?h*r:h;
  const cvs=document.createElement('canvas');cvs.width=nw;cvs.height=nh;
  cvs.getContext('2d').drawImage(camPrev,0,0,nw,nh);
  cvs.toBlob(b=>{
    photos.push({url:URL.createObjectURL(b),name:`cam_${Date.now()}.jpg`,sugarPer100:null});
    renderPhotos();closeCam();
  },'image/jpeg',0.7);
}
shutter.onclick=takeShot;camPrev.onclick=takeShot;
camClose.onclick=closeCam;window.addEventListener('keydown',e=>{if(e.key==='Escape')closeCam();});
function closeCam(){stream?.getTracks().forEach(t=>t.stop());stream=null;camModal.style.display='none';}
</script>
</body>
</html>
