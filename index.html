<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ç³–å°¿ç—…å¥åº·ç®¡ç†</title>
<style>
:root{--blue:#0d6efd;--red:#d32f2f;--r:6px;font-family:system-ui,-apple-system,"Noto Sans","Segoe UI",sans-serif}
*{box-sizing:border-box;margin:0}
body{background:#fff;color:#222;min-height:100vh;display:flex;flex-direction:column}
header{background:var(--blue);color:#fff;text-align:center;padding:1.1rem;font-size:1.8rem;font-weight:700}
nav{display:flex;border-bottom:3px solid var(--blue)}
nav button{flex:1;border:0;background:#f0f0f0;padding:.9rem;font-size:1.05rem;font-weight:600;color:#555}
nav button.active{background:#fff;color:var(--blue);border-bottom:3px solid var(--blue)}
main{flex:1;width:94%;max-width:760px;margin:1.2rem auto}

section{display:none}section.active{display:block}

form{display:flex;flex-direction:column;gap:.9rem}
label{display:flex;flex-direction:column;font-weight:600;font-size:.9rem}
input,select,button{font-size:1rem;padding:.6rem .65rem;border:1px solid #bbb;border-radius:var(--r)}
input[type=checkbox]{width:1.2rem;height:1.2rem;margin-right:.4rem}
.inline{flex-direction:row;align-items:center;gap:.4rem}

.personal{display:none}    /* â† é è¨­éš±è—å§“åï¼å¹´é½¡æ¬„ */

#photosWrap{display:flex;flex-wrap:wrap;gap:.45rem;margin-top:.3rem}
.photo{width:80px;height:80px;border:1px solid #bbb;border-radius:var(--r);position:relative;overflow:hidden}
.photo img{width:100%;height:100%;object-fit:cover}
.photo em{position:absolute;left:0;right:0;bottom:0;text-align:center;background:#fff;font-size:.85rem;font-weight:600}
.photo span{position:absolute;top:-5px;right:-5px;width:18px;height:18px;border-radius:50%;background:#fff;border:1px solid #888;font-size:.7rem;line-height:16px;text-align:center;cursor:pointer}

#tools{display:flex;align-items:center;gap:.7rem;margin:1rem 0}
#subTabs{display:flex;margin-bottom:.8rem}
#subTabs button{flex:1;border:1px solid var(--blue);background:#fff;color:var(--blue);padding:.55rem;border-radius:var(--r)}
#subTabs button.active{background:var(--blue);color:#fff}

.list-card{border:1px solid #ddd;border-radius:var(--r);padding:1rem;margin-bottom:1rem}
.list-card h4{color:var(--blue);margin-bottom:.35rem}
.attach{display:flex;gap:.4rem;margin-top:.4rem}
.attach img{width:64px;height:64px;object-fit:cover;border:1px solid #bbb;border-radius:var(--r)}
.attach figcaption{font-size:.85rem;text-align:center}

.calendar{width:100%;border-collapse:collapse}
.calendar th,.calendar td{border:1px solid #ccc;width:14.28%;height:86px;vertical-align:top;font-size:.75rem;padding:2px}
.calendar th{background:#f5f5f5}

.chartWrap{margin-top:1.2rem}
canvas{max-width:100%;height:240px!important}
</style>
</head>
<body>
<header>ç³–å°¿ç—…å¥åº·ç®¡ç†</header>

<nav>
  <button id="tabAdd" class="active">æ–°å¢ç´€éŒ„</button>
  <button id="tabList">ç´€ éŒ„</button>
</nav>

<main>
<!-- æ–°å¢ -->
<section id="addSec" class="active">
  <form id="form">
    <label class="inline"><input type="checkbox" id="showInfo"> é¡¯ç¤ºå€‹äººè³‡æ–™</label>
    <div class="personal">
      <label>å§“å <input id="name"></label>
      <label>å¹´é½¡ <input id="age" type="number" min="1" max="120"></label>
    </div>

    <label>æ—¥æœŸ <input id="date" type="date" required></label>

    <label>é¤æ¬¡
      <select id="meal"><option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option></select>
    </label>

    <label>è¡€ç³– (mmol/Lï¼Œå¯ç•™ç©º) <input id="sugarMmol" type="number" step="0.1" min="1" max="40"></label>

    <label class="inline">æ‹ç…§
      <button id="camBtn" type="button">ğŸ“· æ‹ç…§</button>
      <input id="camIn" type="file" accept="image/*" capture="environment" hidden>
    </label>

    <label class="inline">ä¸Šè¼‰é£Ÿç‰©ç…§ç‰‡
      <button id="fileBtn" type="button">ğŸ“‘ é¸æ“‡æª”æ¡ˆ</button>
      <input id="fileIn" type="file" accept="image/*" multiple hidden>
    </label>

    <small style="color:#666">AI ä¼°å€¼ä¸­é¡¯ç¤º â³ï¼Œå¤±æ•—é¡¯ç¤º âš ï¸ï¼Œå¯æ‰‹å‹•é» âœï¸ ä¿®æ­£ã€‚</small>

    <div id="photosWrap"></div>

    <button style="background:var(--blue);color:#fff">å„²å­˜ç´€éŒ„</button>
  </form>
</section>

<!-- åˆ—è¡¨ -->
<section id="listSec">
  <div id="tools">
    <label style="display:flex;flex-direction:column;font-weight:600;font-size:.9rem">
      æœˆä»½ <input type="month" id="monthPick">
    </label>
    <button id="chartBtn" style="border:1px solid #bbb;background:#fff;border-radius:var(--r);padding:.45rem .9rem">åˆ†æåœ–è¡¨</button>
  </div>

  <div id="subTabs">
    <button id="tabL" class="active">åˆ—è¡¨</button>
    <button id="tabC">æœˆæ›†</button>
  </div>

  <div id="listBox"></div>
  <div id="calBox" style="display:none"></div>

  <div class="chartWrap" style="display:none">
    <canvas id="sugarChart"></canvas>
  </div>
</section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<script>
/* â†â† 114 è¡Œï¼ŒæŠŠä¸‹é¢ URL æ›æˆè‡ªå·±çš„ Cloudflare Worker â–¶â–¶ */
const WORKER='https://off-proxy.leisure9654.workers.dev/

const $=id=>document.getElementById(id);
const today=()=>new Date().toISOString().split('T')[0];

let model,photos=[],records=[],chart,chartShown=false;

/* åˆå§‹åŒ– */
window.addEventListener('DOMContentLoaded',async()=>{
  $('date').value=today();
  $('name').value=localStorage.dm_name||'';$('age').value=localStorage.dm_age||'';
  model=await mobilenet.load();
  toggleInfo();
  render();
});

$('showInfo').onchange=toggleInfo;
function toggleInfo(){
  const s=$('showInfo').checked;
  document.querySelector('.personal').style.display=s?'block':'none';
  $('name').required=$('age').required=s;
}

/* ä¸»åˆ†é  */
$('tabAdd').onclick=()=>switchTab(true);
$('tabList').onclick=()=>switchTab(false);
function switchTab(add){
  $('tabAdd').classList.toggle('active',add);
  $('tabList').classList.toggle('active',!add);
  $('addSec').classList.toggle('active',add);
  $('listSec').classList.toggle('active',!add);
}

/* å­åˆ†é  */
$('tabL').onclick=()=>sub(true);
$('tabC').onclick=()=>sub(false);
function sub(l){
  $('tabL').classList.toggle('active',l);
  $('tabC').classList.toggle('active',!l);
  $('listBox').style.display=l?'block':'none';
  $('calBox').style.display=l?'none':'block';
}

/* ä¸Šè¼‰ / æ‹ç…§ */
$('camBtn').onclick=()=>$('camIn').click();
$('fileBtn').onclick=()=>$('fileIn').click();
$('camIn').onchange=e=>addFiles(e.target.files);
$('fileIn').onchange=e=>addFiles(e.target.files);

async function addFiles(fs){
  for(const f of fs){
    if(!f.type.startsWith('image/'))continue;
    const url=URL.createObjectURL(f);
    const p={url,state:'loading',sugar:null};
    photos.push(p);
    renderPhotos();
    predict(p);
  }
}

/* AI + ç³–ä»½ */
async function predict(p){
  try{
    const img=new Image();img.src=p.url;await img.decode();
    const [pred]=await model.classify(img);
    const label=pred.className.split(',')[0];
    p.sugar=await querySugar(label);
    p.state=p.sugar!==null?'done':'fail';
  }catch{p.state='fail'}
  renderPhotos();render();
}

async function querySugar(label){
  try{
    const url=`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(label)}&search_simple=1&action=process&json=1&page_size=10&fields=nutriments`;
    const r=await fetch(WORKER+'?url='+encodeURIComponent(url));
    const js=await r.json();
    const arr=js.products.filter(p=>p.nutriments?.sugars_100g>0).map(p=>p.nutriments.sugars_100g);
    return arr.length?+(arr.reduce((s,v)=>s+v,0)/arr.length).toFixed(1):null;
  }catch{ return null }
}

/* thumbnails */
$('photosWrap').onclick=e=>{
  const i=e.target.dataset.idx;
  if(i==null)return;
  photos.splice(i,1);
  renderPhotos();render();
};

function renderPhotos(){
  $('photosWrap').innerHTML=photos.map((p,i)=>`
    <div class="photo">
      <img src="${p.url}">
      <em>${p.state==='loading'?'â³':p.state==='fail'?'âš ï¸':p.sugar+' g'}</em>
      <span data-idx="${i}">âœ–</span>
    </div>`).join('');
}

/* å„²å­˜ */
$('form').onsubmit=e=>{
  e.preventDefault();
  if(photos.some(p=>p.state==='loading')){alert('ç›¸ç‰‡ä»åœ¨åˆ†æä¸­');return;}
  localStorage.dm_name=$('name').value.trim();
  localStorage.dm_age=$('age').value.trim();
  records.unshift({
    name:$('name').value.trim(),
    age:$('age').value.trim(),
    date:$('date').value,
    meal:$('meal').value,
    sugarMmol:parseFloat($('sugarMmol').value)||null,
    photos:JSON.parse(JSON.stringify(photos))
  });
  alert('å·²å„²å­˜');
  $('form').reset();$('date').value=today();
  photos=[];renderPhotos();render();
};

/* List / Cal / Chart */
$('monthPick').onchange=render;
$('chartBtn').onclick=()=>{
  chartShown=!chartShown;
  $('chartBtn').textContent=chartShown?'éš±è—åœ–è¡¨':'åˆ†æåœ–è¡¨';
  renderChart();
};

function render(){
  buildList();
  buildCal();
  if(chartShown)renderChart();
}

function buildList(){
  const ym=$('monthPick').value;
  $('listBox').innerHTML=records.filter(r=>!ym||r.date.startsWith(ym)).map(r=>`
    <div class="list-card">
      <h4>${r.date}ï¼ˆ${r.meal}ï¼‰</h4>
      ${r.name||r.age?`<p>å§“åï¼š${r.name||'-'}ã€€å¹´é½¡ï¼š${r.age||'-'}</p>`:''}
      ${r.sugarMmol!=null?`<p>è¡€ç³–ï¼š<strong>${r.sugarMmol}</strong> mmol/L</p>`:''}
      ${r.photos.length?`<div class="attach">
        ${r.photos.map(p=>`<figure><img src="${p.url}"><figcaption>${p.sugar??'?'} g</figcaption></figure>`).join('')}
      </div>`:''}
    </div>`).join('');
}

function buildCal(){
  const ym=$('monthPick').value||today().slice(0,7);
  const [y,m]=ym.split('-').map(Number);
  const first=new Date(y,m-1,1);
  const days=new Date(y,m,0).getDate();
  let html='<table class="calendar"><thead><tr>'+'æ—¥ä¸€äºŒä¸‰å››äº”å…­'.split('').map(d=>`<th>${d}</th>`).join('')+'</tr></thead><tbody><tr>';
  for(let i=0;i<first.getDay();i++)html+='<td></td>';
  for(let d=1;d<=days;d++){
    const ds=`${ym}-${String(d).padStart(2,'0')}`;
    const n=records.filter(r=>r.date===ds).length;
    html+=`<td><strong>${d}</strong><br>${n?`ç­†:${n}`:''}</td>`;
    if((first.getDay()+d)%7===0&&d!==days)html+='</tr><tr>';
  }
  const rem=(first.getDay()+days)%7;if(rem)html+=`<td colspan="${7-rem}"></td>`;
  html+='</tr></tbody></table>';
  $('calBox').innerHTML=html;
}

function renderChart(){
  if(!chartShown){$('chartWrap').style.display='none';return;}
  const ym=$('monthPick').value;
  const data=records.filter(r=>r.sugarMmol!=null && (!ym||r.date.startsWith(ym)));
  if(!data.length){alert('æ²’æœ‰è¡€ç³–æ•¸æ“š');chartShown=false;$('chartBtn').textContent='åˆ†æåœ–è¡¨';return;}
  $('chartWrap').style.display='block';
  chart?.destroy();
  chart=new Chart($('sugarChart'),{
    type:'line',
    data:{labels:data.map(r=>r.date+' '+r.meal),
      datasets:[{label:'è¡€ç³– mmol/L',data:data.map(r=>r.sugarMmol),borderColor:var(--red),backgroundColor:'#d32f2f33',tension:.25}]},
    options:{maintainAspectRatio:false}
  });
}
</script>
</body>
</html>
