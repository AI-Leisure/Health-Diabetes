<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Food Sugar Checker</title>

  <!-- ç°¡æ˜“æ¨£å¼ï¼Œç›´æ¥å¯«åœ¨é é¢æ–¹ä¾¿è¤‡è£½ -->
  <style>
    *{box-sizing:border-box;font-family:system-ui,Helvetica,Arial,sans-serif}
    body{margin:0;padding:2rem;text-align:center;background:#f9fafb;color:#222}
    h1{margin:0 0 1rem;font-size:1.6rem}
    #uploader{margin:1rem 0}
    #canvas{display:none;border:1px solid #ccc;margin:1rem auto}
    #result{margin-top:1rem;font-size:1.1rem;min-height:3.5rem}
    .api{font-size:.8rem;color:#666;margin-top:2rem}
    .loading{opacity:.5;pointer-events:none}
  </style>
</head>
<body>

  <h1>ğŸ© Food Sugar Checker</h1>

  <!-- 1. ä¸Šè¼‰åœ–ç‰‡ -->
  <input id="uploader" type="file" accept="image/*">

  <!-- 2. Canvas è®“ MobileNet ç”¨ä¾†é è™•ç† -->
  <canvas id="canvas" width="224" height="224"></canvas>

  <!-- 3. çµæœé¡¯ç¤º -->
  <div id="result">Select a food pictureâ€¦</div>

  <div class="api">
    Powered by TensorFlow JS MobileNet &amp; OpenFoodFacts API
  </div>

  <!-- 4. è¼‰å…¥ TensorFlow èˆ‡ MobileNet -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.2.0"></script>

  <script>
  /* ---------------- å¯ç·¨è¼¯è¨­å®š ---------------- */
  // æŠŠ YOUR_WORKER_URL æ›æˆä½ çš„ Cloudflare Worker å®Œæ•´ç¶²å€
  const WORKER = 'https://off-proxy.leisure9654.workers.dev/
  /* ------------------------------------------ */

  const fileInput  = document.getElementById('uploader');
  const canvas     = document.getElementById('canvas');
  const resultBox  = document.getElementById('result');
  const ctx        = canvas.getContext('2d');

  let model;

  // 1. è¼‰å…¥ MobileNet
  async function loadModel(){
    resultBox.textContent = 'Loading MobileNet modelâ€¦';
    model = await mobilenet.load();
    resultBox.textContent = 'Model ready âœ…';
  }
  loadModel();

  // 2. ä½¿ç”¨è€…é¸æ“‡åœ–ç‰‡
  fileInput.addEventListener('change', async e=>{
    const file=e.target.files[0];
    if(!file) return;

    // UI é–å®š
    document.body.classList.add('loading');
    resultBox.textContent='Analyzing imageâ€¦';

    // è®€åœ–â†’ç•«åˆ° 224Ã—224 canvas
    const img = new Image();
    img.onload = ()=> {
      ctx.drawImage(img, 0, 0, 224, 224);
      classifyAndQuery();
    };
    img.src = URL.createObjectURL(file);
  });

  // 3. å½±åƒåˆ†é¡ + æŸ¥ç³–ä»½
  async function classifyAndQuery(){
    try{
      // (1) MobileNet å–å‰ 3 å€‹ label
      const predictions = await model.classify(canvas);
      console.log('predictions', predictions);
      if(!predictions.length){
        resultBox.textContent='Could not recognise food ğŸ™ˆ';
        return;
      }
      // å–æœ€å¯èƒ½çš„ä¸€å€‹æ¨™ç±¤
      const label = predictions[0].className.split(',')[0].trim();
      resultBox.textContent = `ğŸ” Searching sugar info for â€œ${label}â€â€¦`;

      // (2) å‘¼å«ä½ çš„ CORS Worker â†’ OpenFoodFacts
      const url = encodeURIComponent(
        `https://world.openfoodfacts.org/api/v2/search?categories_tags_en=${label}&fields=product_name,nutriments&json=1&page_size=1`);
      const resp = await fetch(`${WORKER}?url=${url}`);
      const data = await resp.json();

      const product = data.products?.[0];
      const sugar = product?.nutriments?.['sugars_100g'];

      if(sugar!=null){
        resultBox.innerHTML =
          `ğŸŒŸ ${product.product_name || label}<br>ğŸ§ Sugar â‰ˆ <b>${sugar} g / 100 g</b>`;
      }else{
        resultBox.textContent='No sugar data found ğŸ˜¢';
      }
    }catch(err){
      console.error(err);
      resultBox.textContent='Error ğŸ˜µâ€ğŸ’« â€“ open console for details';
    }finally{
      document.body.classList.remove('loading');
    }
  }
  </script>
</body>
</html>
