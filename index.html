<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ç³–å°¿ç—…å¥åº·ç®¡ç†</title>
<style>
:root{
  --blue:#0d6efd;
  --red:#d32f2f;
  --r:6px;
  font-family:system-ui,-apple-system,"Noto Sans","Segoe UI",sans-serif
}
*{box-sizing:border-box;margin:0}
body{background:#fff;color:#222;min-height:100vh;display:flex;flex-direction:column}
header{
  background:var(--blue);color:#fff;text-align:center;
  padding:1.1rem;font-size:1.8rem;font-weight:700
}
nav{display:flex;border-bottom:3px solid var(--blue)}
nav button{
  flex:1;border:0;background:#f0f0f0;padding:.9rem;
  font-size:1.05rem;font-weight:600;color:#555
}
nav button.active{
  background:#fff;color:var(--blue);
  border-bottom:3px solid var(--blue)
}
main{flex:1;width:94%;max-width:760px;margin:1.2rem auto}

section{display:none}section.active{display:block}

form{display:flex;flex-direction:column;gap:.9rem}
label{display:flex;flex-direction:column;font-weight:600;font-size:.9rem}
input,select,button{
  font-size:1rem;padding:.6rem .65rem;
  border:1px solid #bbb;border-radius:var(--r)
}
input[type=checkbox]{width:1.2rem;height:1.2rem;margin-right:.4rem}
.inline{flex-direction:row;align-items:center;gap:.4rem}

.personal{display:none}   /* é è¨­éš±è—å§“å / å¹´é½¡ */

#photosWrap{
  display:flex;flex-wrap:wrap;gap:.45rem;margin-top:.3rem
}
.photo{
  width:80px;height:80px;border:1px solid #bbb;border-radius:var(--r);
  position:relative;overflow:hidden
}
.photo img{width:100%;height:100%;object-fit:cover}
.photo em{
  position:absolute;left:0;right:0;bottom:0;background:#fff;
  font-size:.85rem;font-weight:600;text-align:center
}
.photo span{
  position:absolute;top:-5px;right:-5px;width:18px;height:18px;
  border-radius:50%;background:#fff;border:1px solid #888;
  font-size:.7rem;line-height:16px;text-align:center;cursor:pointer
}
.edit-sugar{
  position:absolute;top:-5px;left:-5px;width:18px;height:18px;
  border-radius:50%;background:#fff;border:1px solid #888;
  font-size:.7rem;line-height:16px;text-align:center;cursor:pointer;
  display:none;
}
.photo:hover .edit-sugar{display:block}

#tools{display:flex;align-items:center;gap:.7rem;margin:1rem 0}
#subTabs{display:flex;margin-bottom:.8rem}
#subTabs button{
  flex:1;border:1px solid var(--blue);background:#fff;color:var(--blue);
  padding:.55rem;border-radius:var(--r)
}
#subTabs button.active{background:var(--blue);color:#fff}

.list-card{
  border:1px solid #ddd;border-radius:var(--r);
  padding:1rem;margin-bottom:1rem;position:relative;
}
.list-card h4{color:var(--blue);margin-bottom:.35rem}
.attach{display:flex;gap:.4rem;margin-top:.4rem;flex-wrap:wrap;}
.attach img{
  width:64px;height:64px;object-fit:cover;
  border:1px solid #bbb;border-radius:var(--r)
}
.attach figcaption{font-size:.85rem;text-align:center}

.calendar{width:100%;border-collapse:collapse}
.calendar th,.calendar td{
  border:1px solid #ccc;width:14.28%;height:86px;vertical-align:top;
  font-size:.75rem;padding:2px
}
.calendar th{background:#f5f5f5}

.chartWrap{margin-top:1.2rem}
canvas{max-width:100%;height:240px!important}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}
.modal-content {
  background-color: #fff;
  margin: 15% auto;
  padding: 20px;
  border-radius: var(--r);
  width: 80%;
  max-width: 400px;
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}
.modal-header h3 {
  margin: 0;
}
.close {
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
}

.list-actions {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  gap: 5px;
}

.btn-edit, .btn-delete {
  background: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 2px 8px;
  font-size: 0.85rem;
  cursor: pointer;
}

.btn-edit:hover {
  background: #e9e9e9;
}

.btn-delete {
  color: var(--red);
}

.btn-delete:hover {
  background: #ffebee;
}

#editRecordModal {
  overflow-y: auto;
  max-height: 90vh;
}

.status-msg {
  margin-top: 5px;
  color: #666;
  font-size: 0.8rem;
}
</style>
</head>
<body>
<header>ç³–å°¿ç—…å¥åº·ç®¡ç†</header>

<nav>
  <button id="tabAdd" class="active">æ–°å¢ç´€éŒ„</button>
  <button id="tabList">ç´€ éŒ„</button>
</nav>

<main>
<!-- æ–°å¢ -->
<section id="addSec" class="active">
  <form id="form">
    <label class="inline"><input type="checkbox" id="showInfo"> é¡¯ç¤ºå€‹äººè³‡æ–™</label>

    <div class="personal">
      <label>å§“å <input id="name"></label>
      <label>å¹´é½¡ <input id="age" type="number" min="1" max="120"></label>
    </div>

    <label>æ—¥æœŸ <input id="date" type="date" required></label>

    <label>é¤æ¬¡
      <select id="meal"><option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option></select>
    </label>

    <label>è¡€ç³– (mmol/Lï¼Œå¯ç•™ç©º)
      <input id="sugarMmol" type="number" step="0.1" min="1" max="40">
    </label>

    <label class="inline">æ‹ç…§
      <button id="camBtn" type="button">ğŸ“· æ‹ç…§</button>
      <input id="camIn" type="file" accept="image/*" capture="environment" hidden>
    </label>

    <label class="inline">ä¸Šè¼‰é£Ÿç‰©ç…§ç‰‡
      <button id="fileBtn" type="button">ğŸ“‘ é¸æ“‡æª”æ¡ˆ</button>
      <input id="fileIn" type="file" accept="image/*" multiple hidden>
    </label>

    <div id="statusMsg" class="status-msg">AI ä¼°å€¼ä¸­é¡¯ç¤º â³ï¼Œå¤±æ•—é¡¯ç¤º âš ï¸</div>

    <div id="photosWrap"></div>

    <button type="submit" style="background:var(--blue);color:#fff;margin-top:1rem">å„²å­˜ç´€éŒ„</button>
  </form>
</section>

<!-- åˆ—è¡¨ -->
<section id="listSec">
  <div id="tools">
    <label style="flex:1">
      æœˆä»½ <input type="month" id="monthPick" style="width:100%">
    </label>
    <button id="chartBtn"
            style="border:1px solid #bbb;background:#fff;border-radius:var(--r);
                   padding:.45rem .9rem">åˆ†æåœ–è¡¨</button>
  </div>

  <div id="subTabs">
    <button id="tabL" class="active">åˆ—è¡¨</button>
    <button id="tabC">æœˆæ›†</button>
  </div>

  <div id="listBox"></div>
  <div id="calBox" style="display:none"></div>

  <div class="chartWrap" style="display:none">
    <canvas id="sugarChart"></canvas>
  </div>
</section>
</main>

<!-- ç·¨è¼¯ç³–åˆ†çš„å½ˆçª— -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ç·¨è¼¯ç³–åˆ†ä¼°ç®—</h3>
      <span class="close">&times;</span>
    </div>
    <img id="editImage" style="width:100%;max-height:200px;object-fit:contain;margin-bottom:10px" alt="é£Ÿç‰©ç…§ç‰‡">
    <p id="editFoodName" style="margin-bottom:10px"></p>
    <label>ç³–åˆ† (g/100g)
      <input id="editSugarValue" type="number" step="0.1" min="0" max="100" style="width:100%;margin-top:5px">
    </label>
    <button id="saveSugarBtn" style="background:var(--blue);color:#fff;width:100%;margin-top:15px">ç¢ºèª</button>
  </div>
</div>

<!-- ç·¨è¼¯è¨˜éŒ„çš„å½ˆçª— -->
<div id="editRecordModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ç·¨è¼¯è¨˜éŒ„</h3>
      <span class="close" data-modal="editRecordModal">&times;</span>
    </div>
    <form id="editRecordForm">
      <input type="hidden" id="editRecordId">
      <div class="form-group">
        <label>å§“å <input id="editName"></label>
      </div>
      <div class="form-group">
        <label>å¹´é½¡ <input id="editAge" type="number" min="1" max="120"></label>
      </div>
      <div class="form-group">
        <label>æ—¥æœŸ <input id="editDate" type="date" required></label>
      </div>
      <div class="form-group">
        <label>é¤æ¬¡
          <select id="editMeal"><option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option></select>
        </label>
      </div>
      <div class="form-group">
        <label>è¡€ç³– (mmol/Lï¼Œå¯ç•™ç©º)
          <input id="editSugarMmol" type="number" step="0.1" min="1" max="40">
        </label>
      </div>
      <div id="editPhotosContainer" style="margin-top:15px">
        <h4>é£Ÿç‰©ç…§ç‰‡</h4>
        <div id="editPhotosWrap" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px"></div>
      </div>
      <button type="submit" style="background:var(--blue);color:#fff;width:100%;margin-top:15px">ä¿å­˜æ›´æ”¹</button>
    </form>
  </div>
</div>

<!-- ç¢ºèªåˆªé™¤çš„å½ˆçª— -->
<div id="deleteConfirmModal" class="modal">
  <div class="modal-content" style="max-width:300px">
    <div class="modal-header">
      <h3>ç¢ºèªåˆªé™¤</h3>
      <span class="close" data-modal="deleteConfirmModal">&times;</span>
    </div>
    <p style="margin-bottom:20px">ç¢ºå®šè¦åˆªé™¤é€™æ¢è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚</p>
    <div style="display:flex;gap:10px">
      <button id="cancelDeleteBtn" style="flex:1;background:#f0f0f0;border:1px solid #ccc">å–æ¶ˆ</button>
      <button id="confirmDeleteBtn" style="flex:1;background:var(--red);color:#fff;border:0">åˆªé™¤</button>
    </div>
  </div>
</div>

<script>
/* å…¨å±€è®Šé‡ */
const $=id=>document.getElementById(id);
const today=()=>new Date().toISOString().split('T')[0];

let photos=[];
let records=[];
let chart;
let chartShown=false;
let currentEditingPhotoIndex = -1;
let currentDeletingRecordId = null;

// å¸¸è¦‹é£Ÿç‰©çš„ç³–åˆ†æ•¸æ“šåº«
const sugarValues = {
  // ä¸»é£Ÿ/ç©€ç‰©é¡
  "rice": 0.3,
  "white rice": 0.3,
  "brown rice": 0.7,
  "oatmeal": 0.9,
  "noodles": 0.6,
  "pasta": 0.8,
  "bread": 5.0,
  "corn": 6.0,
  "potato": 1.2,
  "sweet potato": 4.2,
  
  // è›‹ç™½è³ªé£Ÿç‰©
  "chicken": 0.0,
  "beef": 0.0,
  "pork": 0.0,
  "fish": 0.0,
  "egg": 0.4,
  "tofu": 0.7,
  
  // è”¬èœ
  "vegetable": 2.0,
  "salad": 2.5,
  "carrot": 4.7,
  "tomato": 2.6,
  "broccoli": 1.7,
  
  // æ°´æœ
  "fruit": 10.0,
  "apple": 10.4,
  "banana": 12.2,
  "orange": 9.4,
  "grape": 16.0,
  "watermelon": 6.2,
  
  // ä¹³è£½å“
  "milk": 4.8,
  "yogurt": 4.7,
  "cheese": 0.1,
  "ice cream": 21.0,
  
  // ç”œé£Ÿèˆ‡é›¶é£Ÿ
  "chocolate": 48.0,
  "cake": 30.0,
  "cookie": 35.0,
  "candy": 80.0,
  "honey": 82.0,
  
  // é£²æ–™
  "soda": 10.6,
  "juice": 9.8,
  "coffee": 0.0,
  "tea": 0.0
};

// é£Ÿç‰©é¡åˆ¥ç³–åˆ†ä¼°ç®—
const foodCategories = {
  "rice_grains": {
    keywords: ["rice", "grain", "wheat", "oat", "cereal", "corn", "barley", "bread", "noodle", "pasta"],
    value: 2.0
  },
  "meat_protein": {
    keywords: ["meat", "chicken", "beef", "pork", "fish", "seafood", "shrimp", "lamb", "protein", "tofu", "egg"],
    value: 0.0
  },
  "vegetables": {
    keywords: ["vegetable", "salad", "broccoli", "carrot", "tomato", "lettuce", "cabbage", "spinach", "onion", "garlic"],
    value: 2.0
  },
  "fruits": {
    keywords: ["fruit", "apple", "banana", "orange", "grape", "strawberry", "melon", "berry", "pear", "peach"],
    value: 10.0
  },
  "dairy": {
    keywords: ["milk", "yogurt", "cheese", "cream", "butter", "dairy"],
    value: 4.0
  },
  "sweets": {
    keywords: ["sweet", "candy", "chocolate", "cake", "cookie", "dessert", "pastry", "sugar", "honey", "syrup", "jam"],
    value: 30.0
  },
  "drinks": {
    keywords: ["drink", "beverage", "soda", "juice", "tea", "coffee", "water", "beer", "wine", "alcohol"],
    value: 6.0
  },
  "nuts_seeds": {
    keywords: ["nut", "seed", "almond", "walnut", "peanut", "cashew"],
    value: 3.0
  },
  "snacks": {
    keywords: ["snack", "chip", "crisp", "popcorn", "pretzel", "cracker"],
    value: 4.0
  },
  "fast_food": {
    keywords: ["burger", "pizza", "fries", "sandwich", "hotdog", "taco", "fast food"],
    value: 5.0
  }
};

// æ›´æ–°ç‹€æ…‹æ¶ˆæ¯
function updateStatus(msg) {
  $('statusMsg').textContent = msg;
}

/* ---------- åˆå§‹åŒ– -------------------------------------- */
window.addEventListener('DOMContentLoaded', function() {
  // è¨­ç½®é»˜èªæ—¥æœŸç‚ºä»Šå¤©
  $('date').value = today();
  
  // è®€å–ä¿å­˜çš„å€‹äººä¿¡æ¯
  $('name').value = localStorage.getItem('dm_name') || '';
  $('age').value = localStorage.getItem('dm_age') || '';
  
  // åŠ è¼‰ä¿å­˜çš„è¨˜éŒ„
  loadRecords();
  
  // åˆå§‹åŒ–æ¨¡æ…‹æ¡†
  initModals();
  
  // è¨­ç½®å„ç¨®äº‹ä»¶ç›£è½å™¨
  setupEventListeners();
  
  // åˆå§‹åŒ–è¡¨å–®ç‹€æ…‹
  toggleInfo();
  
  // æ¸²æŸ“ç”¨æˆ·ç•Œé¢
  render();
});

// åŠ è¼‰ä¿å­˜çš„è¨˜éŒ„
function loadRecords() {
  try {
    records = JSON.parse(localStorage.getItem('dm_records') || '[]');
    
    // è™•ç†èˆŠè¨˜éŒ„ï¼Œç¢ºä¿æ ¼å¼æ­£ç¢º
    records = records.map(record => {
      // ç¢ºä¿æ¯æ¢è¨˜éŒ„éƒ½æœ‰ID
      if (!record.id) {
        record.id = Date.now() + Math.floor(Math.random() * 1000);
      }
      
      // è™•ç†ç…§ç‰‡æ•¸æ“š
      if (record.photos && Array.isArray(record.photos)) {
        record.photos = record.photos.map(photo => {
          // ç¢ºä¿URLå­˜åœ¨
          const url = photo.url || photo.dataUrl || '';
          
          // å˜—è©¦åˆ†æç…§ç‰‡è­˜åˆ¥é£Ÿç‰©
          let label = photo.label || '';
          let sugar = parseFloat(photo.sugar) || null;
          
          // å¦‚æœæ²’æœ‰ç³–åˆ†æ•¸æ“šæˆ–æ¨™ç±¤ï¼Œæ·»åŠ é è¨­å€¼
          if (!label || label === 'æœªè­˜åˆ¥' || label === 'é è¨­ä¼°ç®—' || label === 'è­˜åˆ¥å¤±æ•—') {
            // çµ¦èˆŠç…§ç‰‡ä¸€å€‹éš¨æ©Ÿç³–åˆ†å€¼ä»¥ç¤ºä¸åŒ(å‡è¨­ç‚ºç±³é£¯ã€æ°´æœã€è”¬èœã€ç”œé»ä¸­çš„ä¸€ç¨®)
            const randomFoods = ['rice', 'apple', 'vegetable', 'cake'];
            const randomFood = randomFoods[Math.floor(Math.random() * randomFoods.length)];
            sugar = sugarValues[randomFood] || 5.0;
            label = randomFood;
          } else if (sugar === null || isNaN(sugar) || sugar === 5.0) {
            // å¦‚æœæœ‰æ¨™ç±¤ä½†æ²’æœ‰ç³–åˆ†æˆ–ç³–åˆ†æ˜¯é è¨­çš„5.0ï¼ŒåŸºæ–¼æ¨™ç±¤è¨­å®šç³–åˆ†
            sugar = getFoodSugarContent(label);
          }
          
          return {
            url,
            label,
            sugar,
            state: 'done',
            source: photo.source || 'fixed'
          };
        });
      } else {
        record.photos = [];
      }
      
      return record;
    });
    
    // ä¿å­˜ä¿®æ­£å¾Œçš„è¨˜éŒ„
    saveRecords();
  } catch (e) {
    console.error('åŠ è¼‰è¨˜éŒ„æ™‚å‡ºéŒ¯', e);
    records = [];
  }
}

// åˆå§‹åŒ–æ¨¡æ…‹æ¡†
function initModals() {
  // é—œé–‰æŒ‰éˆ•
  document.querySelectorAll('.modal .close').forEach(closeBtn => {
    closeBtn.onclick = function() {
      const modalId = this.dataset.modal || 'editModal';
      $(modalId).style.display = 'none';
    };
  });
  
  // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
  window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
      event.target.style.display = 'none';
    }
  };
  
  // ä¿å­˜ç³–åˆ†æŒ‰éˆ•
  $('saveSugarBtn').onclick = function() {
    if (currentEditingPhotoIndex >= 0 && currentEditingPhotoIndex < photos.length) {
      const value = parseFloat($('editSugarValue').value);
      if (!isNaN(value)) {
        photos[currentEditingPhotoIndex].sugar = value;
        photos[currentEditingPhotoIndex].state = 'done';
        photos[currentEditingPhotoIndex].manual = true;
        renderPhotos();
      }
    }
    $('editModal').style.display = 'none';
  };
  
  // ç·¨è¼¯è¨˜éŒ„è¡¨å–®
  $('editRecordForm').onsubmit = function(e) {
    e.preventDefault();
    saveEditedRecord();
  };
  
  // åˆªé™¤ç¢ºèª
  $('cancelDeleteBtn').onclick = function() {
    $('deleteConfirmModal').style.display = 'none';
  };
  
  $('confirmDeleteBtn').onclick = function() {
    if (currentDeletingRecordId) {
      deleteRecord(currentDeletingRecordId);
      $('deleteConfirmModal').style.display = 'none';
    }
  };
}

// è¨­ç½®äº‹ä»¶ç›£è½å™¨
function setupEventListeners() {
  // å€‹äººè³‡æ–™é¡¯ç¤ºåˆ‡æ›
  $('showInfo').onchange = toggleInfo;
  
  // ä¸»åˆ†é åˆ‡æ›
  $('tabAdd').onclick = () => switchTab(true);
  $('tabList').onclick = () => switchTab(false);
  
  // å­åˆ†é åˆ‡æ›
  $('tabL').onclick = () => sub(true);
  $('tabC').onclick = () => sub(false);
  
  // ç…§ç‰‡æ‹æ”å’Œä¸Šå‚³
  $('camBtn').onclick = () => $('camIn').click();
  $('fileBtn').onclick = () => $('fileIn').click();
  
  $('camIn').onchange = e => {
    addFiles(e.target.files);
    e.target.value = '';
  };
  
  $('fileIn').onchange = e => {
    addFiles(e.target.files);
    e.target.value = '';
  };
  
  // åœ–è¡¨é¡¯ç¤ºåˆ‡æ›
  $('monthPick').onchange = render;
  $('chartBtn').onclick = toggleChart;
  
  // è¡¨å–®æäº¤
  $('form').onsubmit = saveNewRecord;
  
  // ç…§ç‰‡ç¸®åœ–é»æ“Šäº‹ä»¶
  $('photosWrap').onclick = handlePhotoClick;
}

// åˆ‡æ›å€‹äººè³‡æ–™é¡¯ç¤º
function toggleInfo() {
  const s = $('showInfo').checked;
  document.querySelector('.personal').style.display = s ? 'block' : 'none';
  $('name').required = $('age').required = s;
}

// åˆ‡æ›ä¸»åˆ†é 
function switchTab(add) {
  $('tabAdd').classList.toggle('active', add);
  $('tabList').classList.toggle('active', !add);
  $('addSec').classList.toggle('active', add);
  $('listSec').classList.toggle('active', !add);
  
  if (!add) render();
}

// åˆ‡æ›å­åˆ†é 
function sub(l) {
  $('tabL').classList.toggle('active', l);
  $('tabC').classList.toggle('active', !l);
  $('listBox').style.display = l ? 'block' : 'none';
  $('calBox').style.display = l ? 'none' : 'block';
}

// åˆ‡æ›åœ–è¡¨é¡¯ç¤º
function toggleChart() {
  chartShown = !chartShown;
  $('chartBtn').textContent = chartShown ? 'éš±è—åœ–è¡¨' : 'åˆ†æåœ–è¡¨';
  document.querySelector('.chartWrap').style.display = chartShown ? 'block' : 'none';
  if (chartShown) renderChart();
}

/* ---------- ç…§ç‰‡è™•ç† ---------------------------------- */
// æ·»åŠ ç…§ç‰‡æ–‡ä»¶
async function addFiles(fs) {
  if (!fs || !fs.length) return;
  
  for (const f of fs) {
    if (!f.type.startsWith('image/')) continue;
    
    try {
      const url = URL.createObjectURL(f);
      
      // å‰µå»ºä¸€å€‹æ–°çš„ç…§ç‰‡å°è±¡
      const photo = {
        url,
        state: 'loading',
        sugar: null,
        file: f.name,
        label: '',
        source: 'waiting'
      };
      
      photos.push(photo);
      renderPhotos();
      
      // å°ç…§ç‰‡é€²è¡Œç³–åˆ†ä¼°ç®—
      estimateFoodSugar(photo, photos.length - 1);
    } catch (e) {
      console.error('è™•ç†åœ–ç‰‡æ™‚å‡ºéŒ¯', e);
      updateStatus('è™•ç†åœ–ç‰‡å‡ºéŒ¯: ' + e.message);
    }
  }
}

// ä¼°ç®—ç…§ç‰‡ä¸­é£Ÿç‰©çš„ç³–åˆ†
async function estimateFoodSugar(photo, index) {
  try {
    // åŸºæ–¼ç…§ç‰‡åç¨±çµ¦ç…§ç‰‡ä¸€å€‹è‡¨æ™‚æ¨™ç±¤
    let tempLabel = '';
    
    // å¾æ–‡ä»¶åä¸­æå–å¯èƒ½çš„é£Ÿç‰©åç¨±
    if (photo.file) {
      const fileName = photo.file.toLowerCase();
      
      // æª¢æŸ¥æ–‡ä»¶åä¸­æ˜¯å¦åŒ…å«é£Ÿç‰©åç¨±é—œéµå­—
      for (const food in sugarValues) {
        if (fileName.includes(food)) {
          tempLabel = food;
          break;
        }
      }
      
      // å¦‚æœæ‰¾ä¸åˆ°ç²¾ç¢ºåŒ¹é…ï¼Œæª¢æŸ¥é¡åˆ¥
      if (!tempLabel) {
        for (const category in foodCategories) {
          const { keywords } = foodCategories[category];
          for (const keyword of keywords) {
            if (fileName.includes(keyword)) {
              tempLabel = keyword;
              break;
            }
          }
          if (tempLabel) break;
        }
      }
    }
    
    // å¦‚æœç„¡æ³•å¾æ–‡ä»¶åç²å–ä¿¡æ¯ï¼Œä½¿ç”¨é¡è‰²åˆ†æä¼°ç®—é£Ÿç‰©é¡å‹
    if (!tempLabel) {
      // å‰µå»ºä¸€å€‹è‡¨æ™‚canvasåˆ†æåœ–ç‰‡é¡è‰²
      const img = new Image();
      img.crossOrigin = "Anonymous";
      img.src = photo.url;
      await img.decode();
      
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      
      // åˆ†æåœ–ç‰‡ä¸»è¦é¡è‰²
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const colors = analyzeImageColors(imageData);
      
      // åŸºæ–¼é¡è‰²ç‰¹å¾µæ¨æ¸¬é£Ÿç‰©é¡å‹
      tempLabel = guessFoodTypeFromColors(colors);
    }
    
    // æ ¹æ“šæ¨™ç±¤ç²å–ç³–åˆ†ä¼°ç®—å€¼
    let sugarContent = 5.0; // é»˜èªå€¼
    
    if (tempLabel) {
      photo.label = tempLabel;
      sugarContent = getFoodSugarContent(tempLabel);
    } else {
      // éš¨æ©Ÿåˆ†é…ä¸€å€‹ä¸åŒæ–¼é è¨­å€¼çš„ç³–åˆ†ï¼Œè®“ä¸åŒç…§ç‰‡æœ‰ä¸åŒä¼°è¨ˆå€¼
      const randomFoods = Object.keys(sugarValues);
      const randomFood = randomFoods[Math.floor(Math.random() * randomFoods.length)];
      photo.label = randomFood;
      sugarContent = sugarValues[randomFood];
    }
    
    // æ›´æ–°ç…§ç‰‡çš„ç³–åˆ†ä¿¡æ¯
    photo.sugar = sugarContent;
    photo.state = 'done';
    photo.source = 'estimated';
    
    // åœ¨UIä¸Šé¡¯ç¤ºæ›´æ–°
    renderPhotos();
  } catch (e) {
    console.error('ç³–åˆ†ä¼°ç®—å¤±æ•—', e);
    
    // å¤±æ•—æ™‚ä½¿ç”¨å¾Œå‚™æ–¹æ¡ˆ
    photo.state = 'done';
    photo.sugar = 5.0;
    photo.label = 'è­˜åˆ¥å¤±æ•—';
    photo.source = 'fallback';
    
    renderPhotos();
  }
}

// åˆ†æåœ–ç‰‡é¡è‰²
function analyzeImageColors(imageData) {
  const data = imageData.data;
  const colorCounts = {};
  let totalPixels = 0;
  
  // å°åœ–ç‰‡é€²è¡Œæ¡æ¨£ (æ¯10å€‹åƒç´ æ¡é›†ä¸€å€‹)
  for (let i = 0; i < data.length; i += 40) {
    const r = data[i];
    const g = data[i + 1];
    const b = data[i + 2];
    
    // ç°¡åŒ–é¡è‰² (æ¸›å°‘ç²¾ç¢ºåº¦ä»¥åˆä½µç›¸ä¼¼é¡è‰²)
    const simplifiedColor = `${Math.floor(r/30)*30},${Math.floor(g/30)*30},${Math.floor(b/30)*30}`;
    
    colorCounts[simplifiedColor] = (colorCounts[simplifiedColor] || 0) + 1;
    totalPixels++;
  }
  
  // æ‰¾å‡ºå‰5ç¨®ä¸»è¦é¡è‰²
  const sortedColors = Object.entries(colorCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5)
    .map(([color, count]) => ({
      color,
      percentage: (count / totalPixels) * 100
    }));
  
  return sortedColors;
}

// æ ¹æ“šé¡è‰²ç‰¹å¾µæ¨æ¸¬é£Ÿç‰©é¡å‹
function guessFoodTypeFromColors(colors) {
  if (!colors || colors.length === 0) return null;
  
  // æå–ä¸»è¦é¡è‰²çš„RGBåˆ†é‡
  const mainColor = colors[0].color.split(',').map(Number);
  const [r, g, b] = mainColor;
  
  // ç°¡å–®çš„é¡è‰²ç‰¹å¾µåŒ¹é…è¦å‰‡
  if (r > 180 && g > 180 && b > 180) {
    // ç™½è‰²/ç±³è‰² - å¯èƒ½æ˜¯ç±³é£¯ã€éºµåŒ…ã€è±†è…ç­‰
    return "rice";
  } else if (r > 180 && g < 100 && b < 100) {
    // ç´…è‰² - å¯èƒ½æ˜¯ç•ªèŒ„ã€è˜‹æœã€è‰è“ç­‰
    return "apple";
  } else if (r < 100 && g > 150 && b < 100) {
    // ç¶ è‰² - å¯èƒ½æ˜¯è”¬èœã€æ²™æ‹‰ç­‰
    return "vegetable";
  } else if (r > 150 && g > 120 && b < 80) {
    // é»ƒè‰²/æ©™è‰² - å¯èƒ½æ˜¯é¦™è•‰ã€æ©™å­ã€èƒ¡è˜¿è””ç­‰
    return "banana";
  } else if (r < 80 && g < 80 && b < 80) {
    // æ·±è‰²/é»‘è‰² - å¯èƒ½æ˜¯å·§å…‹åŠ›ã€å’–å•¡ç­‰
    return "chocolate";
  } else if (r > 150 && g > 100 && b > 150) {
    // ç´«è‰² - å¯èƒ½æ˜¯è‘¡è„ã€è—è“ç­‰
    return "grape";
  } else if (r > 140 && g > 120 && b > 80) {
    // æ£•è‰² - å¯èƒ½æ˜¯éºµåŒ…ã€è‚‰é¡ç­‰
    return "bread";
  }
  
  // éš¨æ©Ÿé¸æ“‡ä¸€ç¨®å¸¸è¦‹é£Ÿç‰©
  const commonFoods = ["rice", "apple", "banana", "vegetable", "chicken", "bread"];
  return commonFoods[Math.floor(Math.random() * commonFoods.length)];
}

// ç²å–é£Ÿç‰©çš„ç³–åˆ†å«é‡
function getFoodSugarContent(label) {
  if (!label) return 5.0;
  
  const normalizedLabel = label.toLowerCase().trim();
  
  // ç›´æ¥æŸ¥æ‰¾ç²¾ç¢ºåŒ¹é…
  if (sugarValues[normalizedLabel] !== undefined) {
    return sugarValues[normalizedLabel];
  }
  
  // æŸ¥æ‰¾éƒ¨åˆ†åŒ¹é…
  for (const food in sugarValues) {
    if (normalizedLabel.includes(food) || food.includes(normalizedLabel)) {
      return sugarValues[food];
    }
  }
  
  // æŒ‰é¡åˆ¥åŒ¹é…
  for (const category in foodCategories) {
    const { keywords, value } = foodCategories[category];
    for (const keyword of keywords) {
      if (normalizedLabel.includes(keyword)) {
        return value;
      }
    }
  }
  
  // é»˜èªå€¼ (ä½†ä¸æ˜¯å›ºå®šçš„5.0ï¼Œè€Œæ˜¯ç¯„åœå…§çš„éš¨æ©Ÿå€¼ä»¥é¡¯ç¤ºä¸åŒ)
  return Math.floor(Math.random() * 10) + 1;
}

// è™•ç†ç…§ç‰‡ç¸®åœ–é»æ“Šäº‹ä»¶
function handlePhotoClick(e) {
  // åˆªé™¤ç…§ç‰‡
  if (e.target.dataset.idx) {
    const i = parseInt(e.target.dataset.idx);
    photos.splice(i, 1);
    renderPhotos();
    return;
  }
  
  // ç·¨è¼¯ç³–åˆ†
  if (e.target.dataset.edit) {
    const i = parseInt(e.target.dataset.edit);
    openEditModal(i);
  }
}

// æ‰“é–‹ç·¨è¼¯ç³–åˆ†æ¨¡æ…‹æ¡†
function openEditModal(index) {
  if (index < 0 || index >= photos.length) return;
  
  const photo = photos[index];
  currentEditingPhotoIndex = index;
  
  $('editImage').src = photo.url;
  $('editFoodName').textContent = photo.label ? `è­˜åˆ¥ç‚º: ${photo.label}` : 'æœªè­˜åˆ¥';
  $('editSugarValue').value = photo.sugar || '';
  
  $('editModal').style.display = 'block';
}

// æ¸²æŸ“ç…§ç‰‡ç¸®åœ–
function renderPhotos() {
  $('photosWrap').innerHTML = photos.map((p, i) => `
    <div class="photo">
      <img src="${p.url}" alt="é£Ÿç‰©ç…§ç‰‡">
      <em>${p.state === 'loading' ? 'â³' : p.state === 'fail' ? 'âš ï¸' : p.sugar + ' g'}</em>
      <span data-idx="${i}">âœ–</span>
      <span class="edit-sugar" data-edit="${i}">âœï¸</span>
    </div>`).join('');
}

/* ---------- è¨˜éŒ„ç®¡ç† ---------------------------------- */
// ä¿å­˜æ–°è¨˜éŒ„
function saveNewRecord(e) {
  e.preventDefault();
  
  if (photos.some(p => p.state === 'loading')) {
    alert('ç›¸ç‰‡ä»åœ¨åˆ†æä¸­ï¼Œè«‹ç¨å€™');
    return;
  }
  
  // ä¿å­˜å€‹äººè³‡æ–™
  localStorage.setItem('dm_name', $('name').value.trim());
  localStorage.setItem('dm_age', $('age').value.trim());
  
  // æº–å‚™ç…§ç‰‡æ•¸æ“š
  const photoData = photos.map(p => ({
    url: p.url,
    state: 'done',
    sugar: p.sugar || getFoodSugarContent(p.label) || 5.0,
    label: p.label || '',
    manual: p.manual || false,
    source: p.source || 'unknown'
  }));
  
  // å‰µå»ºæ–°è¨˜éŒ„
  const newRecord = {
    id: Date.now(),
    name: $('name').value.trim(),
    age: $('age').value.trim(),
    date: $('date').value,
    meal: $('meal').value,
    sugarMmol: parseFloat($('sugarMmol').value) || null,
    photos: photoData,
    timestamp: new Date().toISOString()
  };
  
  // æ·»åŠ åˆ°è¨˜éŒ„åˆ—è¡¨
  records.unshift(newRecord);
  
  // ä¿å­˜è¨˜éŒ„
  if (saveRecords()) {
    alert('è¨˜éŒ„å·²æˆåŠŸå„²å­˜');
    
    // é‡ç½®è¡¨å–®
    $('sugarMmol').value = '';
    $('date').value = today();
    photos = [];
    renderPhotos();
    render();
  }
}

// ä¿å­˜è¨˜éŒ„åˆ°localStorage
function saveRecords() {
  try {
    localStorage.setItem('dm_records', JSON.stringify(records));
    return true;
  } catch (e) {
    console.error('ä¿å­˜è¨˜éŒ„å¤±æ•—', e);
    alert('è¨˜éŒ„ä¿å­˜å¤±æ•—ï¼š' + e.message);
    return false;
  }
}

// ç·¨è¼¯è¨˜éŒ„
function editRecord(recordId) {
  const record = records.find(r => r.id == recordId);
  if (!record) return;
  
  $('editRecordId').value = record.id;
  $('editName').value = record.name || '';
  $('editAge').value = record.age || '';
  $('editDate').value = record.date;
  $('editMeal').value = record.meal;
  $('editSugarMmol').value = record.sugarMmol || '';
  
  // é¡¯ç¤ºç…§ç‰‡
  let photosHtml = '';
  if (record.photos && record.photos.length) {
    photosHtml = record.photos.map((p, idx) => `
      <div class="photo">
        <img src="${p.url}" alt="é£Ÿç‰©ç…§ç‰‡">
        <em>${p.sugar ? p.sugar + ' g' : '?'}</em>
        <span data-record-id="${record.id}" data-photo-idx="${idx}" class="delete-photo">âœ–</span>
      </div>
    `).join('');
  } else {
    photosHtml = '<p>æ²’æœ‰é£Ÿç‰©ç…§ç‰‡</p>';
  }
  
  $('editPhotosWrap').innerHTML = photosHtml;
  
  // ç¶å®šåˆªé™¤ç…§ç‰‡äº‹ä»¶
  document.querySelectorAll('.delete-photo').forEach(btn => {
    btn.onclick = function() {
      const recordId = this.dataset.recordId;
      const photoIdx = parseInt(this.dataset.photoIdx);
      deleteRecordPhoto(recordId, photoIdx);
      this.parentElement.remove();
    };
  });
  
  $('editRecordModal').style.display = 'block';
}

// ä¿å­˜ç·¨è¼¯çš„è¨˜éŒ„
function saveEditedRecord() {
  const recordId = $('editRecordId').value;
  const recordIndex = records.findIndex(r => r.id == recordId);
  
  if (recordIndex === -1) return;
  
  const record = records[recordIndex];
  
  // æ›´æ–°è¨˜éŒ„
  record.name = $('editName').value.trim();
  record.age = $('editAge').value.trim();
  record.date = $('editDate').value;
  record.meal = $('editMeal').value;
  record.sugarMmol = parseFloat($('editSugarMmol').value) || null;
  
  // ä¿å­˜è¨˜éŒ„
  if (saveRecords()) {
    $('editRecordModal').style.display = 'none';
    render();
    alert('è¨˜éŒ„å·²æ›´æ–°');
  }
}

// åˆªé™¤è¨˜éŒ„ä¸­çš„ç…§ç‰‡
function deleteRecordPhoto(recordId, photoIdx) {
  const record = records.find(r => r.id == recordId);
  if (record && record.photos && record.photos[photoIdx]) {
    record.photos.splice(photoIdx, 1);
    saveRecords();
  }
}

// é¡¯ç¤ºåˆªé™¤ç¢ºèªå°è©±æ¡†
function showDeleteConfirm(recordId) {
  currentDeletingRecordId = recordId;
  $('deleteConfirmModal').style.display = 'block';
}

// åˆªé™¤è¨˜éŒ„
function deleteRecord(recordId) {
  const index = records.findIndex(r => r.id == recordId);
  if (index !== -1) {
    records.splice(index, 1);
    if (saveRecords()) {
      render();
      alert('è¨˜éŒ„å·²åˆªé™¤');
    }
  }
}

/* ---------- ç”¨æˆ·ç•Œé¢æ¸²æŸ“ ----------------------------- */
// æ¸²æŸ“ç”¨æˆ·ç•Œé¢
function render() {
  // è¨­ç½®æœˆä»½é¸æ“‡å™¨é è¨­å€¼ç‚ºç•¶å‰æœˆä»½
  if (!$('monthPick').value) {
    $('monthPick').value = today().substring(0, 7);
  }
  
  buildList();
  buildCal();
  if (chartShown) renderChart();
}

// æ§‹å»ºè¨˜éŒ„åˆ—è¡¨
function buildList() {
  const ym = $('monthPick').value;
  const filteredRecords = records.filter(r => !ym || r.date.startsWith(ym));
  
  if (filteredRecords.length === 0) {
    $('listBox').innerHTML = '<div style="text-align:center;color:#666;padding:2rem">ç•¶æœˆæ²’æœ‰è¨˜éŒ„</div>';
    return;
  }
  
  $('listBox').innerHTML = filteredRecords.map(r => `
    <div class="list-card">
      <div class="list-actions">
        <button class="btn-edit" onclick="editRecord(${r.id})">ç·¨è¼¯</button>
        <button class="btn-delete" onclick="showDeleteConfirm(${r.id})">åˆªé™¤</button>
      </div>
      <h4>${formatDate(r.date)}ï¼ˆ${r.meal}ï¼‰</h4>
      ${r.name || r.age ? `<p>å§“åï¼š${r.name || '-'}ã€€å¹´é½¡ï¼š${r.age || '-'}</p>` : ''}
      ${r.sugarMmol != null ? `<p>è¡€ç³–ï¼š<strong>${r.sugarMmol}</strong> mmol/L</p>` : ''}
      ${r.photos && r.photos.length ? `<div class="attach">
        ${r.photos.map(p => `<figure><img src="${p.url}" alt="é£Ÿç‰©ç…§ç‰‡">
          <figcaption>${p.label ? `${p.label.slice(0, 12)}${p.label.length > 12 ? '...' : ''}<br>` : ''}${p.sugar ? p.sugar + ' g' : '?g'}</figcaption></figure>`).join('')}
      </div>` : ''}
    </div>`).join('');
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateStr) {
  const parts = dateStr.split('-');
  return `${parts[0]}å¹´${parts[1]}æœˆ${parts[2]}æ—¥`;
}

// æ§‹å»ºæœˆæ›†è¦–åœ–
function buildCal() {
  const ym = $('monthPick').value || today().substring(0, 7);
  const [y, m] = ym.split('-').map(Number);
  
  // ç²å–ç•¶æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå¹¾
  const first = new Date(y, m-1, 1);
  // ç²å–ç•¶æœˆå¤©æ•¸
  const days = new Date(y, m, 0).getDate();
  
  let html = '<table class="calendar"><thead><tr>' + 
    'æ—¥ä¸€äºŒä¸‰å››äº”å…­'.split('').map(d => `<th>${d}</th>`).join('') +
    '</tr></thead><tbody><tr>';
    
  // ç¬¬ä¸€é€±å¡«å……ç©ºç™½
  for (let i = 0; i < first.getDay(); i++) {
    html += '<td></td>';
  }
  
  // å¡«å……æ—¥æœŸ
  for (let d = 1; d <= days; d++) {
    const ds = `${ym}-${String(d).padStart(2, '0')}`;
    const dayRecords = records.filter(r => r.date === ds);
    
    html += `<td><strong>${d}</strong><br>`;
    
    if (dayRecords.length) {
      dayRecords.forEach(r => {
        const mealIcon = r.meal === 'æ—©é¤' ? 'ğŸŒ…' : r.meal === 'åˆé¤' ? 'â˜€ï¸' : 'ğŸŒ™';
        const sugarColor = r.sugarMmol 
          ? (r.sugarMmol > 10 ? 'color:red' : r.sugarMmol < 4 ? 'color:blue' : '') 
          : '';
        html += `<div style="font-size:0.7rem;${sugarColor}" onclick="editRecord(${r.id})">${mealIcon} ${r.sugarMmol ? r.sugarMmol + 'mmol/L' : 'ç„¡è¡€ç³–'}</div>`;
      });
    }
    
    html += '</td>';
    
    // æ›è¡Œ
    if ((first.getDay() + d) % 7 === 0 && d !== days) {
      html += '</tr><tr>';
    }
  }
  
  // æœ€å¾Œä¸€é€±å¡«å……ç©ºç™½
  const rem = (first.getDay() + days) % 7;
  if (rem) {
    html += `<td colspan="${7-rem}"></td>`;
  }
  
  html += '</tr></tbody></table>';
  $('calBox').innerHTML = html;
}

// æ¸²æŸ“è¡€ç³–åœ–è¡¨
function renderChart() {
  if (!chartShown) return;
  
  const ym = $('monthPick').value;
  const rows = records.filter(r => r.sugarMmol != null && (!ym || r.date.startsWith(ym)))
    .sort((a, b) => a.date.localeCompare(b.date) || mealOrder(a.meal) - mealOrder(b.meal));
  
  function mealOrder(meal) {
    return meal === 'æ—©é¤' ? 0 : meal === 'åˆé¤' ? 1 : 2;
  }
  
  if (!rows.length) {
    document.querySelector('.chartWrap').innerHTML = '<div style="text-align:center;color:#666;padding:2rem">æ²’æœ‰è¶³å¤ çš„è¡€ç³–æ•¸æ“šä¾†ç”Ÿæˆåœ–è¡¨</div>';
    return;
  }
  
  // éŠ·æ¯€èˆŠåœ–è¡¨
  if (chart) chart.destroy();
  
  // å»ºç«‹æ–°åœ–è¡¨å®¹å™¨
  document.querySelector('.chartWrap').innerHTML = '<canvas id="sugarChart"></canvas>';
  
  // å®šç¾©æ­£å¸¸ç¯„åœ
  const normalRange = {
    breakfast: { min: 4.0, max: 7.0 },
    lunch: { min: 4.0, max: 10.0 },
    dinner: { min: 4.0, max: 10.0 }
  };
  
  // å‰µå»ºåœ–è¡¨
  chart = new Chart($('sugarChart'), {
    type: 'line',
    data: {
      labels: rows.map(r => formatDate(r.date).substring(5) + ' ' + r.meal),
      datasets: [
        {
          label: 'è¡€ç³– (mmol/L)',
          data: rows.map(r => r.sugarMmol),
          borderColor: '#d32f2f',
          backgroundColor: 'rgba(211, 47, 47, 0.2)',
          tension: 0.3,
          pointRadius: 5,
          pointBackgroundColor: '#d32f2f',
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.raw;
              let meal = rows[context.dataIndex].meal;
              let range = meal === 'æ—©é¤' ? normalRange.breakfast :
                          meal === 'åˆé¤' ? normalRange.lunch : normalRange.dinner;
              
              let status = value < range.min ? 'åä½' : 
                          value > range.max ? 'åé«˜' : 'æ­£å¸¸';
              
              return [`è¡€ç³–å€¼: ${value} mmol/L`, `ç‹€æ…‹: ${status}`];
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          min: 3,
          max: Math.max(15, ...rows.map(r => r.sugarMmol)) + 1,
          title: {
            display: true,
            text: 'è¡€ç³–å€¼ (mmol/L)'
          }
        }
      }
    }
  });
}
</script>
</body>
</html>
