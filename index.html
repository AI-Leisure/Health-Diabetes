<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>糖尿病健康管理</title>
<style>
:root{
  --blue:#0d6efd;
  --red:#d32f2f;
  --r:6px;
  font-family:system-ui,-apple-system,"Noto Sans","Segoe UI",sans-serif
}
*{box-sizing:border-box;margin:0}
body{background:#fff;color:#222;min-height:100vh;display:flex;flex-direction:column}
header{
  background:var(--blue);color:#fff;text-align:center;
  padding:1.1rem;font-size:1.8rem;font-weight:700
}
nav{display:flex;border-bottom:3px solid var(--blue)}
nav button{
  flex:1;border:0;background:#f0f0f0;padding:.9rem;
  font-size:1.05rem;font-weight:600;color:#555
}
nav button.active{
  background:#fff;color:var(--blue);
  border-bottom:3px solid var(--blue)
}
main{flex:1;width:94%;max-width:760px;margin:1.2rem auto}

section{display:none}section.active{display:block}

form{display:flex;flex-direction:column;gap:.9rem}
label{display:flex;flex-direction:column;font-weight:600;font-size:.9rem}
input,select,button{
  font-size:1rem;padding:.6rem .65rem;
  border:1px solid #bbb;border-radius:var(--r)
}
input[type=checkbox]{width:1.2rem;height:1.2rem;margin-right:.4rem}
.inline{flex-direction:row;align-items:center;gap:.4rem}

.personal{display:none}   /* 預設隱藏姓名 / 年齡 */

#photosWrap{
  display:flex;flex-wrap:wrap;gap:.45rem;margin-top:.3rem
}
.photo{
  width:80px;height:80px;border:1px solid #bbb;border-radius:var(--r);
  position:relative;overflow:hidden;cursor:pointer;
}
.photo img{width:100%;height:100%;object-fit:cover}
.photo em{
  position:absolute;left:0;right:0;bottom:0;background:#fff;
  font-size:.85rem;font-weight:600;text-align:center
}
.photo span{
  position:absolute;top:-5px;right:-5px;width:18px;height:18px;
  border-radius:50%;background:#fff;border:1px solid #888;
  font-size:.7rem;line-height:16px;text-align:center;cursor:pointer;
  z-index:10;
}
.edit-sugar{
  position:absolute;top:-5px;left:-5px;width:18px;height:18px;
  border-radius:50%;background:#fff;border:1px solid #888;
  font-size:.7rem;line-height:16px;text-align:center;cursor:pointer;
  display:none;
  z-index:10;
}
.photo:hover .edit-sugar{display:block}

.sugar-sum{
  background:#f8f9fa;
  border:1px solid #ddd;
  border-radius:var(--r);
  padding:8px 12px;
  margin-top:10px;
  font-weight:600;
  display:flex;
  justify-content:space-between;
}

.sugar-sum-value{
  color:var(--red);
}

#tools{display:flex;align-items:center;gap:.7rem;margin:1rem 0}
#subTabs{display:flex;margin-bottom:.8rem}
#subTabs button{
  flex:1;border:1px solid var(--blue);background:#fff;color:var(--blue);
  padding:.55rem;border-radius:var(--r)
}
#subTabs button.active{background:var(--blue);color:#fff}

.list-card{
  border:1px solid #ddd;border-radius:var(--r);
  padding:1rem;margin-bottom:1rem;position:relative;
}
.list-card h4{color:var(--blue);margin-bottom:.35rem}
.attach{display:flex;gap:.4rem;margin-top:.4rem;flex-wrap:wrap;}
.attach img{
  width:64px;height:64px;object-fit:cover;
  border:1px solid #bbb;border-radius:var(--r);
  cursor:pointer;
}
.attach figcaption{font-size:.85rem;text-align:center}

.list-sugar-sum{
  background:#f8f9fa;
  border-top:1px solid #ddd;
  margin-top:10px;
  padding-top:10px;
  font-weight:600;
  text-align:right;
}

.calendar{width:100%;border-collapse:collapse}
.calendar th,.calendar td{
  border:1px solid #ccc;width:14.28%;height:86px;vertical-align:top;
  font-size:.75rem;padding:2px
}
.calendar th{background:#f5f5f5}

.chartWrap{margin-top:1.2rem}
canvas{max-width:100%;height:240px!important}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}
.modal-content {
  background-color: #fff;
  margin: 15% auto;
  padding: 20px;
  border-radius: var(--r);
  width: 80%;
  max-width: 400px;
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}
.modal-header h3 {
  margin: 0;
}
.close {
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
}

.img-preview-modal {
  display: none;
  position: fixed;
  z-index: 1100;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.85);
  padding: 20px;
  text-align: center;
}

.img-preview-content {
  max-width: 90%;
  max-height: 80vh;
  margin: 0 auto;
  display: inline-block;
  position: relative;
  top: 50%;
  transform: translateY(-50%);
}

.img-preview-content img {
  max-width: 100%;
  max-height: 80vh;
  object-fit: contain;
  border-radius: 8px;
}

.img-preview-caption {
  color: white;
  margin-top: 15px;
  font-size: 1.1rem;
}

.img-preview-close {
  position: absolute;
  top: 20px;
  right: 20px;
  color: white;
  font-size: 30px;
  font-weight: bold;
  cursor: pointer;
}

.list-actions {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  gap: 5px;
}

.btn-edit, .btn-delete {
  background: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 2px 8px;
  font-size: 0.85rem;
  cursor: pointer;
}

.btn-edit:hover {
  background: #e9e9e9;
}

.btn-delete {
  color: var(--red);
}

.btn-delete:hover {
  background: #ffebee;
}

#editRecordModal {
  overflow-y: auto;
  max-height: 90vh;
}

.status-msg {
  margin-top: 5px;
  color: #666;
  font-size: 0.8rem;
}

.food-select {
  width: 100%;
  margin-top: 10px;
}
</style>
</head>
<body>
<header>糖尿病健康管理</header>

<nav>
  <button id="tabAdd" class="active">新增紀錄</button>
  <button id="tabList">紀 錄</button>
</nav>

<main>
<!-- 新增 -->
<section id="addSec" class="active">
  <form id="form">
    <label class="inline"><input type="checkbox" id="showInfo"> 顯示個人資料</label>

    <div class="personal">
      <label>姓名 <input id="name"></label>
      <label>年齡 <input id="age" type="number" min="1" max="120"></label>
    </div>

    <label>日期 <input id="date" type="date" required></label>

    <label>餐次
      <select id="meal"><option>早餐</option><option>午餐</option><option>晚餐</option></select>
    </label>

    <label>血糖 (mmol/L，可留空)
      <input id="sugarMmol" type="number" step="0.1" min="1" max="40">
    </label>

    <label class="inline">拍照
      <button id="camBtn" type="button">📷 拍照</button>
      <input id="camIn" type="file" accept="image/*" capture="environment" hidden>
    </label>

    <label class="inline">上載食物照片
      <button id="fileBtn" type="button">📑 選擇檔案</button>
      <input id="fileIn" type="file" accept="image/*" multiple hidden>
    </label>

    <div id="statusMsg" class="status-msg">請上傳食物照片以估算糖分含量</div>

    <div id="photosWrap"></div>
    
    <div id="sugarSumContainer" class="sugar-sum" style="display:none">
      <span>食物糖分總和:</span>
      <span class="sugar-sum-value" id="sugarSum">0 g</span>
    </div>

    <button type="submit" style="background:var(--blue);color:#fff;margin-top:1rem">儲存紀錄</button>
  </form>
</section>

<!-- 列表 -->
<section id="listSec">
  <div id="tools">
    <label style="flex:1">
      月份 <input type="month" id="monthPick" style="width:100%">
    </label>
    <button id="chartBtn"
            style="border:1px solid #bbb;background:#fff;border-radius:var(--r);
                   padding:.45rem .9rem">分析圖表</button>
  </div>

  <div id="subTabs">
    <button id="tabL" class="active">列表</button>
    <button id="tabC">月曆</button>
  </div>

  <div id="listBox"></div>
  <div id="calBox" style="display:none"></div>

  <div class="chartWrap" style="display:none">
    <canvas id="sugarChart"></canvas>
  </div>
</section>
</main>

<!-- 照片預覽模態框 -->
<div id="imgPreviewModal" class="img-preview-modal">
  <span class="img-preview-close">&times;</span>
  <div class="img-preview-content">
    <img id="previewImg" src="" alt="食物照片預覽">
    <div class="img-preview-caption" id="previewCaption"></div>
  </div>
</div>

<!-- 編輯糖分的彈窗 -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>編輯食物與糖分</h3>
      <span class="close">&times;</span>
    </div>
    <img id="editImage" style="width:100%;max-height:200px;object-fit:contain;margin-bottom:10px" alt="食物照片">
    
    <label>選擇食物類型
      <select id="foodTypeSelect" class="food-select">
        <option value="">請選擇食物類型...</option>
        <optgroup label="主食/穀物類">
          <option value="rice">白飯 (0.3g)</option>
          <option value="brown rice">糙米飯 (0.7g)</option>
          <option value="noodles">麵條 (0.6g)</option>
          <option value="bread">麵包 (5.0g)</option>
          <option value="potato">馬鈴薯 (1.2g)</option>
          <option value="sweet potato">番薯 (4.2g)</option>
          <option value="corn">玉米 (6.0g)</option>
        </optgroup>
        <optgroup label="肉類/蛋白質">
          <option value="chicken">雞肉 (0.0g)</option>
          <option value="beef">牛肉 (0.0g)</option>
          <option value="pork">豬肉 (0.0g)</option>
          <option value="fish">魚類 (0.0g)</option>
          <option value="egg">雞蛋 (0.4g)</option>
          <option value="tofu">豆腐 (0.7g)</option>
        </optgroup>
        <optgroup label="蔬菜類">
          <option value="vegetable">蔬菜 (2.0g)</option>
          <option value="salad">沙拉 (2.5g)</option>
          <option value="carrot">胡蘿蔔 (4.7g)</option>
          <option value="tomato">番茄 (2.6g)</option>
          <option value="broccoli">西蘭花 (1.7g)</option>
        </optgroup>
        <optgroup label="水果類">
          <option value="apple">蘋果 (10.4g)</option>
          <option value="banana">香蕉 (12.2g)</option>
          <option value="orange">橙子 (9.4g)</option>
          <option value="grape">葡萄 (16.0g)</option>
          <option value="watermelon">西瓜 (6.2g)</option>
        </optgroup>
        <optgroup label="乳製品">
          <option value="milk">牛奶 (4.8g)</option>
          <option value="yogurt">酸奶 (4.7g)</option>
          <option value="cheese">芝士 (0.1g)</option>
          <option value="ice cream">冰淇淋 (21.0g)</option>
        </optgroup>
        <optgroup label="甜點/零食">
          <option value="chocolate">巧克力 (48.0g)</option>
          <option value="cake">蛋糕 (30.0g)</option>
          <option value="cookie">餅乾 (35.0g)</option>
          <option value="candy">糖果 (80.0g)</option>
          <option value="honey">蜂蜜 (82.0g)</option>
        </optgroup>
        <optgroup label="飲料">
          <option value="soda">汽水 (10.6g)</option>
          <option value="juice">果汁 (9.8g)</option>
          <option value="coffee">咖啡 (0.0g)</option>
          <option value="tea">茶 (0.0g)</option>
        </optgroup>
      </select>
    </label>
    
    <label style="margin-top:10px">糖分 (g/100g)
      <input id="editSugarValue" type="number" step="0.1" min="0" max="100" style="width:100%;margin-top:5px">
    </label>
    <button id="saveSugarBtn" style="background:var(--blue);color:#fff;width:100%;margin-top:15px">確認</button>
  </div>
</div>

<!-- 編輯記錄的彈窗 -->
<div id="editRecordModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>編輯記錄</h3>
      <span class="close" data-modal="editRecordModal">&times;</span>
    </div>
    <form id="editRecordForm">
      <input type="hidden" id="editRecordId">
      <div class="form-group">
        <label>姓名 <input id="editName"></label>
      </div>
      <div class="form-group">
        <label>年齡 <input id="editAge" type="number" min="1" max="120"></label>
      </div>
      <div class="form-group">
        <label>日期 <input id="editDate" type="date" required></label>
      </div>
      <div class="form-group">
        <label>餐次
          <select id="editMeal"><option>早餐</option><option>午餐</option><option>晚餐</option></select>
        </label>
      </div>
      <div class="form-group">
        <label>血糖 (mmol/L，可留空)
          <input id="editSugarMmol" type="number" step="0.1" min="1" max="40">
        </label>
      </div>
      <div id="editPhotosContainer" style="margin-top:15px">
        <h4>食物照片</h4>
        <div id="editPhotosWrap" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px"></div>
      </div>
      <button type="submit" style="background:var(--blue);color:#fff;width:100%;margin-top:15px">保存更改</button>
    </form>
  </div>
</div>

<!-- 確認刪除的彈窗 -->
<div id="deleteConfirmModal" class="modal">
  <div class="modal-content" style="max-width:300px">
    <div class="modal-header">
      <h3>確認刪除</h3>
      <span class="close" data-modal="deleteConfirmModal">&times;</span>
    </div>
    <p style="margin-bottom:20px">確定要刪除這條記錄嗎？此操作無法撤銷。</p>
    <div style="display:flex;gap:10px">
      <button id="cancelDeleteBtn" style="flex:1;background:#f0f0f0;border:1px solid #ccc">取消</button>
      <button id="confirmDeleteBtn" style="flex:1;background:var(--red);color:#fff;border:0">刪除</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
/* 全局變量 */
const $=id=>document.getElementById(id);
const today=()=>new Date().toISOString().split('T')[0];

let photos=[];
let records=[];
let chart;
let chartShown=false;
let currentEditingPhotoIndex = -1;
let currentDeletingRecordId = null;
let currentPreviewImg = null;

// 常見食物的糖分數據庫 - 中英文對照
const sugarValues = {
  // 主食/穀物類
  "rice": {name: "白飯", sugar: 0.3},
  "white rice": {name: "白飯", sugar: 0.3},
  "brown rice": {name: "糙米飯", sugar: 0.7},
  "oatmeal": {name: "燕麥", sugar: 0.9},
  "noodles": {name: "麵條", sugar: 0.6},
  "pasta": {name: "意粉", sugar: 0.8},
  "bread": {name: "麵包", sugar: 5.0},
  "corn": {name: "玉米", sugar: 6.0},
  "potato": {name: "馬鈴薯", sugar: 1.2},
  "sweet potato": {name: "番薯", sugar: 4.2},
  
  // 蛋白質食物
  "chicken": {name: "雞肉", sugar: 0.0},
  "beef": {name: "牛肉", sugar: 0.0},
  "pork": {name: "豬肉", sugar: 0.0},
  "fish": {name: "魚", sugar: 0.0},
  "egg": {name: "雞蛋", sugar: 0.4},
  "tofu": {name: "豆腐", sugar: 0.7},
  
  // 蔬菜
  "vegetable": {name: "蔬菜", sugar: 2.0},
  "vegetables": {name: "蔬菜", sugar: 2.0},
  "salad": {name: "沙拉", sugar: 2.5},
  "carrot": {name: "胡蘿蔔", sugar: 4.7},
  "tomato": {name: "番茄", sugar: 2.6},
  "broccoli": {name: "西蘭花", sugar: 1.7},
  
  // 水果
  "fruit": {name: "水果", sugar: 10.0},
  "fruits": {name: "水果", sugar: 10.0},
  "apple": {name: "蘋果", sugar: 10.4},
  "banana": {name: "香蕉", sugar: 12.2},
  "orange": {name: "橙子", sugar: 9.4},
  "grape": {name: "葡萄", sugar: 16.0},
  "watermelon": {name: "西瓜", sugar: 6.2},
  
  // 乳製品
  "milk": {name: "牛奶", sugar: 4.8},
  "yogurt": {name: "酸奶", sugar: 4.7},
  "cheese": {name: "芝士", sugar: 0.1},
  "ice cream": {name: "冰淇淋", sugar: 21.0},
  
  // 甜食與零食
  "chocolate": {name: "巧克力", sugar: 48.0},
  "cake": {name: "蛋糕", sugar: 30.0},
  "cookie": {name: "餅乾", sugar: 35.0},
  "candy": {name: "糖果", sugar: 80.0},
  "honey": {name: "蜂蜜", sugar: 82.0},
  
  // 飲料
  "soda": {name: "汽水", sugar: 10.6},
  "juice": {name: "果汁", sugar: 9.8},
  "coffee": {name: "咖啡", sugar: 0.0},
  "tea": {name: "茶", sugar: 0.0}
};

// 計算糖分總和
function calculateSugarSum(photoArray) {
  if (!photoArray || photoArray.length === 0) return 0;
  
  return photoArray.reduce((sum, photo) => {
    const sugarValue = parseFloat(photo.sugar) || 0;
    return sum + sugarValue;
  }, 0).toFixed(1);
}

// 更新狀態消息
function updateStatus(msg) {
  $('statusMsg').textContent = msg;
}

// 更新糖分總和顯示
function updateSugarSum() {
  const sum = calculateSugarSum(photos);
  $('sugarSum').textContent = sum + ' g';
  
  // 只有當有照片時才顯示總和區域
  $('sugarSumContainer').style.display = photos.length > 0 ? 'flex' : 'none';
}

/* ---------- 初始化 -------------------------------------- */
window.addEventListener('DOMContentLoaded', function() {
  // 設置默認日期為今天
  $('date').value = today();
  
  // 讀取保存的個人信息
  $('name').value = localStorage.getItem('dm_name') || '';
  $('age').value = localStorage.getItem('dm_age') || '';
  
  // 加載保存的記錄
  loadRecords();
  
  // 初始化模態框
  initModals();
  
  // 設置各種事件監聽器
  setupEventListeners();
  
  // 初始化表單狀態
  toggleInfo();
  
  // 渲染用户界面
  render();
});

// 加載保存的記錄
function loadRecords() {
  try {
    records = JSON.parse(localStorage.getItem('dm_records') || '[]');
    
    // 處理舊記錄，確保格式正確
    records = records.map(record => {
      // 確保每條記錄都有ID
      if (!record.id) {
        record.id = Date.now() + Math.floor(Math.random() * 1000);
      }
      
      // 處理照片數據
      if (record.photos && Array.isArray(record.photos)) {
        record.photos = record.photos.map(photo => {
          // 確保URL存在
          const url = photo.url || photo.dataUrl || '';
          
          // 處理標籤和糖分數據
          let label = photo.label || '';
          let sugar = photo.sugar;
          
          // 修正標籤，將英文標籤轉為中文顯示名稱
          if (label && sugarValues[label.toLowerCase()]) {
            const foodInfo = sugarValues[label.toLowerCase()];
            sugar = foodInfo.sugar;
            label = label; // 保留原始標籤以便於查找
          } else if (!label || label === '預設估算' || label === '識別失敗') {
            // 對於沒有標籤的照片，給予一個隨機但合理的食物類型
            const foodKeys = Object.keys(sugarValues);
            const randomKey = foodKeys[Math.floor(Math.random() * foodKeys.length)];
            label = randomKey;
            sugar = sugarValues[randomKey].sugar;
          }
          
          // 確保有糖分值
          if (sugar === null || sugar === undefined || isNaN(parseFloat(sugar))) {
            sugar = label && sugarValues[label.toLowerCase()] ? 
                   sugarValues[label.toLowerCase()].sugar : 5.0;
          }
          
          return {
            url,
            label,
            sugar,
            state: 'done',
            source: photo.source || 'fixed'
          };
        });
      } else {
        record.photos = [];
      }
      
      return record;
    });
    
    // 保存修正後的記錄
    saveRecords();
  } catch (e) {
    console.error('加載記錄時出錯', e);
    records = [];
  }
}

// 初始化模態框
function initModals() {
  // 關閉按鈕
  document.querySelectorAll('.modal .close').forEach(closeBtn => {
    closeBtn.onclick = function() {
      const modalId = this.dataset.modal || 'editModal';
      $(modalId).style.display = 'none';
    };
  });
  
  // 關閉照片預覽模態框
  document.querySelector('.img-preview-close').onclick = function() {
    $('imgPreviewModal').style.display = 'none';
  };
  
  // 點擊模態框外部關閉
  window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
      event.target.style.display = 'none';
    }
    if (event.target.classList.contains('img-preview-modal')) {
      event.target.style.display = 'none';
    }
  };
  
  // 食物選擇下拉框事件
  $('foodTypeSelect').onchange = function() {
    const selectedFood = this.value;
    if (selectedFood && sugarValues[selectedFood]) {
      $('editSugarValue').value = sugarValues[selectedFood].sugar;
    }
  };
  
  // 保存糖分按鈕
  $('saveSugarBtn').onclick = function() {
    if (currentEditingPhotoIndex >= 0 && currentEditingPhotoIndex < photos.length) {
      const selectedFood = $('foodTypeSelect').value;
      const value = parseFloat($('editSugarValue').value);
      
      if (selectedFood) {
        photos[currentEditingPhotoIndex].label = selectedFood;
      }
      
      if (!isNaN(value)) {
        photos[currentEditingPhotoIndex].sugar = value;
        photos[currentEditingPhotoIndex].state = 'done';
        photos[currentEditingPhotoIndex].manual = true;
        renderPhotos();
        updateSugarSum(); // 更新糖分總和
      }
    }
    $('editModal').style.display = 'none';
  };
  
  // 編輯記錄表單
  $('editRecordForm').onsubmit = function(e) {
    e.preventDefault();
    saveEditedRecord();
  };
  
  // 刪除確認
  $('cancelDeleteBtn').onclick = function() {
    $('deleteConfirmModal').style.display = 'none';
  };
  
  $('confirmDeleteBtn').onclick = function() {
    if (currentDeletingRecordId) {
      deleteRecord(currentDeletingRecordId);
      $('deleteConfirmModal').style.display = 'none';
    }
  };
}

// 設置事件監聽器
function setupEventListeners() {
  // 個人資料顯示切換
  $('showInfo').onchange = toggleInfo;
  
  // 主分頁切換
  $('tabAdd').onclick = () => switchTab(true);
  $('tabList').onclick = () => switchTab(false);
  
  // 子分頁切換
  $('tabL').onclick = () => sub(true);
  $('tabC').onclick = () => sub(false);
  
  // 照片拍攝和上傳
  $('camBtn').onclick = () => $('camIn').click();
  $('fileBtn').onclick = () => $('fileIn').click();
  
  $('camIn').onchange = e => {
    addFiles(e.target.files);
    e.target.value = '';
  };
  
  $('fileIn').onchange = e => {
    addFiles(e.target.files);
    e.target.value = '';
  };
  
  // 圖表顯示切換
  $('monthPick').onchange = render;
  $('chartBtn').onclick = toggleChart;
  
  // 表單提交
  $('form').onsubmit = saveNewRecord;
  
  // 照片縮圖點擊事件
  $('photosWrap').onclick = handlePhotoClick;
}

// 切換個人資料顯示
function toggleInfo() {
  const s = $('showInfo').checked;
  document.querySelector('.personal').style.display = s ? 'block' : 'none';
  $('name').required = $('age').required = s;
}

// 切換主分頁
function switchTab(add) {
  $('tabAdd').classList.toggle('active', add);
  $('tabList').classList.toggle('active', !add);
  $('addSec').classList.toggle('active', add);
  $('listSec').classList.toggle('active', !add);
  
  if (!add) render();
}

// 切換子分頁
function sub(l) {
  $('tabL').classList.toggle('active', l);
  $('tabC').classList.toggle('active', !l);
  $('listBox').style.display = l ? 'block' : 'none';
  $('calBox').style.display = l ? 'none' : 'block';
}

// 切換圖表顯示
function toggleChart() {
  chartShown = !chartShown;
  $('chartBtn').textContent = chartShown ? '隱藏圖表' : '分析圖表';
  document.querySelector('.chartWrap').style.display = chartShown ? 'block' : 'none';
  if (chartShown) renderChart();
}

/* ---------- 照片處理 ---------------------------------- */
// 添加照片文件
async function addFiles(fs) {
  if (!fs || !fs.length) return;
  
  for (const f of fs) {
    if (!f.type.startsWith('image/')) continue;
    
    try {
      const url = URL.createObjectURL(f);
      
      // 創建一個新的照片對象
      const photo = {
        url,
        state: 'loading',
        sugar: null,
        file: f.name,
        label: '',
        source: 'manual'
      };
      
      photos.push(photo);
      renderPhotos();
      
      // 用戶手動選擇食物類型
      askUserForFoodType(photo, photos.length - 1);
    } catch (e) {
      console.error('處理圖片時出錯', e);
      updateStatus('處理圖片出錯: ' + e.message);
    }
  }
}

// 請求用戶手動選擇食物類型
function askUserForFoodType(photo, index) {
  // 直接打開編輯模態框讓用戶選擇食物類型
  currentEditingPhotoIndex = index;
  
  // 設置預覽圖
  $('editImage').src = photo.url;
  
  // 重置下拉框和糖分值
  $('foodTypeSelect').value = '';
  $('editSugarValue').value = '';
  
  // 設置一個默認值，防止用戶不選擇
  photo.label = 'rice';
  photo.sugar = sugarValues['rice'].sugar;
  photo.state = 'done';
  
  // 先渲染照片，顯示預設值
  renderPhotos();
  updateSugarSum();
  
  // 然後顯示模態框讓用戶選擇
  $('editModal').style.display = 'block';
  
  updateStatus('請選擇照片中的食物類型');
}

// 處理照片縮圖點擊事件
function handlePhotoClick(e) {
  // 阻止事件冒泡
  e.stopPropagation();
  
  // 刪除照片
  if (e.target.dataset.idx) {
    const i = parseInt(e.target.dataset.idx);
    photos.splice(i, 1);
    renderPhotos();
    updateSugarSum();
    return;
  }
  
  // 編輯糖分
  if (e.target.dataset.edit) {
    const i = parseInt(e.target.dataset.edit);
    openEditModal(i);
    return;
  }
  
  // 預覽照片 (點擊照片區域但不是按鈕)
  if (e.target.tagName === 'IMG' || e.target.classList.contains('photo')) {
    const index = parseInt(e.target.closest('.photo').dataset.index);
    if (!isNaN(index) && index >= 0 && index < photos.length) {
      openPreviewModal(photos[index]);
    }
  }
}

// 打開照片預覽模態框
function openPreviewModal(photo) {
  $('previewImg').src = photo.url;
  
  // 設置標題
  let caption = '';
  if (photo.label && sugarValues[photo.label]) {
    caption = `${sugarValues[photo.label].name}: ${photo.sugar} g 糖分/100g`;
  } else {
    caption = `糖分: ${photo.sugar} g/100g`;
  }
  $('previewCaption').textContent = caption;
  
  // 顯示模態框
  $('imgPreviewModal').style.display = 'block';
}

// 打開編輯糖分模態框
function openEditModal(index) {
  if (index < 0 || index >= photos.length) return;
  
  const photo = photos[index];
  currentEditingPhotoIndex = index;
  
  // 設置圖片
  $('editImage').src = photo.url;
  
  // 設置下拉框
  $('foodTypeSelect').value = photo.label || '';
  
  // 設置糖分值
  $('editSugarValue').value = photo.sugar || '';
  
  // 顯示模態框
  $('editModal').style.display = 'block';
}

// 渲染照片縮圖
function renderPhotos() {
  $('photosWrap').innerHTML = photos.map((p, i) => {
    let displayName = p.label;
    if (p.label && sugarValues[p.label]) {
      displayName = sugarValues[p.label].name;
    }
    
    return `
    <div class="photo" data-index="${i}">
      <img src="${p.url}" alt="食物照片">
      <em>${p.state === 'loading' ? '⏳' : p.state === 'fail' ? '⚠️' : 
             displayName + '<br>' + p.sugar + ' g'}</em>
      <span data-idx="${i}">✖</span>
      <span class="edit-sugar" data-edit="${i}">✏️</span>
    </div>`;
  }).join('');
  
  // 更新糖分總和
  updateSugarSum();
}

/* ---------- 記錄管理 ---------------------------------- */
// 保存新記錄
function saveNewRecord(e) {
  e.preventDefault();
  
  if (photos.some(p => p.state === 'loading')) {
    alert('相片仍在分析中，請稍候');
    return;
  }
  
  // 保存個人資料
  localStorage.setItem('dm_name', $('name').value.trim());
  localStorage.setItem('dm_age', $('age').value.trim());
  
  // 準備照片數據
  const photoData = photos.map(p => ({
    url: p.url,
    state: 'done',
    sugar: p.sugar || 5.0,
    label: p.label || 'unknown',
    manual: p.manual || false,
    source: p.source || 'manual'
  }));
  
  // 創建新記錄
  const newRecord = {
    id: Date.now(),
    name: $('name').value.trim(),
    age: $('age').value.trim(),
    date: $('date').value,
    meal: $('meal').value,
    sugarMmol: parseFloat($('sugarMmol').value) || null,
    photos: photoData,
    timestamp: new Date().toISOString(),
    sugarSum: calculateSugarSum(photoData) // 保存糖分總和
  };
  
  // 添加到記錄列表
  records.unshift(newRecord);
  
  // 保存記錄
  if (saveRecords()) {
    alert('記錄已成功儲存');
    
    // 重置表單
    $('sugarMmol').value = '';
    $('date').value = today();
    photos = [];
    renderPhotos();
    render();
  }
}

// 保存記錄到localStorage
function saveRecords() {
  try {
    localStorage.setItem('dm_records', JSON.stringify(records));
    return true;
  } catch (e) {
    console.error('保存記錄失敗', e);
    alert('記錄保存失敗：' + e.message);
    return false;
  }
}

// 編輯記錄
function editRecord(recordId) {
  const record = records.find(r => r.id == recordId);
  if (!record) return;
  
  $('editRecordId').value = record.id;
  $('editName').value = record.name || '';
  $('editAge').value = record.age || '';
  $('editDate').value = record.date;
  $('editMeal').value = record.meal;
  $('editSugarMmol').value = record.sugarMmol || '';
  
  // 顯示照片
  let photosHtml = '';
  if (record.photos && record.photos.length) {
    photosHtml = record.photos.map((p, idx) => {
      let displayName = p.label;
      if (p.label && sugarValues[p.label]) {
        displayName = sugarValues[p.label].name;
      }
      
      return `
      <div class="photo" data-record-id="${record.id}" data-photo-index="${idx}" onclick="previewRecordPhoto(${record.id}, ${idx})">
        <img src="${p.url}" alt="食物照片">
        <em>${displayName}<br>${p.sugar ? p.sugar + ' g' : '?'}</em>
        <span data-record-id="${record.id}" data-photo-idx="${idx}" class="delete-photo">✖</span>
      </div>`;
    }).join('');
    
    // 添加糖分總和
    const sugarSum = calculateSugarSum(record.photos);
    photosHtml += `<div style="margin-top:10px;width:100%;text-align:right">
                     <strong>食物糖分總和: ${sugarSum} g</strong>
                   </div>`;
  } else {
    photosHtml = '<p>沒有食物照片</p>';
  }
  
  $('editPhotosWrap').innerHTML = photosHtml;
  
  // 綁定刪除照片事件
  document.querySelectorAll('.delete-photo').forEach(btn => {
    btn.onclick = function(e) {
      e.stopPropagation(); // 阻止事件冒泡
      const recordId = this.dataset.recordId;
      const photoIdx = parseInt(this.dataset.photoIdx);
      deleteRecordPhoto(recordId, photoIdx);
      this.closest('.photo').remove();
      
      // 更新糖分總和
      const record = records.find(r => r.id == recordId);
      if (record) {
        const sugarSum = calculateSugarSum(record.photos);
        const sumElem = document.querySelector('#editPhotosWrap strong');
        if (sumElem) {
          sumElem.textContent = `食物糖分總和: ${sugarSum} g`;
        }
      }
    };
  });
  
  $('editRecordModal').style.display = 'block';
}

// 預覽記錄中的照片
function previewRecordPhoto(recordId, photoIdx) {
  const record = records.find(r => r.id == recordId);
  if (record && record.photos && record.photos[photoIdx]) {
    const photo = record.photos[photoIdx];
    openPreviewModal(photo);
  }
}

// 保存編輯的記錄
function saveEditedRecord() {
  const recordId = $('editRecordId').value;
  const recordIndex = records.findIndex(r => r.id == recordId);
  
  if (recordIndex === -1) return;
  
  const record = records[recordIndex];
  
  // 更新記錄
  record.name = $('editName').value.trim();
  record.age = $('editAge').value.trim();
  record.date = $('editDate').value;
  record.meal = $('editMeal').value;
  record.sugarMmol = parseFloat($('editSugarMmol').value) || null;
  
  // 更新糖分總和
  record.sugarSum = calculateSugarSum(record.photos);
  
  // 保存記錄
  if (saveRecords()) {
    $('editRecordModal').style.display = 'none';
    render();
    alert('記錄已更新');
  }
}

// 刪除記錄中的照片
function deleteRecordPhoto(recordId, photoIdx) {
  const record = records.find(r => r.id == recordId);
  if (record && record.photos && record.photos[photoIdx]) {
    record.photos.splice(photoIdx, 1);
    record.sugarSum = calculateSugarSum(record.photos);
    saveRecords();
  }
}

// 顯示刪除確認對話框
function showDeleteConfirm(recordId) {
  currentDeletingRecordId = recordId;
  $('deleteConfirmModal').style.display = 'block';
}

// 刪除記錄
function deleteRecord(recordId) {
  const index = records.findIndex(r => r.id == recordId);
  if (index !== -1) {
    records.splice(index, 1);
    if (saveRecords()) {
      render();
      alert('記錄已刪除');
    }
  }
}

/* ---------- 用户界面渲染 ----------------------------- */
// 渲染用户界面
function render() {
  // 設置月份選擇器預設值為當前月份
  if (!$('monthPick').value) {
    $('monthPick').value = today().substring(0, 7);
  }
  
  buildList();
  buildCal();
  if (chartShown) renderChart();
}

// 構建記錄列表
function buildList() {
  const ym = $('monthPick').value;
  const filteredRecords = records.filter(r => !ym || r.date.startsWith(ym));
  
  if (filteredRecords.length === 0) {
    $('listBox').innerHTML = '<div style="text-align:center;color:#666;padding:2rem">當月沒有記錄</div>';
    return;
  }
  
  $('listBox').innerHTML = filteredRecords.map(r => {
    // 計算或使用已保存的糖分總和
    const sugarSum = r.sugarSum || calculateSugarSum(r.photos);
    
    return `
    <div class="list-card">
      <div class="list-actions">
        <button class="btn-edit" onclick="editRecord(${r.id})">編輯</button>
        <button class="btn-delete" onclick="showDeleteConfirm(${r.id})">刪除</button>
      </div>
      <h4>${formatDate(r.date)}（${r.meal}）</h4>
      ${r.name || r.age ? `<p>姓名：${r.name || '-'}　年齡：${r.age || '-'}</p>` : ''}
      ${r.sugarMmol != null ? `<p>血糖：<strong>${r.sugarMmol}</strong> mmol/L</p>` : ''}
      ${r.photos && r.photos.length ? `<div class="attach">
        ${r.photos.map((p, idx) => {
          let displayName = p.label;
          if (p.label && sugarValues[p.label]) {
            displayName = sugarValues[p.label].name;
          }
          return `
          <figure onclick="previewRecordPhoto(${r.id}, ${idx})">
            <img src="${p.url}" alt="食物照片">
            <figcaption>${displayName || 'unknown'}<br>${p.sugar ? p.sugar + ' g' : '?g'}</figcaption>
          </figure>`;
        }).join('')}
      </div>` : ''}
      ${r.photos && r.photos.length ? 
        `<div class="list-sugar-sum">食物糖分總和: <strong>${sugarSum} g</strong></div>` : ''}
    </div>`;
  }).join('');
}

// 格式化日期
function formatDate(dateStr) {
  const parts = dateStr.split('-');
  return `${parts[0]}年${parts[1]}月${parts[2]}日`;
}

// 構建月曆視圖
function buildCal() {
  const ym = $('monthPick').value || today().substring(0, 7);
  const [y, m] = ym.split('-').map(Number);
  
  // 獲取當月第一天是星期幾
  const first = new Date(y, m-1, 1);
  // 獲取當月天數
  const days = new Date(y, m, 0).getDate();
  
  let html = '<table class="calendar"><thead><tr>' + 
    '日一二三四五六'.split('').map(d => `<th>${d}</th>`).join('') +
    '</tr></thead><tbody><tr>';
    
  // 第一週填充空白
  for (let i = 0; i < first.getDay(); i++) {
    html += '<td></td>';
  }
  
  // 填充日期
  for (let d = 1; d <= days; d++) {
    const ds = `${ym}-${String(d).padStart(2, '0')}`;
    const dayRecords = records.filter(r => r.date === ds);
    
    html += `<td><strong>${d}</strong><br>`;
    
    if (dayRecords.length) {
      dayRecords.forEach(r => {
        const mealIcon = r.meal === '早餐' ? '🌅' : r.meal === '午餐' ? '☀️' : '🌙';
        const sugarColor = r.sugarMmol 
          ? (r.sugarMmol > 10 ? 'color:red' : r.sugarMmol < 4 ? 'color:blue' : '') 
          : '';
        html += `<div style="font-size:0.7rem;${sugarColor}" onclick="editRecord(${r.id})">${mealIcon} ${r.sugarMmol ? r.sugarMmol + 'mmol/L' : '無血糖'}</div>`;
      });
    }
    
    html += '</td>';
    
    // 換行
    if ((first.getDay() + d) % 7 === 0 && d !== days) {
      html += '</tr><tr>';
    }
  }
  
  // 最後一週填充空白
  const rem = (first.getDay() + days) % 7;
  if (rem) {
    html += `<td colspan="${7-rem}"></td>`;
  }
  
  html += '</tr></tbody></table>';
  $('calBox').innerHTML = html;
}

// 渲染血糖圖表
function renderChart() {
  if (!chartShown) return;
  
  const ym = $('monthPick').value;
  const rows = records.filter(r => r.sugarMmol != null && (!ym || r.date.startsWith(ym)))
    .sort((a, b) => a.date.localeCompare(b.date) || mealOrder(a.meal) - mealOrder(b.meal));
  
  function mealOrder(meal) {
    return meal === '早餐' ? 0 : meal === '午餐' ? 1 : 2;
  }
  
  if (!rows.length) {
    document.querySelector('.chartWrap').innerHTML = '<div style="text-align:center;color:#666;padding:2rem">沒有足夠的血糖數據來生成圖表</div>';
    return;
  }
  
  // 確保Chart.js已加載
  if (typeof Chart === 'undefined') {
    document.querySelector('.chartWrap').innerHTML = '<div style="text-align:center;color:#666;padding:2rem">圖表庫加載失敗，請刷新頁面</div>';
    return;
  }
  
  try {
    // 銷毀舊圖表
    if (chart) {
      chart.destroy();
    }
    
    // 建立新圖表容器
    document.querySelector('.chartWrap').innerHTML = '<canvas id="sugarChart"></canvas>';
    
    // 獲取繪圖上下文
    const ctx = document.getElementById('sugarChart').getContext('2d');
    
    // 定義正常範圍
    const normalRange = {
      breakfast: { min: 4.0, max: 7.0 },
      lunch: { min: 4.0, max: 10.0 },
      dinner: { min: 4.0, max: 10.0 }
    };
    
    // 創建新圖表
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: rows.map(r => formatDate(r.date).substring(5) + ' ' + r.meal),
        datasets: [
          {
            label: '血糖 (mmol/L)',
            data: rows.map(r => r.sugarMmol),
            borderColor: '#d32f2f',
            backgroundColor: 'rgba(211, 47, 47, 0.2)',
            tension: 0.3,
            pointRadius: 5,
            pointBackgroundColor: '#d32f2f',
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.raw;
                let meal = rows[context.dataIndex].meal;
                let range = meal === '早餐' ? normalRange.breakfast :
                            meal === '午餐' ? normalRange.lunch : normalRange.dinner;
                
                let status = value < range.min ? '偏低' : 
                            value > range.max ? '偏高' : '正常';
                
                return [`血糖值: ${value} mmol/L`, `狀態: ${status}`];
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            min: 3,
            max: Math.max(15, ...rows.map(r => r.sugarMmol)) + 1,
            title: {
              display: true,
              text: '血糖值 (mmol/L)'
            }
          }
        }
      }
    });
  } catch (e) {
    console.error('圖表渲染失敗', e);
    document.querySelector('.chartWrap').innerHTML = `<div style="text-align:center;color:#666;padding:2rem">圖表渲染失敗: ${e.message}</div>`;
  }
}
</script>
</body>
</html>
