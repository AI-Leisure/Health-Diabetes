<!DOCTYPE html>
<!-- =========================================================
  糖尿病健康管理  v1.0  (2024-06-14)
  -- 功能
     1. 自動填入今日日期
     2. 新增紀錄 / 紀錄 兩分頁
     3. 列表顯示所有紀錄（可隱藏個資）
     4. Chart.js 折線圖顯示血糖變化
  ========================================================= -->
<html lang="zh-Hant">

<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>糖尿病健康管理</title>

<!-- ===================  1. 版面樣式  =================== -->
<style>
/* ---------- 色彩、字型、圓角 ---------- */
:root{
  --c1:#1976d2;          /* 主色 */
  --c2:#d32f2f;          /* 圖表線 */
  --r :8px;              /* 圓角 */
  font-family:system-ui,-apple-system,"Noto Sans","Segoe UI",sans-serif;
}

/* ---------- 通用 ---------- */
*{box-sizing:border-box;margin:0}
body{
  background:#fafafa;
  color:#333;
  display:flex;
  flex-direction:column;
  min-height:100vh;
}

/* ---------- 頁首 ---------- */
header{
  background:var(--c1);
  color:#fff;
  padding:1rem;
  text-align:center;
}

/* ---------- 分頁按鈕 ---------- */
nav{display:flex}
nav button{
  flex:1;
  padding:.7rem;
  border:0;
  background:#eee;
  font-size:1rem;
}
nav button.active{
  color:var(--c1);
  background:#fff;
  font-weight:700;
  border-bottom:3px solid var(--c1);
}

/* ---------- 主區塊 ---------- */
main{
  flex:1;
  width:95%;
  max-width:840px;
  margin:1rem auto;
}

/* section 透過 JS .active 決定顯示與否 */
section{display:none}
section.active{display:block}

/* ---------- 表單 ---------- */
form{
  background:#fff;
  padding:1rem;
  border-radius:var(--r);
  box-shadow:0 2px 6px #0001;
  display:flex;
  flex-direction:column;
  gap:.75rem;
}
label{
  display:flex;
  flex-direction:column;
  font-weight:600;
  font-size:.9rem;
}
input,select,button{
  padding:.55rem .6rem;
  font-size:1rem;
  border:1px solid #ccc;
  border-radius:var(--r);
}
input[type="checkbox"]{
  width:1.2rem;
  height:1.2rem;
  margin-right:.45rem;
}
.toggle{
  display:flex;
  align-items:center;
  gap:.25rem;
}

/* ---------- 列表卡片 ---------- */
#listBox .card{
  background:#fff;
  padding:1rem;
  border-radius:var(--r);
  box-shadow:0 2px 4px #0001;
  margin-bottom:.85rem;
}
.card h4{margin-bottom:.5rem;color:var(--c1)}

/* ---------- 圖表 ---------- */
.chartWrap{margin-top:1.5rem}
canvas{max-width:100%}
</style>
</head>

<body>
<!-- ===================  2. 版面結構  =================== -->

<header><h1>糖尿病健康管理</h1></header>

<nav>
  <button id="tabForm" class="active">新增紀錄</button>
  <button id="tabList">紀&nbsp;錄</button>
</nav>

<main>
  <!-- === A. 新增紀錄 === -->
  <section id="formSec" class="active">
    <form id="recordForm">
      <!-- 可隱藏個資 -->
      <label class="toggle">
        <input type="checkbox" id="showInfo" checked> 顯示個資
      </label>

      <label>姓名
        <input id="name" required>
      </label>

      <label>年齡
        <input id="age" type="number" min="1" max="120" required>
      </label>

      <label>日期
        <input id="date" type="date" required>
      </label>

      <label>餐次
        <select id="meal">
          <option>早餐</option><option>午餐</option><option>晚餐</option>
        </select>
      </label>

      <label>血糖 (mmol/L，可留空)
        <input id="sugar" type="number" step="0.1" min="1">
      </label>

      <label>食物相片（僅上傳不做分析）
        <input id="photo" type="file" accept="image/*">
      </label>

      <button type="submit" style="background:var(--c1);color:#fff">儲存紀錄</button>
    </form>
  </section>

  <!-- === B. 紀錄列表 === -->
  <section id="listSec">
    <div id="listBox"></div>

    <!-- 折線圖 -->
    <div class="chartWrap" style="display:none">
      <canvas id="sugarChart"></canvas>
    </div>
  </section>
</main>

<!-- ===================  3. 功能腳本  =================== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* •••••••••  基本 DOM 物件  ••••••••• */
const form      = document.getElementById('recordForm');
const listBox   = document.getElementById('listBox');
const chartWrap = document.querySelector('.chartWrap');
const dateInput = document.getElementById('date');
const tabForm   = document.getElementById('tabForm');
const tabList   = document.getElementById('tabList');
const formSec   = document.getElementById('formSec');
const listSec   = document.getElementById('listSec');

let   chart;                 // Chart.js 實例
let   records = [];          // 全部紀錄（存在記憶體，未做永久存檔）

/* •••••••••  1. 自動填入今日日期  ••••••••• */
(function autoDate(){
  const today = new Date().toISOString().split('T')[0];
  dateInput.value = today;
})();

/* •••••••••  2. 分頁切換  ••••••••• */
tabForm.addEventListener('click', () => toggleTab(true));
tabList.addEventListener('click', () => toggleTab(false));

function toggleTab(showForm){
  tabForm.classList.toggle('active', showForm);
  tabList.classList.toggle('active', !showForm);
  formSec.classList.toggle('active', showForm);
  listSec.classList.toggle('active', !showForm);
  if(!showForm) buildList();
}

/* •••••••••  3. 儲存紀錄  ••••••••• */
form.addEventListener('submit', e=>{
  e.preventDefault();

  const rec = {
    name : document.getElementById('name').value.trim(),
    age  : +document.getElementById('age').value,
    date : dateInput.value,
    meal : document.getElementById('meal').value,
    sugar: document.getElementById('sugar').value
           ? +document.getElementById('sugar').value
           : null
  };
  records.push(rec);

  form.reset();
  autoDate();                         // 重設後再填回今天日期
  alert('已儲存！');
});

/* •••••••••  4. 產生列表 + 圖表  ••••••••• */
function buildList(){
  const showInfo = document.getElementById('showInfo').checked;
  listBox.innerHTML = '';

  records.forEach(r=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h4>${r.date}（${r.meal}）</h4>
      ${showInfo ? `<p>姓名：${r.name}　年齡：${r.age}</p>` : ''}
      ${r.sugar ? `<p>血糖：<strong>${r.sugar}</strong> mmol/L</p>`
                : '<p>未量血糖</p>'}
    `;
    listBox.appendChild(card);
  });

  buildChart();
}

/* ---------- 折線圖 ---------- */
function buildChart(){
  const data   = records.filter(r=>r.sugar).map(r=>r.sugar);
  const labels = records.filter(r=>r.sugar).map(r=>r.date+' '+r.meal);

  if(!data.length){             // 沒有血糖資料就隱藏圖表
    chartWrap.style.display='none';
    return;
  }
  chartWrap.style.display='block';

  if(chart) chart.destroy();    // 先銷毀舊圖表
  chart = new Chart(document.getElementById('sugarChart'),{
    type:'line',
    data:{
      labels,
      datasets:[{
        label:'血糖 (mmol/L)',
        data,
        borderColor:varColor('--c2'),
        backgroundColor:varColor('--c2','33'), /* 20% 透明度 */
        tension:.25,
        pointRadius:4,
        pointBackgroundColor:varColor('--c2')
      }]
    },
    options:{
      scales:{
        y:{beginAtZero:false}
      }
    }
  });
}

/* ---------- 小工具：取得 CSS 變數 ---------- */
function varColor(name,alpha){
  const v = getComputedStyle(document.documentElement)
            .getPropertyValue(name).trim();
  return alpha ? v+alpha : v;
}
</script>

</body>
</html>
