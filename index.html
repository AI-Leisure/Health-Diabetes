<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ç³–å°¿ç—…å¥åº·ç®¡ç†</title>
<style>
:root{
  --blue:#0d6efd;
  --red:#d32f2f;
  --r:6px;
  font-family:system-ui,-apple-system,"Noto Sans","Segoe UI",sans-serif
}
*{box-sizing:border-box;margin:0}
body{background:#fff;color:#222;min-height:100vh;display:flex;flex-direction:column}
header{
  background:var(--blue);color:#fff;text-align:center;
  padding:1.1rem;font-size:1.8rem;font-weight:700
}
nav{display:flex;border-bottom:3px solid var(--blue)}
nav button{
  flex:1;border:0;background:#f0f0f0;padding:.9rem;
  font-size:1.05rem;font-weight:600;color:#555
}
nav button.active{
  background:#fff;color:var(--blue);
  border-bottom:3px solid var(--blue)
}
main{flex:1;width:94%;max-width:760px;margin:1.2rem auto}

section{display:none}section.active{display:block}

form{display:flex;flex-direction:column;gap:.9rem}
label{display:flex;flex-direction:column;font-weight:600;font-size:.9rem}
input,select,button{
  font-size:1rem;padding:.6rem .65rem;
  border:1px solid #bbb;border-radius:var(--r)
}
input[type=checkbox]{width:1.2rem;height:1.2rem;margin-right:.4rem}
.inline{flex-direction:row;align-items:center;gap:.4rem}

.personal{display:none}   /* é è¨­éš±è—å§“å / å¹´é½¡ */

#photosWrap{
  display:flex;flex-wrap:wrap;gap:.45rem;margin-top:.3rem
}
.photo{
  width:80px;height:80px;border:1px solid #bbb;border-radius:var(--r);
  position:relative;overflow:hidden
}
.photo img{width:100%;height:100%;object-fit:cover}
.photo em{
  position:absolute;left:0;right:0;bottom:0;background:#fff;
  font-size:.85rem;font-weight:600;text-align:center
}
.photo span{
  position:absolute;top:-5px;right:-5px;width:18px;height:18px;
  border-radius:50%;background:#fff;border:1px solid #888;
  font-size:.7rem;line-height:16px;text-align:center;cursor:pointer
}

#tools{display:flex;align-items:center;gap:.7rem;margin:1rem 0}
#subTabs{display:flex;margin-bottom:.8rem}
#subTabs button{
  flex:1;border:1px solid var(--blue);background:#fff;color:var(--blue);
  padding:.55rem;border-radius:var(--r)
}
#subTabs button.active{background:var(--blue);color:#fff}

.list-card{
  border:1px solid #ddd;border-radius:var(--r);
  padding:1rem;margin-bottom:1rem
}
.list-card h4{color:var(--blue);margin-bottom:.35rem}
.attach{display:flex;gap:.4rem;margin-top:.4rem}
.attach img{
  width:64px;height:64px;object-fit:cover;
  border:1px solid #bbb;border-radius:var(--r)
}
.attach figcaption{font-size:.85rem;text-align:center}

.calendar{width:100%;border-collapse:collapse}
.calendar th,.calendar td{
  border:1px solid #ccc;width:14.28%;height:86px;vertical-align:top;
  font-size:.75rem;padding:2px
}
.calendar th{background:#f5f5f5}

.chartWrap{margin-top:1.2rem}
canvas{max-width:100%;height:240px!important}
</style>
</head>
<body>
<header>ç³–å°¿ç—…å¥åº·ç®¡ç†</header>

<nav>
  <button id="tabAdd" class="active">æ–°å¢ç´€éŒ„</button>
  <button id="tabList">ç´€ éŒ„</button>
</nav>

<main>
<!-- æ–°å¢ -->
<section id="addSec" class="active">
  <form id="form">
    <label class="inline"><input type="checkbox" id="showInfo"> é¡¯ç¤ºå€‹äººè³‡æ–™</label>

    <div class="personal">
      <label>å§“å <input id="name"></label>
      <label>å¹´é½¡ <input id="age" type="number" min="1" max="120"></label>
    </div>

    <label>æ—¥æœŸ <input id="date" type="date" required></label>

    <label>é¤æ¬¡
      <select id="meal"><option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option></select>
    </label>

    <label>è¡€ç³– (mmol/Lï¼Œå¯ç•™ç©º)
      <input id="sugarMmol" type="number" step="0.1" min="1" max="40">
    </label>

    <label class="inline">æ‹ç…§
      <button id="camBtn" type="button">ğŸ“· æ‹ç…§</button>
      <input id="camIn" type="file" accept="image/*" capture="environment" hidden>
    </label>

    <label class="inline">ä¸Šè¼‰é£Ÿç‰©ç…§ç‰‡
      <button id="fileBtn" type="button">ğŸ“‘ é¸æ“‡æª”æ¡ˆ</button>
      <input id="fileIn" type="file" accept="image/*" multiple hidden>
    </label>

    <div style="color:#666;display:flex;align-items:center;font-size:0.85rem">
      <span>AI ä¼°å€¼ä¸­é¡¯ç¤º â³ï¼Œå¤±æ•—é¡¯ç¤º âš ï¸</span>
    </div>

    <div id="photosWrap"></div>

    <button type="submit" style="background:var(--blue);color:#fff;margin-top:1rem">å„²å­˜ç´€éŒ„</button>
  </form>
</section>

<!-- åˆ—è¡¨ -->
<section id="listSec">
  <div id="tools">
    <label style="flex:1">
      æœˆä»½ <input type="month" id="monthPick" style="width:100%">
    </label>
    <button id="chartBtn"
            style="border:1px solid #bbb;background:#fff;border-radius:var(--r);
                   padding:.45rem .9rem">åˆ†æåœ–è¡¨</button>
  </div>

  <div id="subTabs">
    <button id="tabL" class="active">åˆ—è¡¨</button>
    <button id="tabC">æœˆæ›†</button>
  </div>

  <div id="listBox"></div>
  <div id="calBox" style="display:none"></div>

  <div class="chartWrap" style="display:none">
    <canvas id="sugarChart"></canvas>
  </div>
</section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<script>
/* =========================================================
   ä½¿ç”¨æä¾›çš„ Cloudflare Worker ä»£ç†
   ========================================================= */
const WORKER = 'https://off-proxy.leisure9654.workers.dev';
/* --------------------------------------------------------- */

const $=id=>document.getElementById(id);
const today=()=>new Date().toISOString().split('T')[0];

let model,photos=[],records=[],chart,chartShown=false;

/* ---------- åˆå§‹åŒ– -------------------------------------- */
window.addEventListener('DOMContentLoaded',async()=>{
  $('date').value=today();
  $('name').value=localStorage.dm_name||'';
  $('age').value=localStorage.dm_age||'';
  
  // å¾localStorageåŠ è¼‰è¨˜éŒ„
  try {
    const saved = localStorage.getItem('dm_records');
    if (saved) records = JSON.parse(saved);
  } catch (e) {
    console.error('åŠ è¼‰è¨˜éŒ„æ™‚å‡ºéŒ¯', e);
  }
  
  try {
    model=await mobilenet.load();
    console.log('AIæ¨¡å‹åŠ è¼‰å®Œæˆ');
  } catch (e) {
    console.error('AIæ¨¡å‹åŠ è¼‰å¤±æ•—', e);
    alert('AIæ¨¡å‹åŠ è¼‰å¤±æ•—ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨');
  }
  
  toggleInfo();
  render();
});

$('showInfo').onchange=toggleInfo;
function toggleInfo(){
  const s=$('showInfo').checked;
  document.querySelector('.personal').style.display=s?'block':'none';
  $('name').required=$('age').required=s;
}

/* ---------- ä¸»åˆ†é åˆ‡æ› ---------------------------------- */
$('tabAdd').onclick=()=>switchTab(true);
$('tabList').onclick=()=>switchTab(false);
function switchTab(add){
  $('tabAdd').classList.toggle('active',add);
  $('tabList').classList.toggle('active',!add);
  $('addSec').classList.toggle('active',add);
  $('listSec').classList.toggle('active',!add);
  
  // åˆ‡æ›åˆ°è¨˜éŒ„é æ™‚æ›´æ–°
  if (!add) render();
}

/* ---------- å­åˆ†é åˆ‡æ› ---------------------------------- */
$('tabL').onclick=()=>sub(true);
$('tabC').onclick=()=>sub(false);
function sub(l){
  $('tabL').classList.toggle('active',l);
  $('tabC').classList.toggle('active',!l);
  $('listBox').style.display=l?'block':'none';
  $('calBox').style.display=l?'none':'block';
}

/* ---------- ä¸Šè¼‰ / æ‹ç…§ -------------------------------- */
$('camBtn').onclick=()=>$('camIn').click();
$('fileBtn').onclick=()=>$('fileIn').click();
$('camIn').onchange=e=>{
  addFiles(e.target.files);
  e.target.value = ''; // æ¸…ç©ºï¼Œå…è¨±é‡è¤‡é¸æ“‡ç›¸åŒæª”æ¡ˆ
};
$('fileIn').onchange=e=>{
  addFiles(e.target.files);
  e.target.value = ''; // æ¸…ç©ºï¼Œå…è¨±é‡è¤‡é¸æ“‡ç›¸åŒæª”æ¡ˆ
};

async function addFiles(fs){
  if (!fs || !fs.length) return;
  
  for(const f of fs){
    if(!f.type.startsWith('image/')) continue;
    
    try {
      const url=URL.createObjectURL(f);
      const p={url, state:'loading', sugar:null, file:f.name};
      photos.push(p);
      renderPhotos();
      
      if (model) {
        predict(p);
      } else {
        p.state = 'fail';
        renderPhotos();
      }
    } catch (e) {
      console.error('è™•ç†åœ–ç‰‡æ™‚å‡ºéŒ¯', e);
    }
  }
}

/* ---------- AI + ç³–ä»½ ---------------------------------- */
async function predict(p){
  try{
    const img=new Image();
    img.src=p.url;
    await img.decode();
    
    const [pred]=await model.classify(img);
    const label=pred.className.split(',')[0];
    p.sugar=await querySugar(label);
    p.state=p.sugar!==null?'done':'fail';
    p.label = label; // ä¿å­˜é£Ÿç‰©æ¨™ç±¤
  } catch(e) {
    console.error('AIé æ¸¬å¤±æ•—', e);
    p.state='fail';
  }
  
  renderPhotos();
}

async function querySugar(label){
  try{
    const url=`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(label)}&search_simple=1&action=process&json=1&page_size=10&fields=nutriments`;
    const proxyUrl = `${WORKER}?url=${encodeURIComponent(url)}`;
    
    const r=await fetch(proxyUrl);
    if (!r.ok) throw new Error(`HTTP error ${r.status}`);
    
    const js=await r.json();
    const arr=js.products
      .filter(p=>p.nutriments?.sugars_100g>0)
      .map(p=>p.nutriments.sugars_100g);
      
    return arr.length ? +(arr.reduce((s,v)=>s+v,0)/arr.length).toFixed(1) : null;
  } catch(e) {
    console.error('æŸ¥è©¢ç³–åˆ†å¤±æ•—', e, label);
    return null;
  }
}

/* ---------- thumbnails --------------------------------- */
$('photosWrap').onclick=e=>{
  const i=e.target.dataset.idx;
  if(i==null)return;
  photos.splice(i,1);
  renderPhotos();
};

function renderPhotos(){
  $('photosWrap').innerHTML=photos.map((p,i)=>`
    <div class="photo">
      <img src="${p.url}" alt="é£Ÿç‰©ç…§ç‰‡">
      <em>${p.state==='loading' ? 'â³' : p.state==='fail' ? 'âš ï¸' : p.sugar+' g'}</em>
      <span data-idx="${i}">âœ–</span>
    </div>`).join('');
}

/* ---------- å„²å­˜ --------------------------------------- */
$('form').onsubmit=e=>{
  e.preventDefault();
  
  if(photos.some(p=>p.state==='loading')){
    alert('ç›¸ç‰‡ä»åœ¨åˆ†æä¸­ï¼Œè«‹ç¨å€™');
    return;
  }
  
  // ä¿å­˜å€‹äººè³‡æ–™
  localStorage.dm_name=$('name').value.trim();
  localStorage.dm_age=$('age').value.trim();
  
  // å‰µå»ºæ–°ç´€éŒ„
  const newRecord = {
    id: Date.now(), // å”¯ä¸€IDç”¨æ–¼è­˜åˆ¥
    name: $('name').value.trim(),
    age: $('age').value.trim(),
    date: $('date').value,
    meal: $('meal').value,
    sugarMmol: parseFloat($('sugarMmol').value) || null,
    photos: photos.map(p => ({
      url: p.url,
      state: p.state,
      sugar: p.sugar,
      label: p.label || ''
    })),
    timestamp: new Date().toISOString()
  };
  
  // æ·»åŠ åˆ°è¨˜éŒ„åˆ—è¡¨
  records.unshift(newRecord);
  
  // ä¿å­˜åˆ°localStorage
  try {
    localStorage.setItem('dm_records', JSON.stringify(records));
  } catch (e) {
    console.error('ä¿å­˜è¨˜éŒ„å¤±æ•—', e);
    alert('è¨˜éŒ„ä¿å­˜å¤±æ•—ï¼š' + e.message);
  }
  
  alert('è¨˜éŒ„å·²æˆåŠŸå„²å­˜');
  
  // é‡ç½®è¡¨å–®
  $('sugarMmol').value = '';
  $('date').value = today();
  photos = [];
  renderPhotos();
  render();
};

/* ---------- List / Cal / Chart ------------------------- */
$('monthPick').onchange=render;

$('chartBtn').onclick=()=>{
  chartShown=!chartShown;
  $('chartBtn').textContent=chartShown?'éš±è—åœ–è¡¨':'åˆ†æåœ–è¡¨';
  document.querySelector('.chartWrap').style.display = chartShown ? 'block' : 'none';
  if(chartShown) renderChart();
};

function render(){
  // å…ˆè¨­ç½®æœˆä»½é¸æ“‡å™¨é è¨­å€¼ç‚ºç•¶å‰æœˆä»½
  if (!$('monthPick').value) {
    $('monthPick').value = today().substring(0, 7);
  }
  
  buildList();
  buildCal();
  if(chartShown) renderChart();
}

function buildList(){
  const ym = $('monthPick').value;
  const filteredRecords = records.filter(r => !ym || r.date.startsWith(ym));
  
  if (filteredRecords.length === 0) {
    $('listBox').innerHTML = '<div style="text-align:center;color:#666;padding:2rem">ç•¶æœˆæ²’æœ‰è¨˜éŒ„</div>';
    return;
  }
  
  $('listBox').innerHTML = filteredRecords.map(r => `
    <div class="list-card">
      <h4>${formatDate(r.date)}ï¼ˆ${r.meal}ï¼‰</h4>
      ${r.name || r.age ? `<p>å§“åï¼š${r.name || '-'}ã€€å¹´é½¡ï¼š${r.age || '-'}</p>` : ''}
      ${r.sugarMmol != null ? `<p>è¡€ç³–ï¼š<strong>${r.sugarMmol}</strong> mmol/L</p>` : ''}
      ${r.photos && r.photos.length ? `<div class="attach">
        ${r.photos.map(p => `<figure><img src="${p.url}" alt="é£Ÿç‰©ç…§ç‰‡">
          <figcaption>${p.label ? p.label + '<br>' : ''}${p.sugar ?? '?'} g</figcaption></figure>`).join('')}
      </div>` : ''}
    </div>`).join('');
}

function formatDate(dateStr) {
  // å°‡YYYY-MM-DDæ ¼å¼åŒ–ç‚ºæ›´å‹å¥½çš„é¡¯ç¤º
  const parts = dateStr.split('-');
  return `${parts[0]}å¹´${parts[1]}æœˆ${parts[2]}æ—¥`;
}

function buildCal(){
  const ym = $('monthPick').value || today().substring(0, 7);
  const [y, m] = ym.split('-').map(Number);
  
  // ç²å–ç•¶æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå¹¾
  const first = new Date(y, m-1, 1);
  // ç²å–ç•¶æœˆå¤©æ•¸
  const days = new Date(y, m, 0).getDate();
  
  let html = '<table class="calendar"><thead><tr>' + 
    'æ—¥ä¸€äºŒä¸‰å››äº”å…­'.split('').map(d => `<th>${d}</th>`).join('') +
    '</tr></thead><tbody><tr>';
    
  // ç¬¬ä¸€é€±å¡«å……ç©ºç™½
  for (let i = 0; i < first.getDay(); i++) {
    html += '<td></td>';
  }
  
  // å¡«å……æ—¥æœŸ
  for (let d = 1; d <= days; d++) {
    const ds = `${ym}-${String(d).padStart(2, '0')}`;
    const dayRecords = records.filter(r => r.date === ds);
    
    html += `<td><strong>${d}</strong><br>`;
    
    if (dayRecords.length) {
      dayRecords.forEach(r => {
        const mealIcon = r.meal === 'æ—©é¤' ? 'ğŸŒ…' : r.meal === 'åˆé¤' ? 'â˜€ï¸' : 'ğŸŒ™';
        html += `<div style="font-size:0.7rem">${mealIcon} ${r.sugarMmol ? r.sugarMmol + 'mmol/L' : 'ç„¡è¡€ç³–'}</div>`;
      });
    }
    
    html += '</td>';
    
    // æ›è¡Œ
    if ((first.getDay() + d) % 7 === 0 && d !== days) {
      html += '</tr><tr>';
    }
  }
  
  // æœ€å¾Œä¸€é€±å¡«å……ç©ºç™½
  const rem = (first.getDay() + days) % 7;
  if (rem) {
    html += `<td colspan="${7-rem}"></td>`;
  }
  
  html += '</tr></tbody></table>';
  $('calBox').innerHTML = html;
}

function renderChart(){
  if (!chartShown) return;
  
  const ym = $('monthPick').value;
  const rows = records.filter(r => r.sugarMmol != null && (!ym || r.date.startsWith(ym)))
    .sort((a, b) => a.date.localeCompare(b.date) || mealOrder(a.meal) - mealOrder(b.meal));
  
  function mealOrder(meal) {
    return meal === 'æ—©é¤' ? 0 : meal === 'åˆé¤' ? 1 : 2;
  }
  
  if (!rows.length) {
    document.querySelector('.chartWrap').innerHTML = '<div style="text-align:center;color:#666;padding:2rem">æ²’æœ‰è¶³å¤ çš„è¡€ç³–æ•¸æ“šä¾†ç”Ÿæˆåœ–è¡¨</div>';
    return;
  }
  
  // éŠ·æ¯€èˆŠåœ–è¡¨
  if (chart) chart.destroy();
  
  // å»ºç«‹æ–°åœ–è¡¨å®¹å™¨
  document.querySelector('.chartWrap').innerHTML = '<canvas id="sugarChart"></canvas>';
  
  // å®šç¾©æ­£å¸¸ç¯„åœ
  const normalRange = {
    breakfast: { min: 4.0, max: 7.0 },
    lunch: { min: 4.0, max: 10.0 },
    dinner: { min: 4.0, max: 10.0 }
  };
  
  // å‰µå»ºåœ–è¡¨
  chart = new Chart($('sugarChart'), {
    type: 'line',
    data: {
      labels: rows.map(r => formatDate(r.date).substring(5) + ' ' + r.meal),
      datasets: [
        {
          label: 'è¡€ç³– (mmol/L)',
          data: rows.map(r => r.sugarMmol),
          borderColor: '#d32f2f',
          backgroundColor: 'rgba(211, 47, 47, 0.2)',
          tension: 0.3,
          pointRadius: 5,
          pointBackgroundColor: '#d32f2f',
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.raw;
              let meal = rows[context.dataIndex].meal;
              let range = meal === 'æ—©é¤' ? normalRange.breakfast :
                          meal === 'åˆé¤' ? normalRange.lunch : normalRange.dinner;
              
              let status = value < range.min ? 'åä½' : 
                          value > range.max ? 'åé«˜' : 'æ­£å¸¸';
              
              return [`è¡€ç³–å€¼: ${value} mmol/L`, `ç‹€æ…‹: ${status}`];
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          min: 3,
          max: Math.max(15, ...rows.map(r => r.sugarMmol)) + 1,
          title: {
            display: true,
            text: 'è¡€ç³–å€¼ (mmol/L)'
          }
        }
      }
    }
  });
}
</script>
</body>
</html>
