<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>MyDiabetes – MVP</title>

<style>
:root{--w:min(100vw,480px)}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
     "Helvetica Neue",Arial,sans-serif;margin:0;padding:1rem;
     display:flex;flex-direction:column;align-items:center;gap:.8rem}
h1{font-size:1.4rem;margin:.2rem 0 1rem}
input,button,select{font-size:1rem;padding:.4rem}
table{width:var(--w);border-collapse:collapse;font-size:.9rem}
td,th{border:1px solid #aaa;padding:.3rem;text-align:center}
canvas{width:var(--w);max-width:100%;border:1px solid #666}
#preview{width:100%;max-width:var(--w);border:1px solid #666;margin-top:.5rem}
</style>

<h1>MyDiabetes – 血糖紀錄 MVP</h1>

<!-- ===== 新增紀錄 ===== -->
<form id="addForm">
  日期 <input type="date" id="dt" required>
  時間 <input type="time" id="tm" required>
  血糖 <input type="number" id="gl" min="20" max="600" required> mg/dL
  <button>➕ 新增</button>
</form>

<button id="camBtn">📷 相機拍照（可附證據）</button>
<video id="camView" style="display:none" playsinline></video>
<canvas id="shotCanvas" style="display:none"></canvas>
<img id="preview" hidden>

<!-- ===== 紀錄列表 ===== -->
<table id="tbl">
  <thead><tr><th>日期</th><th>時間</th><th>血糖</th><th>相片</th><th></th></tr></thead>
  <tbody></tbody>
</table>

<!-- ===== 趨勢圖 ===== -->
<canvas id="chart" height="160"></canvas>

<script>
/* ==== 工具 ==== */
const $ = s=>document.querySelector(s);
const LS_KEY='mdb_data';
let data = JSON.parse(localStorage.getItem(LS_KEY)||'[]');

/* ==== 畫表格 ==== */
function render(){
  const tb=$('#tbl tbody');
  tb.innerHTML='';
  data.forEach((d,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${d.d}</td><td>${d.t}</td><td>${d.g}</td>
      <td>${d.img?'<a href="'+d.img+'" target=_blank>查看</a>':''}</td>
      <td><button data-i=${i}>🗑️</button></td>`;
    tb.appendChild(tr);
  });
  drawChart();
}
$('#tbl').onclick=e=>{
  if(e.target.tagName==='BUTTON'){
    data.splice(e.target.dataset.i,1);
    save();
  }
};
function save(){
  localStorage.setItem(LS_KEY,JSON.stringify(data));
  render();
}

/* ==== 新增紀錄 ==== */
$('#addForm').onsubmit=e=>{
  e.preventDefault();
  data.push({d:$('#dt').value,t:$('#tm').value,g:+$('#gl').value,img:$('#preview').src||''});
  $('#preview').hidden=true; $('#preview').src='';
  save(); e.target.reset();
};

/* ==== 簡易趨勢圖（純 Canvas，不用外部庫） ==== */
function drawChart(){
  const cvs=$('#chart'), ctx=cvs.getContext('2d');
  const W=cvs.width, H=cvs.height; ctx.clearRect(0,0,W,H);
  if(!data.length) return;
  const pts=data.map(d=>d.g);
  const max=Math.max(...pts)+20, min=Math.min(...pts)-20;
  // grid
  ctx.strokeStyle='#ccc'; ctx.lineWidth=1;
  for(let y=0;y<=4;y++){
    const py=y*H/4; ctx.beginPath();ctx.moveTo(0,py);ctx.lineTo(W,py);ctx.stroke();
    ctx.fillText(Math.round(max-(max-min)*y/4),2,py-2);
  }
  // line
  ctx.strokeStyle='#0a0'; ctx.lineWidth=2; ctx.beginPath();
  pts.forEach((v,i)=>{
    const x=i*(W/(pts.length-1)||1);
    const y=(1-(v-min)/(max-min))*H;
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  });
  ctx.stroke();
}

/* ==== 相機 ==== */
const camBtn=$('#camBtn'), v=$('#camView'), cvs=$('#shotCanvas'), pre=$('#preview');
let stream;
camBtn.onclick=async()=>{
  if(stream){ stopCam(); return;}
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    v.srcObject=stream; await v.play();
    v.style.display='block'; camBtn.textContent='📸 拍照';
  }catch(err){
    alert('無法開啟相機：'+err);
  }
};
v.onclick=()=>{ // 點擊預覽拍一張
  const {videoWidth:w,videoHeight:h}=v;
  cvs.width=w;cvs.height=h;
  cvs.getContext('2d').drawImage(v,0,0,w,h);
  pre.src=cvs.toDataURL('image/jpeg',0.92);
  pre.hidden=false;
  stopCam();
};
function stopCam(){
  stream?.getTracks().forEach(t=>t.stop());
  stream=null; v.style.display='none'; camBtn.textContent='📷 相機拍照';
}

/* ==== 首次渲染 ==== */
render();
</script>
</html>
