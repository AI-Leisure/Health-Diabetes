<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>MyDiabetes â€“ MVP</title>

<style>
:root{--w:min(100vw,480px)}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
     "Helvetica Neue",Arial,sans-serif;margin:0;padding:1rem;
     display:flex;flex-direction:column;align-items:center;gap:.8rem}
h1{font-size:1.4rem;margin:.2rem 0 1rem}
input,button,select{font-size:1rem;padding:.4rem}
table{width:var(--w);border-collapse:collapse;font-size:.9rem}
td,th{border:1px solid #aaa;padding:.3rem;text-align:center}
canvas{width:var(--w);max-width:100%;border:1px solid #666}
#preview{width:100%;max-width:var(--w);border:1px solid #666;margin-top:.5rem}
</style>

<h1>MyDiabetes â€“ è¡€ç³–ç´€éŒ„ MVP</h1>

<!-- ===== æ–°å¢ç´€éŒ„ ===== -->
<form id="addForm">
  æ—¥æœŸ <input type="date" id="dt" required>
  æ™‚é–“ <input type="time" id="tm" required>
  è¡€ç³– <input type="number" id="gl" min="20" max="600" required> mg/dL
  <button>â• æ–°å¢</button>
</form>

<button id="camBtn">ğŸ“· ç›¸æ©Ÿæ‹ç…§ï¼ˆå¯é™„è­‰æ“šï¼‰</button>
<video id="camView" style="display:none" playsinline></video>
<canvas id="shotCanvas" style="display:none"></canvas>
<img id="preview" hidden>

<!-- ===== ç´€éŒ„åˆ—è¡¨ ===== -->
<table id="tbl">
  <thead><tr><th>æ—¥æœŸ</th><th>æ™‚é–“</th><th>è¡€ç³–</th><th>ç›¸ç‰‡</th><th></th></tr></thead>
  <tbody></tbody>
</table>

<!-- ===== è¶¨å‹¢åœ– ===== -->
<canvas id="chart" height="160"></canvas>

<script>
/* ==== å·¥å…· ==== */
const $ = s=>document.querySelector(s);
const LS_KEY='mdb_data';
let data = JSON.parse(localStorage.getItem(LS_KEY)||'[]');

/* ==== ç•«è¡¨æ ¼ ==== */
function render(){
  const tb=$('#tbl tbody');
  tb.innerHTML='';
  data.forEach((d,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${d.d}</td><td>${d.t}</td><td>${d.g}</td>
      <td>${d.img?'<a href="'+d.img+'" target=_blank>æŸ¥çœ‹</a>':''}</td>
      <td><button data-i=${i}>ğŸ—‘ï¸</button></td>`;
    tb.appendChild(tr);
  });
  drawChart();
}
$('#tbl').onclick=e=>{
  if(e.target.tagName==='BUTTON'){
    data.splice(e.target.dataset.i,1);
    save();
  }
};
function save(){
  localStorage.setItem(LS_KEY,JSON.stringify(data));
  render();
}

/* ==== æ–°å¢ç´€éŒ„ ==== */
$('#addForm').onsubmit=e=>{
  e.preventDefault();
  data.push({d:$('#dt').value,t:$('#tm').value,g:+$('#gl').value,img:$('#preview').src||''});
  $('#preview').hidden=true; $('#preview').src='';
  save(); e.target.reset();
};

/* ==== ç°¡æ˜“è¶¨å‹¢åœ–ï¼ˆç´” Canvasï¼Œä¸ç”¨å¤–éƒ¨åº«ï¼‰ ==== */
function drawChart(){
  const cvs=$('#chart'), ctx=cvs.getContext('2d');
  const W=cvs.width, H=cvs.height; ctx.clearRect(0,0,W,H);
  if(!data.length) return;
  const pts=data.map(d=>d.g);
  const max=Math.max(...pts)+20, min=Math.min(...pts)-20;
  // grid
  ctx.strokeStyle='#ccc'; ctx.lineWidth=1;
  for(let y=0;y<=4;y++){
    const py=y*H/4; ctx.beginPath();ctx.moveTo(0,py);ctx.lineTo(W,py);ctx.stroke();
    ctx.fillText(Math.round(max-(max-min)*y/4),2,py-2);
  }
  // line
  ctx.strokeStyle='#0a0'; ctx.lineWidth=2; ctx.beginPath();
  pts.forEach((v,i)=>{
    const x=i*(W/(pts.length-1)||1);
    const y=(1-(v-min)/(max-min))*H;
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  });
  ctx.stroke();
}

/* ==== ç›¸æ©Ÿ ==== */
const camBtn=$('#camBtn'), v=$('#camView'), cvs=$('#shotCanvas'), pre=$('#preview');
let stream;
camBtn.onclick=async()=>{
  if(stream){ stopCam(); return;}
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    v.srcObject=stream; await v.play();
    v.style.display='block'; camBtn.textContent='ğŸ“¸ æ‹ç…§';
  }catch(err){
    alert('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼š'+err);
  }
};
v.onclick=()=>{ // é»æ“Šé è¦½æ‹ä¸€å¼µ
  const {videoWidth:w,videoHeight:h}=v;
  cvs.width=w;cvs.height=h;
  cvs.getContext('2d').drawImage(v,0,0,w,h);
  pre.src=cvs.toDataURL('image/jpeg',0.92);
  pre.hidden=false;
  stopCam();
};
function stopCam(){
  stream?.getTracks().forEach(t=>t.stop());
  stream=null; v.style.display='none'; camBtn.textContent='ğŸ“· ç›¸æ©Ÿæ‹ç…§';
}

/* ==== é¦–æ¬¡æ¸²æŸ“ ==== */
render();
</script>
</html>
