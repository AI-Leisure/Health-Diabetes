<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ç³–å°¿ç—…å¥åº·ç®¡ç†</title>
<style>
:root{
  --blue:#0d6efd;
  --red:#d32f2f;
  --r:6px;
  font-family:system-ui,-apple-system,"Noto Sans","Segoe UI",sans-serif
}
*{box-sizing:border-box;margin:0}
body{background:#fff;color:#222;min-height:100vh;display:flex;flex-direction:column}
header{
  background:var(--blue);color:#fff;text-align:center;
  padding:1.1rem;font-size:1.8rem;font-weight:700
}
nav{display:flex;border-bottom:3px solid var(--blue)}
nav button{
  flex:1;border:0;background:#f0f0f0;padding:.9rem;
  font-size:1.05rem;font-weight:600;color:#555
}
nav button.active{
  background:#fff;color:var(--blue);
  border-bottom:3px solid var(--blue)
}
main{flex:1;width:94%;max-width:760px;margin:1.2rem auto}

section{display:none}section.active{display:block}

form{display:flex;flex-direction:column;gap:.9rem}
label{display:flex;flex-direction:column;font-weight:600;font-size:.9rem}
input,select,button{
  font-size:1rem;padding:.6rem .65rem;
  border:1px solid #bbb;border-radius:var(--r)
}
input[type=checkbox]{width:1.2rem;height:1.2rem;margin-right:.4rem}
.inline{flex-direction:row;align-items:center;gap:.4rem}

.personal{display:none}   /* é è¨­éš±è—å§“å / å¹´é½¡ */

#photosWrap{
  display:flex;flex-wrap:wrap;gap:.45rem;margin-top:.3rem
}
.photo{
  width:80px;height:80px;border:1px solid #bbb;border-radius:var(--r);
  position:relative;overflow:hidden;cursor:pointer;
  transition: transform 0.2s;
}
.photo:hover{
  transform: scale(1.05);
}
.photo img{width:100%;height:100%;object-fit:cover}
.photo em{
  position:absolute;left:0;right:0;bottom:0;background:#fff;
  font-size:.75rem;font-weight:600;text-align:center
}
.photo span{
  position:absolute;top:-5px;right:-5px;width:18px;height:18px;
  border-radius:50%;background:#fff;border:1px solid #888;
  font-size:.7rem;line-height:16px;text-align:center;cursor:pointer;
  z-index:10;
}
.edit-sugar{
  position:absolute;top:-5px;left:-5px;width:18px;height:18px;
  border-radius:50%;background:#fff;border:1px solid #888;
  font-size:.7rem;line-height:16px;text-align:center;cursor:pointer;
  display:none;
  z-index:10;
}
.photo:hover .edit-sugar{display:block}

.sugar-sum{
  background:#f8f9fa;
  border:1px solid #ddd;
  border-radius:var(--r);
  padding:8px 12px;
  margin-top:10px;
  font-weight:600;
  display:flex;
  justify-content:space-between;
}

.sugar-sum-value{
  color:var(--red);
}

#tools{display:flex;align-items:center;gap:.7rem;margin:1rem 0}
#subTabs{display:flex;margin-bottom:.8rem}
#subTabs button{
  flex:1;border:1px solid var(--blue);background:#fff;color:var(--blue);
  padding:.55rem;border-radius:var(--r)
}
#subTabs button.active{background:var(--blue);color:#fff}

.list-card{
  border:1px solid #ddd;border-radius:var(--r);
  padding:1rem;margin-bottom:1rem;position:relative;
}
.list-card h4{color:var(--blue);margin-bottom:.35rem}
.attach{display:flex;gap:.4rem;margin-top:.4rem;flex-wrap:wrap;}
.attach img{
  width:64px;height:64px;object-fit:cover;
  border:1px solid #bbb;border-radius:var(--r);
  cursor:pointer;
}
.attach figcaption{font-size:.85rem;text-align:center}

.list-sugar-sum{
  background:#f8f9fa;
  border-top:1px solid #ddd;
  margin-top:10px;
  padding-top:10px;
  font-weight:600;
  text-align:right;
}

.calendar{width:100%;border-collapse:collapse}
.calendar th,.calendar td{
  border:1px solid #ccc;width:14.28%;height:86px;vertical-align:top;
  font-size:.75rem;padding:2px
}
.calendar th{background:#f5f5f5}

.chartWrap{margin-top:1.2rem}
canvas{max-width:100%;height:240px!important}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}
.modal-content {
  background-color: #fff;
  margin: 15% auto;
  padding: 20px;
  border-radius: var(--r);
  width: 80%;
  max-width: 400px;
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}
.modal-header h3 {
  margin: 0;
}
.close {
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
}

.img-preview-modal {
  display: none;
  position: fixed;
  z-index: 1100;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.85);
  padding: 20px;
  text-align: center;
}

.img-preview-content {
  max-width: 90%;
  max-height: 80vh;
  margin: 0 auto;
  display: inline-block;
  position: relative;
  top: 50%;
  transform: translateY(-50%);
}

.img-preview-content img {
  max-width: 100%;
  max-height: 80vh;
  object-fit: contain;
  border-radius: 8px;
}

.img-preview-caption {
  color: white;
  margin-top: 15px;
  font-size: 1.1rem;
}

.img-preview-close {
  position: absolute;
  top: 20px;
  right: 20px;
  color: white;
  font-size: 30px;
  font-weight: bold;
  cursor: pointer;
}

.img-preview-edit {
  margin-top: 15px;
  padding: 8px 16px;
  background-color: var(--blue);
  color: white;
  border: none;
  border-radius: var(--r);
  cursor: pointer;
  font-size: 1rem;
}

.img-preview-edit:hover {
  background-color: #0056b3;
}

.list-actions {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  gap: 5px;
}

.btn-edit, .btn-delete {
  background: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 2px 8px;
  font-size: 0.85rem;
  cursor: pointer;
.image-preview {
  max-height: 60vh;
  object-fit: contain;
}
}

.btn-edit:hover {
  background: #e9e9e9;
}

.btn-delete {
  color: var(--red);
}
  
.btn-delete:hover {
  background: #ffebee;
}
  
#editRecordModal {
  overflow-y: auto;
  max-height: 90vh;
}

.status-msg {
  margin-top: 5px;
  color: #666;
  font-size: 0.8rem;
}

.food-select {
  width: 100%;
  margin-top: 10px;
}

.ai-progress {
  margin-top: 5px;
  width: 100%;
  height: 5px;
  background-color: #f0f0f0;
  border-radius: 2px;
  overflow: hidden;
  display: none;
}

.ai-progress-bar {
  height: 100%;
  width: 0%;
  background-color: var(--blue);
  border-radius: 2px;
  transition: width 0.3s ease;
}
</style>
</head>
<body>
<header>ç³–å°¿ç—…å¥åº·ç®¡ç†</header>

<nav>
  <button id="tabAdd" class="active">æ–°å¢ç´€éŒ„</button>
  <button id="tabList">ç´€ éŒ„</button>
</nav>

<main>
<!-- æ–°å¢ -->
<section id="addSec" class="active">
  <form id="form">
    <label class="inline"><input type="checkbox" id="showInfo"> é¡¯ç¤ºå€‹äººè³‡æ–™</label>

    <div class="personal">
      <label>å§“å <input id="name"></label>
      <label>å¹´é½¡ <input id="age" type="number" min="1" max="120"></label>

    <label>æ—¥æœŸ <input id="date" type="date" required></label>

    <label>é¤æ¬¡
      <select id="meal"><option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option></select>
    </label>

    <label>è¡€ç³– (mmol/Lï¼Œå¯ç•™ç©º)
      <input id="sugarMmol" type="number" step="0.1" min="1" max="40">
    </label>

    <label class="inline">æ‹ç…§
      <button id="camBtn" type="button">ğŸ“· æ‹ç…§</button>
      <input id="camIn" type="file" accept="image/*" capture="environment" hidden>
    </label>

    <label class="inline">ä¸Šè¼‰é£Ÿç‰©ç…§ç‰‡
      <button id="fileBtn" type="button">ğŸ“‘ é¸æ“‡æª”æ¡ˆ</button>
      <input id="fileIn" type="file" accept="image/*" multiple hidden>
    </label>

    <div id="statusMsg" class="status-msg">ä¸Šå‚³é£Ÿç‰©ç…§ç‰‡å¾Œå°‡è‡ªå‹•è¾¨è­˜é£Ÿç‰©é¡å‹</div>
    <div id="aiProgress" class="ai-progress">
      <div id="aiProgressBar" class="ai-progress-bar"></div>
    </div>

    <div id="photosWrap"></div>

<div id="manualInputSection" style="margin-top:1rem; display:block">
  <label>è‡ªå®šç¾©é£Ÿç‰©åç¨± <input id="customName" placeholder="ä¾‹å¦‚ï¼šç´…è±†é¤…"></label>
  <label>é‡é‡ (g) <input id="amount" type="number" value="100" min="1" max="1000"></label>
  <button type="button" onclick="submitEditedFood()" style="margin-top:0.5rem">å¥—ç”¨è‡ªå®šç¾©</button>
</div>
    </div>
    
    <div id="sugarSumContainer" class="sugar-sum" style="display:none">
      <span>é£Ÿç‰©ç³–åˆ†ç¸½å’Œ:</span>
      <span class="sugar-sum-value" id="sugarSum">0 g</span>
    </div>

    <button type="submit" style="background:var(--blue);color:#fff;margin-top:1rem">å„²å­˜ç´€éŒ„</button>
  </form>
</section>

<!-- åˆ—è¡¨ -->
<section id="listSec">
  <div id="tools">
    <label style="flex:1">
      æœˆä»½ <input type="month" id="monthPick" style="width:100%">
    </label>
    <button id="chartBtn"
            style="border:1px solid #bbb;background:#fff;border-radius:var(--r);
                   padding:.45rem .9rem">åˆ†æåœ–è¡¨</button>
  </div>

  <div id="subTabs">
    <button id="tabL" class="active">åˆ—è¡¨</button>
    <button id="tabC">æœˆæ›†</button>
  </div>

  <div id="listBox"></div>
  <div id="calBox" style="display:none"></div>

  <div class="chartWrap" style="display:none">
    <canvas id="sugarChart"></canvas>
  </div>
</section>
</main>

<!-- ç…§ç‰‡é è¦½æ¨¡æ…‹æ¡† -->
<div id="imgPreviewModal" class="img-preview-modal">
  <span class="img-preview-close">&times;</span>
  <div class="img-preview-content">
    <img id="previewImg" src="" alt="é£Ÿç‰©ç…§ç‰‡é è¦½">
    <div class="img-preview-caption" id="previewCaption"></div>
    <button id="previewEditBtn" class="img-preview-edit">ç·¨è¼¯é£Ÿç‰©</button>
  </div>
</div>

<!-- ç·¨è¼¯ç³–åˆ†çš„å½ˆçª— -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ç·¨è¼¯é£Ÿç‰©èˆ‡ç³–åˆ†</h3>
      <span class="close">&times;</span>
    </div>
    <img id="editImage" style="width:100%;max-height:200px;object-fit:contain;margin-bottom:10px" alt="é£Ÿç‰©ç…§ç‰‡">
    
    <p id="aiResult" style="margin-bottom:10px;font-weight:600;color:var(--blue)"></p>
    
    <label>é¸æ“‡é£Ÿç‰©é¡å‹
      <select id="foodTypeSelect" class="food-select">
        <option value="">è«‹é¸æ“‡é£Ÿç‰©é¡å‹...</option>
        <optgroup label="ä¸»é£Ÿ/ç©€ç‰©é¡">
          <option value="rice">ç™½é£¯ (0.3g)</option>
          <option value="brown rice">ç³™ç±³é£¯ (0.7g)</option>
          <option value="corn">ç‰ç±³ (6.0g)</option>
          <option value="noodles">éºµæ¢ (0.6g)</option>
          <option value="bread">éºµåŒ… (5.0g)</option>
          <option value="potato">é¦¬éˆ´è–¯ (1.2g)</option>
          <option value="sweet potato">ç•ªè–¯ (4.2g)</option>
        </optgroup>
        <optgroup label="è‚‰é¡/è›‹ç™½è³ª">
          <option value="chicken">é›è‚‰ (0.0g)</option>
          <option value="beef">ç‰›è‚‰ (0.0g)</option>
          <option value="pork">è±¬è‚‰ (0.0g)</option>
          <option value="fish">é­šé¡ (0.0g)</option>
          <option value="egg">é›è›‹ (0.4g)</option>
          <option value="tofu">è±†è… (0.7g)</option>
        </optgroup>
        <optgroup label="è”¬èœé¡">
          <option value="vegetable">è”¬èœ (2.0g)</option>
          <option value="salad">æ²™æ‹‰ (2.5g)</option>
          <option value="carrot">èƒ¡è˜¿è”” (4.7g)</option>
          <option value="tomato">ç•ªèŒ„ (2.6g)</option>
          <option value="broccoli">è¥¿è˜­èŠ± (1.7g)</option>
        </optgroup>
        <optgroup label="æ°´æœé¡">
          <option value="apple">è˜‹æœ (10.4g)</option>
          <option value="banana">é¦™è•‰ (12.2g)</option>
          <option value="orange">æ©™å­ (9.4g)</option>
          <option value="grape">è‘¡è„ (16.0g)</option>
          <option value="watermelon">è¥¿ç“œ (6.2g)</option>
        </optgroup>
        <optgroup label="ä¹³è£½å“">
          <option value="milk">ç‰›å¥¶ (4.8g)</option>
          <option value="yogurt">é…¸å¥¶ (4.7g)</option>
          <option value="cheese">èŠå£« (0.1g)</option>
          <option value="ice cream">å†°æ·‡æ·‹ (21.0g)</option>
        </optgroup>
        <optgroup label="ç”œé»/é›¶é£Ÿ">
          <option value="chocolate">å·§å…‹åŠ› (48.0g)</option>
          <option value="cake">è›‹ç³• (30.0g)</option>
          <option value="cookie">é¤…ä¹¾ (35.0g)</option>
          <option value="candy">ç³–æœ (80.0g)</option>
          <option value="honey">èœ‚èœœ (82.0g)</option>
        </optgroup>
        <optgroup label="é£²æ–™">
          <option value="soda">æ±½æ°´ (10.6g)</option>
          <option value="juice">æœæ± (9.8g)</option>
          <option value="coffee">å’–å•¡ (0.0g)</option>
          <option value="tea">èŒ¶ (0.0g)</option>
        </optgroup>
        <optgroup label="éé£Ÿç‰©">
          <option value="non-food">éé£Ÿç‰© (0.0g)</option>
        </optgroup>
      </select>
    </label>
    
    <label style="margin-top:10px">ç³–åˆ† (g/100g)
      <input id="editSugarValue" type="number" step="0.1" min="0" max="100" style="width:100%;margin-top:5px">
    </label>
    <button id="saveSugarBtn" style="background:var(--blue);color:#fff;width:100%;margin-top:15px">ç¢ºèª</button>
  </div>
</div>

<!-- ç·¨è¼¯è¨˜éŒ„çš„å½ˆçª— -->
<div id="editRecordModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ç·¨è¼¯è¨˜éŒ„</h3>
      <span class="close" data-modal="editRecordModal">&times;</span>
    </div>
    <form id="editRecordForm">
      <input type="hidden" id="editRecordId">
      <div class="form-group">
        <label>å§“å <input id="editName"></label>
      </div>
      <div class="form-group">
        <label>å¹´é½¡ <input id="editAge" type="number" min="1" max="120"></label>
      </div>
      <div class="form-group">
        <label>æ—¥æœŸ <input id="editDate" type="date" required></label>
      </div>
      <div class="form-group">
        <label>é¤æ¬¡
          <select id="editMeal"><option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option></select>
        </label>
      </div>
      <div class="form-group">
        <label>è¡€ç³– (mmol/Lï¼Œå¯ç•™ç©º)
          <input id="editSugarMmol" type="number" step="0.1" min="1" max="40">
        </label>
      </div>
      <div id="editPhotosContainer" style="margin-top:15px">
        <h4>é£Ÿç‰©ç…§ç‰‡</h4>
        <div id="editPhotosWrap" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px"></div>
      </div>
      <button type="submit" style="background:var(--blue);color:#fff;width:100%;margin-top:15px">ä¿å­˜æ›´æ”¹</button>
    </form>
  </div>
</div>

<!-- ç¢ºèªåˆªé™¤çš„å½ˆçª— -->
<div id="deleteConfirmModal" class="modal">
  <div class="modal-content" style="max-width:300px">
    <div class="modal-header">
      <h3>ç¢ºèªåˆªé™¤</h3>
      <span class="close" data-modal="deleteConfirmModal">&times;</span>
    </div>
    <p style="margin-bottom:20px">ç¢ºå®šè¦åˆªé™¤é€™æ¢è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚</p>
    <div style="display:flex;gap:10px">
      <button id="cancelDeleteBtn" style="flex:1;background:#f0f0f0;border:1px solid #ccc">å–æ¶ˆ</button>
      <button id="confirmDeleteBtn" style="flex:1;background:var(--red);color:#fff;border:0">åˆªé™¤</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
/* å…¨å±€è®Šé‡ */
const $=id=>document.getElementById(id);
const today=()=>new Date().toISOString().split('T')[0];

// Worker ç«¯é»
const WORKER_ENDPOINT = 'https://off-proxy.leisure9654.workers.dev/identify-food';

let photos=[];
let records=[];
let chart;
let chartShown=false;
let currentEditingPhotoIndex = -1;
let currentDeletingRecordId = null;
let currentPreviewImg = null;

// å¸¸è¦‹é£Ÿç‰©çš„ç³–åˆ†æ•¸æ“šåº« - ä¸­è‹±æ–‡å°ç…§
const sugarValues = {
  // ä¸»é£Ÿ/ç©€ç‰©é¡
  "rice": {name: "ç™½é£¯", sugar: 0.3},
  "white rice": {name: "ç™½é£¯", sugar: 0.3},
  "brown rice": {name: "ç³™ç±³é£¯", sugar: 0.7},
  "oatmeal": {name: "ç‡•éº¥", sugar: 0.9},
  "noodles": {name: "éºµæ¢", sugar: 0.6},
  "pasta": {name: "æ„ç²‰", sugar: 0.8},
  "bread": {name: "éºµåŒ…", sugar: 5.0},
  "corn": {name: "ç‰ç±³", sugar: 6.0},
  "potato": {name: "é¦¬éˆ´è–¯", sugar: 1.2},
  "sweet potato": {name: "ç•ªè–¯", sugar: 4.2},
  
  // è›‹ç™½è³ªé£Ÿç‰©
  "chicken": {name: "é›è‚‰", sugar: 0.0},
  "beef": {name: "ç‰›è‚‰", sugar: 0.0},
  "pork": {name: "è±¬è‚‰", sugar: 0.0},
  "fish": {name: "é­š", sugar: 0.0},
  "egg": {name: "é›è›‹", sugar: 0.4},
  "tofu": {name: "è±†è…", sugar: 0.7},
  
  // è”¬èœ
  "vegetable": {name: "è”¬èœ", sugar: 2.0},
  "vegetables": {name: "è”¬èœ", sugar: 2.0},
  "salad": {name: "æ²™æ‹‰", sugar: 2.5},
  "carrot": {name: "èƒ¡è˜¿è””", sugar: 4.7},
  "tomato": {name: "ç•ªèŒ„", sugar: 2.6},
  "broccoli": {name: "è¥¿è˜­èŠ±", sugar: 1.7},
  
  // æ°´æœ
  "fruit": {name: "æ°´æœ", sugar: 10.0},
  "fruits": {name: "æ°´æœ", sugar: 10.0},
  "apple": {name: "è˜‹æœ", sugar: 10.4},
  "banana": {name: "é¦™è•‰", sugar: 12.2},
  "orange": {name: "æ©™å­", sugar: 9.4},
  "grape": {name: "è‘¡è„", sugar: 16.0},
  "watermelon": {name: "è¥¿ç“œ", sugar: 6.2},
  
  // ä¹³è£½å“
  "milk": {name: "ç‰›å¥¶", sugar: 4.8},
  "yogurt": {name: "é…¸å¥¶", sugar: 4.7},
  "cheese": {name: "èŠå£«", sugar: 0.1},
  "ice cream": {name: "å†°æ·‡æ·‹", sugar: 21.0},
  
  // ç”œé£Ÿèˆ‡é›¶é£Ÿ
  "chocolate": {name: "å·§å…‹åŠ›", sugar: 48.0},
  "cake": {name: "è›‹ç³•", sugar: 30.0},
  "cookie": {name: "é¤…ä¹¾", sugar: 35.0},
  "candy": {name: "ç³–æœ", sugar: 80.0},
  "honey": {name: "èœ‚èœœ", sugar: 82.0},
  
  // é£²æ–™
  "soda": {name: "æ±½æ°´", sugar: 10.6},
  "juice": {name: "æœæ±", sugar: 9.8},
  "coffee": {name: "å’–å•¡", sugar: 0.0},
  "tea": {name: "èŒ¶", sugar: 0.0},
  
  // éé£Ÿç‰©
  "non-food": {name: "éé£Ÿç‰©", sugar: 0.0}
};

// è¨ˆç®—ç³–åˆ†ç¸½å’Œ
function calculateSugarSum(photoArray) {
  if (!photoArray || photoArray.length === 0) return 0;
  
  return photoArray.reduce((sum, photo) => {
    // éé£Ÿç‰©ä¸è¨ˆå…¥ç³–åˆ†ç¸½å’Œ
    if (photo.label === 'non-food') return sum;
    
    const sugarValue = parseFloat(photo.sugar) || 0;
    return sum + sugarValue;
  }, 0).toFixed(1);
}

// æ›´æ–°ç‹€æ…‹æ¶ˆæ¯
function updateStatus(msg) {
  $('statusMsg').textContent = msg;
}

// æ›´æ–°é€²åº¦æ¢
function updateAIProgress(percent) {
  const progressBar = $('aiProgressBar');
  const progressContainer = $('aiProgress');
  
  if (percent <= 0) {
    progressContainer.style.display = 'none';
    return;
  }
  
  progressContainer.style.display = 'block';
  progressBar.style.width = percent + '%';
  
  if (percent >= 100) {
    setTimeout(() => {
      progressContainer.style.display = 'none';
    }, 1000);
  }
}

// æ›´æ–°ç³–åˆ†ç¸½å’Œé¡¯ç¤º
function updateSugarSum() {
  const sum = calculateSugarSum(photos);
  $('sugarSum').textContent = sum + ' g';
  
  // åªæœ‰ç•¶æœ‰ç…§ç‰‡æ™‚æ‰é¡¯ç¤ºç¸½å’Œå€åŸŸ
  $('sugarSumContainer').style.display = photos.length > 0 ? 'flex' : 'none';
}

/* ---------- åˆå§‹åŒ– -------------------------------------- */
window.addEventListener('DOMContentLoaded', function() {
  // è¨­ç½®é»˜èªæ—¥æœŸç‚ºä»Šå¤©
  $('date').value = today();
  
  // è®€å–ä¿å­˜çš„å€‹äººä¿¡æ¯
  $('name').value = localStorage.getItem('dm_name') || '';
  $('age').value = localStorage.getItem('dm_age') || '';
  
  // åŠ è¼‰ä¿å­˜çš„è¨˜éŒ„
  loadRecords();
  
  // åˆå§‹åŒ–æ¨¡æ…‹æ¡†
  initModals();
  
  // è¨­ç½®å„ç¨®äº‹ä»¶ç›£è½å™¨
  setupEventListeners();
  
  // åˆå§‹åŒ–è¡¨å–®ç‹€æ…‹
  toggleInfo();
  
  // æ¸²æŸ“ç”¨æˆ·ç•Œé¢
  render();
  
  // æ¸¬è©¦ Worker é€£æ¥
  testWorkerConnection();
});

// æ¸¬è©¦ Worker é€£æ¥
function testWorkerConnection() {
  fetch('https://off-proxy.leisure9654.workers.dev/health')
    .then(response => {
      if (!response.ok) throw new Error('Worker é€£æ¥å¤±æ•—');
      return response.json();
    })
    .then(data => {
      console.log('Worker é€£æ¥æˆåŠŸ:', data);
    })
    .catch(error => {
      console.error('ç„¡æ³•é€£æ¥åˆ° Worker:', error);
    });
}

// åŠ è¼‰ä¿å­˜çš„è¨˜éŒ„
function loadRecords() {
  try {
    records = JSON.parse(localStorage.getItem('dm_records') || '[]');
    
    // è™•ç†èˆŠè¨˜éŒ„ï¼Œç¢ºä¿æ ¼å¼æ­£ç¢º
    records = records.map(record => {
      // ç¢ºä¿æ¯æ¢è¨˜éŒ„éƒ½æœ‰ID
      if (!record.id) {
        record.id = Date.now() + Math.floor(Math.random() * 1000);
      }
      
      // è™•ç†ç…§ç‰‡æ•¸æ“š
      if (record.photos && Array.isArray(record.photos)) {
        record.photos = record.photos.map(photo => {
          // ç¢ºä¿URLå­˜åœ¨
          const url = photo.url || photo.dataUrl || '';
          
          // è™•ç†æ¨™ç±¤å’Œç³–åˆ†æ•¸æ“š
          let label = photo.label || '';
          let sugar = photo.sugar;
          
          // ä¿®æ­£æ¨™ç±¤ï¼Œç¢ºä¿æœ‰å°æ‡‰çš„ç³–åˆ†å€¼
          if (label && sugarValues[label.toLowerCase()]) {
            const foodInfo = sugarValues[label.toLowerCase()];
            sugar = sugar || foodInfo.sugar;
          } else if (!label || label === 'é è¨­ä¼°ç®—' || label === 'è­˜åˆ¥å¤±æ•—') {
            // å°æ–¼æ²’æœ‰æ¨™ç±¤çš„ç…§ç‰‡ï¼Œçµ¦äºˆä¸€å€‹éš¨æ©Ÿä½†åˆç†çš„é£Ÿç‰©é¡å‹
            const foodKeys = Object.keys(sugarValues).filter(k => k !== 'non-food');
            const randomKey = foodKeys[Math.floor(Math.random() * foodKeys.length)];
            label = randomKey;
            sugar = sugarValues[randomKey].sugar;
          }
          
          // ç¢ºä¿æœ‰ç³–åˆ†å€¼
          if (sugar === null || sugar === undefined || isNaN(parseFloat(sugar))) {
            sugar = label && sugarValues[label.toLowerCase()] ? 
                   sugarValues[label.toLowerCase()].sugar : 5.0;
          }
          
          return {
            url,
            label,
            sugar,
            state: 'done',
            source: photo.source || 'fixed'
          };
        });
      } else {
        record.photos = [];
      }
      
      // æ·»åŠ æˆ–æ›´æ–°ç³–åˆ†ç¸½å’Œ
      record.sugarSum = calculateSugarSum(record.photos);
      
      return record;
    });
    
    // ä¿å­˜ä¿®æ­£å¾Œçš„è¨˜éŒ„
    saveRecords();
  } catch (e) {
    console.error('åŠ è¼‰è¨˜éŒ„æ™‚å‡ºéŒ¯', e);
    records = [];
  }
}

// åˆå§‹åŒ–æ¨¡æ…‹æ¡†
function initModals() {
  // é—œé–‰æŒ‰éˆ•
  document.querySelectorAll('.modal .close').forEach(closeBtn => {
    closeBtn.onclick = function() {
      const modalId = this.dataset.modal || 'editModal';
      $(modalId).style.display = 'none';
    };
  });
  
  // é—œé–‰ç…§ç‰‡é è¦½æ¨¡æ…‹æ¡†
  document.querySelector('.img-preview-close').onclick = function() {
    $('imgPreviewModal').style.display = 'none';
  };
  
  // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
  window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
      event.target.style.display = 'none';
    }
    if (event.target.classList.contains('img-preview-modal')) {
      event.target.style.display = 'none';
    }
  };
  
  // é£Ÿç‰©é¸æ“‡ä¸‹æ‹‰æ¡†äº‹ä»¶
  $('foodTypeSelect').onchange = function() {
    const selectedFood = this.value;
    if (selectedFood && sugarValues[selectedFood]) {
      $('editSugarValue').value = sugarValues[selectedFood].sugar;
    }
  };
  
  // ç·¨è¼¯è¨˜éŒ„è¡¨å–®
  $('editRecordForm').onsubmit = function(e) {
    e.preventDefault();
    saveEditedRecord();
  };
  
  // åˆªé™¤ç¢ºèª
  $('cancelDeleteBtn').onclick = function() {
    $('deleteConfirmModal').style.display = 'none';
  };
  
  $('confirmDeleteBtn').onclick = function() {
    if (currentDeletingRecordId) {
      deleteRecord(currentDeletingRecordId);
      $('deleteConfirmModal').style.display = 'none';
    }
  };
}

// è¨­ç½®äº‹ä»¶ç›£è½å™¨
function setupEventListeners() {
  // å€‹äººè³‡æ–™é¡¯ç¤ºåˆ‡æ›
  $('showInfo').onchange = toggleInfo;
  
  // ä¸»åˆ†é åˆ‡æ›
  $('tabAdd').onclick = () => switchTab(true);
  $('tabList').onclick = () => switchTab(false);
  
  // å­åˆ†é åˆ‡æ›
  $('tabL').onclick = () => sub(true);
  $('tabC').onclick = () => sub(false);
  
  // ç…§ç‰‡æ‹æ”å’Œä¸Šå‚³
  $('camBtn').onclick = () => $('camIn').click();
  $('fileBtn').onclick = () => $('fileIn').click();
  
  $('camIn').onchange = e => {
    addFiles(e.target.files);
    e.target.value = '';
  };
  
  $('fileIn').onchange = e => {
    addFiles(e.target.files);
    e.target.value = '';
  };
  
  // åœ–è¡¨é¡¯ç¤ºåˆ‡æ›
  $('monthPick').onchange = render;
  $('chartBtn').onclick = toggleChart;
  
  // è¡¨å–®æäº¤
  $('form').onsubmit = saveNewRecord;
  
  // ä¿å­˜ç³–åˆ†æŒ‰éˆ•
  $('saveSugarBtn').onclick = function() {
    if (currentEditingPhotoIndex >= 0 && currentEditingPhotoIndex < photos.length) {
      const selectedFood = $('foodTypeSelect').value;
      const value = parseFloat($('editSugarValue').value);
      
      if (selectedFood) {
        photos[currentEditingPhotoIndex].label = selectedFood;
        // å¦‚æœæœ‰å°æ‡‰çš„ç³–åˆ†æ•¸æ“šï¼Œä½¿ç”¨å®ƒ
        if (sugarValues[selectedFood] && !isNaN(sugarValues[selectedFood].sugar)) {
          photos[currentEditingPhotoIndex].sugar = sugarValues[selectedFood].sugar;
        }
      }
      
      if (!isNaN(value)) {
        photos[currentEditingPhotoIndex].sugar = value;
      }
      
      photos[currentEditingPhotoIndex].state = 'done';
      photos[currentEditingPhotoIndex].manual = true;
      renderPhotos(); // é‡æ–°æ¸²æŸ“ç…§ç‰‡
      updateSugarSum(); // æ›´æ–°ç³–åˆ†ç¸½å’Œ
    }
    $('editModal').style.display = 'none';
  };
}

// åˆ‡æ›å€‹äººè³‡æ–™é¡¯ç¤º
function toggleInfo() {
  const s = $('showInfo').checked;
  document.querySelector('.personal').style.display = s ? 'block' : 'none';
  $('name').required = $('age').required = s;
}

// åˆ‡æ›ä¸»åˆ†é 
function switchTab(add) {
  $('tabAdd').classList.toggle('active', add);
  $('tabList').classList.toggle('active', !add);
  $('addSec').classList.toggle('active', add);
  $('listSec').classList.toggle('active', !add);
  
  if (!add) render();
}

// åˆ‡æ›å­åˆ†é 
function sub(l) {
  $('tabL').classList.toggle('active', l);
  $('tabC').classList.toggle('active', !l);
  $('listBox').style.display = l ? 'block' : 'none';
  $('calBox').style.display = l ? 'none' : 'block';
}

// åˆ‡æ›åœ–è¡¨é¡¯ç¤º
function toggleChart() {
  chartShown = !chartShown;
  $('chartBtn').textContent = chartShown ? 'éš±è—åœ–è¡¨' : 'åˆ†æåœ–è¡¨';
  document.querySelector('.chartWrap').style.display = chartShown ? 'block' : 'none';
  if (chartShown) renderChart();
}

/* ---------- ç…§ç‰‡è™•ç† ---------------------------------- */
// æ·»åŠ ç…§ç‰‡æ–‡ä»¶
async function addFiles(fs) {
  if (!fs || !fs.length) return;
  
  for (const f of fs) {
    if (!f.type.startsWith('image/')) continue;
    
    try {
      const url = URL.createObjectURL(f);
      
      // å‰µå»ºä¸€å€‹æ–°çš„ç…§ç‰‡å°è±¡
      const photo = {
        url,
        state: 'loading',
        sugar: null,
        file: f.name,
        label: '',
        source: 'waiting'
      };
      
      photos.push(photo);
      renderPhotos();
      
      // ä½¿ç”¨ Worker è­˜åˆ¥ç…§ç‰‡
      identifyFoodWithWorker(photo, photos.length - 1);
    } catch (e) {
      console.error('è™•ç†åœ–ç‰‡æ™‚å‡ºéŒ¯', e);
      updateStatus('è™•ç†åœ–ç‰‡å‡ºéŒ¯: ' + e.message);
    }
  }
}

// è™•ç† Worker è­˜åˆ¥çµæœ
async function identifyFoodWithWorker(photo, index) {
  updateStatus('æ­£åœ¨åˆ†æç…§ç‰‡...');
  updateAIProgress(10);
  
  try {
    // å¾ URL ç²å– Blob æ•¸æ“š
    const response = await fetch(photo.url);
    const blob = await response.blob();
    
    // æº–å‚™è¡¨å–®æ•¸æ“š
    const formData = new FormData();
    formData.append('image', blob, 'food_image.jpg');
    
    updateAIProgress(30);
    
    // ç™¼é€åˆ° Worker é€²è¡Œè­˜åˆ¥
    console.log('ç™¼é€åœ–åƒåˆ° Worker é€²è¡Œè­˜åˆ¥...');
    const workerResponse = await fetch(WORKER_ENDPOINT, {
      method: 'POST',
      body: formData
    });
    
    updateAIProgress(60);
    
    if (!workerResponse.ok) {
      throw new Error('Worker API è«‹æ±‚å¤±æ•—: ' + workerResponse.status);
    }
    
    // è§£æçµæœ
    const result = await workerResponse.json();
    console.log('Worker å›å‚³çµæœ:', result);
    
    updateAIProgress(80);
    
    if (!result.success || result.error) {
      throw new Error(result.error || 'è­˜åˆ¥å¤±æ•—');
    }
    
    // è™•ç†è­˜åˆ¥çµæœ
    if (result.predictions && result.predictions.length > 0) {
      // ç²å–æœ€å¯èƒ½çš„é£Ÿç‰©é¡å‹
      const topPrediction = result.predictions[0];
      
      // æª¢æŸ¥æ˜¯å¦æœ‰ä¸­æ–‡åç¨±
      const foodLabel = topPrediction.label;
      const foodName = topPrediction.chineseName || sugarValues[foodLabel]?.name || foodLabel;
      
      // ç¢ºèªæ˜¯å¦ç‚ºé£Ÿç‰©
      if (foodLabel === 'non-food') {
        photo.label = 'non-food';
        photo.sugar = 0;
      } else {
        // æ˜ å°„åˆ°æˆ‘å€‘çš„é£Ÿç‰©é¡åˆ¥
        let foodType = foodLabel;
        
        // ç¢ºä¿çµæœæ˜¯æˆ‘å€‘æ”¯æŒçš„é£Ÿç‰©é¡å‹
        if (!sugarValues[foodType]) {
          // å˜—è©¦ä½¿ç”¨é¡ä¼¼çš„é£Ÿç‰©é¡å‹
          const similarFoods = findSimilarFoodTypes(foodType, result.features);
          if (similarFoods.length > 0) {
            foodType = similarFoods[0];
          } else {
            foodType = 'rice'; // é»˜èªå€¼
          }
        }
        
        photo.label = foodType;
        photo.sugar = sugarValues[foodType].sugar;
      }
      
      photo.state = 'done';
      photo.source = 'cloudflare-worker';
      photo.predictions = result.predictions;
      photo.features = result.features;
      
      renderPhotos();
      updateSugarSum();
      updateAIProgress(100);
      
      updateStatus(`å·²è­˜åˆ¥ç‚º ${foodName}ï¼Œé»æ“Šç…§ç‰‡å¯ç·¨è¼¯`);
    } else {
      throw new Error('ç„¡æœ‰æ•ˆçš„è­˜åˆ¥çµæœ');
    }
  } catch (e) {
    console.error('Worker è­˜åˆ¥å¤±æ•—', e);
    updateAIProgress(85);
    
    // å¤±æ•—æ™‚ä½¿ç”¨æœ¬åœ°è­˜åˆ¥æ–¹æ³•ä½œç‚ºå‚™ä»½
    try {
      await identifyFoodInImage(photo, index);
    } catch (err) {
      console.error('æœ¬åœ°è­˜åˆ¥ä¹Ÿå¤±æ•—', err);
      // å…©ç¨®æ–¹å¼éƒ½å¤±æ•—ï¼Œè¨­ç½®é»˜èªå€¼
      photo.state = 'done';
      photo.label = 'rice'; // é è¨­å€¼
      photo.sugar = sugarValues['rice'].sugar;
      photo.source = 'fallback';
      renderPhotos();
      updateSugarSum();
      
      // å½ˆå‡ºç·¨è¼¯çª—å£è®“ç”¨æˆ¶é¸æ“‡æ­£ç¢ºçš„é£Ÿç‰©é¡å‹
      openEditModal(null, index);
    }
    updateAIProgress(100);
  }
}

// æ‰¾åˆ°ç›¸ä¼¼çš„é£Ÿç‰©é¡å‹
function findSimilarFoodTypes(foodType, features) {
  // åŸºæ–¼ä¸»è¦é¡è‰²å°‹æ‰¾ç›¸ä¼¼é£Ÿç‰©
  const dominantColor = features?.dominantColor || { r: 128, g: 128, b: 128 };
  const { r, g, b } = dominantColor;
  
  // å¸¸è¦‹é£Ÿç‰©é¡å‹åˆ—è¡¨
  const commonFoods = Object.keys(sugarValues);
  
  // ç°¡å–®çš„é¡è‰²åŒ¹é…é‚è¼¯
  let matchingFoods = [];
  
  // ç™½è‰²/æ·ºè‰² (ç±³é£¯ï¼Œéºµé£Ÿ)
  if (r > 180 && g > 180 && b > 180) {
    matchingFoods = ['rice', 'noodles', 'bread'].filter(f => commonFoods.includes(f));
  } 
  // ç´…è‰²/æ©™è‰² (è˜‹æœï¼Œèƒ¡è˜¿è””)
  else if (r > 150 && g < 150 && b < 100) {
    matchingFoods = ['apple', 'carrot'].filter(f => commonFoods.includes(f));
  }
  // ç¶ è‰² (è”¬èœï¼Œæ²™æ‹‰)
  else if (g > r && g > b) {
    matchingFoods = ['vegetable', 'salad'].filter(f => commonFoods.includes(f));
  }
  // é»ƒè‰²/æ©™è‰² (é¦™è•‰ï¼Œæ©™å­)
  else if (r > 180 && g > 150 && b < 100) {
    matchingFoods = ['banana', 'orange'].filter(f => commonFoods.includes(f));
  }
  // è¤è‰² (éºµåŒ…ï¼Œé¤…ä¹¾)
  else if (r > 100 && g > 80 && r > b && g > b) {
    matchingFoods = ['bread', 'cookie'].filter(f => commonFoods.includes(f));
  }
  // å…¶ä»–æƒ…æ³ï¼Œè¿”å›ä¸€äº›å¸¸è¦‹é£Ÿç‰©
  else {
    matchingFoods = ['rice', 'vegetable', 'apple'].filter(f => commonFoods.includes(f));
  }
  
  return matchingFoods;
}

// åŸå§‹çš„æœ¬åœ°é£Ÿç‰©è­˜åˆ¥å‡½æ•¸ - ä½œç‚ºå‚™ä»½
async function identifyFoodInImage(photo, index) {
  updateStatus('ä½¿ç”¨æœ¬åœ°è­˜åˆ¥æ–¹æ³•...');
  
  try {
    // åŠ è¼‰åœ–åƒ
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.src = photo.url;
    
    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
      setTimeout(resolve, 3000); // åœ–åƒåŠ è¼‰è¶…æ™‚ï¼Œé¿å…ç„¡é™ç­‰å¾…
    });
    
    // å‰µå»ºç•«å¸ƒé€²è¡Œåœ–åƒåˆ†æ
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = Math.min(img.width, 300); // é™åˆ¶å¤§å°ä»¥åŠ å¿«è™•ç†é€Ÿåº¦
    canvas.height = Math.min(img.height, 300);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    
    // ç²å–åœ–åƒæ•¸æ“š
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    
    // ä½¿ç”¨å¢å¼·ç‰ˆé¡è‰²å’Œç‰¹å¾µåˆ†æè­˜åˆ¥é£Ÿç‰©
    const colorFeatures = analyzeColorFeatures(imageData);
    const shapeFeatures = analyzeShapeFeatures(imageData);
    const fileNameHint = guessFromFileName(photo.file);
    
    // çµåˆæ‰€æœ‰ç‰¹å¾µåšå‡ºè­˜åˆ¥æ±ºç­–
    const detectedFood = combinedFoodDecision(colorFeatures, fileNameHint, shapeFeatures);
    
    if (detectedFood) {
      // è¨­ç½®ç…§ç‰‡ä¿¡æ¯
      photo.label = detectedFood;
      photo.sugar = sugarValues[detectedFood].sugar;
      photo.state = 'done';
      photo.source = 'local-detection';
      
      renderPhotos();
      updateSugarSum();
      
      // æç¤ºç”¨æˆ¶æŸ¥çœ‹å’Œç·¨è¼¯è­˜åˆ¥çµæœ
      updateStatus(`å·²è­˜åˆ¥ç‚º ${sugarValues[detectedFood].name}ï¼Œé»æ“Šç…§ç‰‡å¯ç·¨è¼¯`);
      return true;
    } else {
      throw new Error('ç„¡æ³•ç¢ºå®šé£Ÿç‰©é¡å‹');
    }
  } catch (e) {
    console.error('æœ¬åœ°åœ–åƒè­˜åˆ¥å¤±æ•—', e);
    throw e;
  }
}

// åˆ†æé¡è‰²ç‰¹å¾µä»¥è­˜åˆ¥é£Ÿç‰©
function analyzeColorFeatures(imageData) {
  const data = imageData.data;
  const width = imageData.width;
  const height = imageData.height;
  const step = 4; // æ¯åƒç´ 4å€‹å€¼(RGBA)
  
  // æ”¶é›†é¡è‰²çµ±è¨ˆ
  let redSum = 0, greenSum = 0, blueSum = 0;
  let redVariance = 0, greenVariance = 0, blueVariance = 0;
  let pixelCount = 0;
  
  // è¨ˆç®—å¹³å‡é¡è‰²
  for (let y = 0; y < height; y += 2) { // å–æ¨£ä»¥åŠ å¿«é€Ÿåº¦
    for (let x = 0; x < width; x += 2) {
      const i = (y * width + x) * 4;
      redSum += data[i];
      greenSum += data[i + 1];
      blueSum += data[i + 2];
      pixelCount++;
    }
  }
  
  const redAvg = redSum / pixelCount;
  const greenAvg = greenSum / pixelCount;
  const blueAvg = blueSum / pixelCount;
  
  // è¨ˆç®—é¡è‰²æ–¹å·®ä»¥äº†è§£é¡è‰²åˆ†ä½ˆ
  for (let y = 0; y < height; y += 2) {
    for (let x = 0; x < width; x += 2) {
      const i = (y * width + x) * 4;
      redVariance += Math.pow(data[i] - redAvg, 2);
      greenVariance += Math.pow(data[i + 1] - greenAvg, 2);
      blueVariance += Math.pow(data[i + 2] - blueAvg, 2);
    }
  }
  
  redVariance /= pixelCount;
  greenVariance /= pixelCount;
  blueVariance /= pixelCount;
  
  // åˆ†æé¡è‰²å€åŸŸåˆ†ä½ˆ
  const colorZones = analyzeColorZones(imageData);
  
  // è¿”å›é¡è‰²ç‰¹å¾µ
  return {
    averageColor: { r: redAvg, g: greenAvg, b: blueAvg },
    colorVariance: { r: redVariance, g: greenVariance, b: blueVariance },
    colorZones
  };
}

// åˆ†æåœ–åƒä¸­çš„é¡è‰²å€åŸŸåˆ†ä½ˆ
function analyzeColorZones(imageData) {
  const data = imageData.data;
  const width = imageData.width;
  const height = imageData.height;
  
  // å°‡åœ–åƒåˆ†ç‚º4å€‹å€åŸŸï¼Œè¨ˆç®—æ¯å€‹å€åŸŸçš„ä¸»è¦é¡è‰²
  const zones = [];
  const zoneWidth = Math.floor(width / 2);
  const zoneHeight = Math.floor(height / 2);
  
  for (let zoneY = 0; zoneY < 2; zoneY++) {
    for (let zoneX = 0; zoneX < 2; zoneX++) {
      let redSum = 0, greenSum = 0, blueSum = 0;
      let pixelCount = 0;
      
      const startX = zoneX * zoneWidth;
      const startY = zoneY * zoneHeight;
      const endX = startX + zoneWidth;
      const endY = startY + zoneHeight;
      
      for (let y = startY; y < endY; y += 2) {
        for (let x = startX; x < endX; x += 2) {
          const i = (y * width + x) * 4;
          redSum += data[i];
          greenSum += data[i + 1];
          blueSum += data[i + 2];
          pixelCount++;
        }
      }
      
      if (pixelCount > 0) {
        zones.push({
          x: zoneX,
          y: zoneY,
          color: {
            r: redSum / pixelCount,
            g: greenSum / pixelCount,
            b: blueSum / pixelCount
          }
        });
      }
    }
  }
  
  return zones;
}

// åˆ†æå½¢ç‹€å’Œç´‹ç†ç‰¹å¾µ
function analyzeShapeFeatures(imageData) {
  const data = imageData.data;
  const width = imageData.width;
  const height = imageData.height;
  
  // è¨ˆç®—é‚Šç·£å¯†åº¦ (ç´‹ç†è¤‡é›œåº¦çš„ç°¡å–®åº¦é‡)
  let edgeCount = 0;
  const threshold = 30; // é‚Šç·£æª¢æ¸¬é–¾å€¼
  
  for (let y = 1; y < height - 1; y += 2) {
    for (let x = 1; x < width - 1; x += 2) {
      const i = (y * width + x) * 4;
      const top = ((y - 1) * width + x) * 4;
      const bottom = ((y + 1) * width + x) * 4;
      const left = (y * width + (x - 1)) * 4;
      const right = (y * width + (x + 1)) * 4;
      
      // ç°¡å–®çš„é‚Šç·£æª¢æ¸¬
      const diffH = Math.abs(data[left] - data[right]) + 
                    Math.abs(data[left + 1] - data[right + 1]) + 
                    Math.abs(data[left + 2] - data[right + 2]);
                    
      const diffV = Math.abs(data[top] - data[bottom]) + 
                    Math.abs(data[top + 1] - data[bottom + 1]) + 
                    Math.abs(data[top + 2] - data[bottom + 2]);
                    
      if (diffH > threshold || diffV > threshold) {
        edgeCount++;
      }
    }
  }
  
  const edgeDensity = edgeCount / ((width * height) / 4); // æ­¸ä¸€åŒ–
  
  // å½¢ç‹€è¿‘ä¼¼ (é€šéæª¢æ¸¬åœ“å½¢å’Œç›´ç·šç­‰ç‰¹æ€§)
  // é€™è£¡åšä¸€å€‹ç°¡å–®çš„åœ“å½¢æª¢æ¸¬ï¼Œé©ç”¨æ–¼æª¢æ¸¬è˜‹æœç­‰æ°´æœ
  
  let centerX = width / 2;
  let centerY = height / 2;
  let roundnessScore = 0;
  let maxDistance = Math.sqrt(Math.pow(width/2, 2) + Math.pow(height/2, 2));
  let samplePoints = 0;
  
  // æª¢æ¸¬é‚Šç·£çš„åœ“å½¢åº¦
  for (let angle = 0; angle < 360; angle += 10) {
    const radians = angle * Math.PI / 180;
    for (let dist = 0.5; dist <= 1.0; dist += 0.1) {
      const x = Math.round(centerX + Math.cos(radians) * (width/2) * dist);
      const y = Math.round(centerY + Math.sin(radians) * (height/2) * dist);
      
      if (x >= 0 && x < width && y >= 0 && y < height) {
        const i = (y * width + x) * 4;
        
        // æª¢æŸ¥é€™å€‹é»æ˜¯å¦æ˜¯é‚Šç·£é»
        const neighbors = [
          ((y-1) * width + x) * 4,
          ((y+1) * width + x) * 4,
          (y * width + (x-1)) * 4,
          (y * width + (x+1)) * 4
        ];
        
        let isEdge = false;
        for (const ni of neighbors) {
          if (ni >= 0 && ni < data.length) {
            const diff = Math.abs(data[i] - data[ni]) + 
                          Math.abs(data[i+1] - data[ni+1]) + 
                          Math.abs(data[i+2] - data[ni+2]);
            if (diff > threshold) {
              isEdge = true;
              break;
            }
          }
        }
        
        if (isEdge) {
          const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
          const expectedDistance = (width + height) / 4; // ç†æƒ³åœ“çš„åŠå¾‘
          roundnessScore += 1 - Math.abs(distance - expectedDistance) / expectedDistance;
          samplePoints++;
        }
      }
    }
  }
  
  // æ­¸ä¸€åŒ–åœ“å½¢åº¦åˆ†æ•¸
  roundnessScore = samplePoints > 0 ? roundnessScore / samplePoints : 0;
  
  // è¿”å›å½¢ç‹€å’Œç´‹ç†ç‰¹å¾µ
  return {
    edgeDensity,
    roundnessScore,
    width,
    height,
    aspectRatio: width / height
  };
}

// å¾æ–‡ä»¶åçŒœæ¸¬é£Ÿç‰©é¡å‹
function guessFromFileName(fileName) {
  if (!fileName) return null;
  
  const lowerName = fileName.toLowerCase();
  
  // ç°¡å–®çš„é—œéµè©åŒ¹é…
  if (lowerName.includes('apple') || lowerName.includes('è˜‹æœ')) return 'apple';
  if (lowerName.includes('rice') || lowerName.includes('é£¯') || lowerName.includes('ç±³')) return 'rice';
  if (lowerName.includes('bread') || lowerName.includes('éºµåŒ…')) return 'bread';
  if (lowerName.includes('corn') || lowerName.includes('ç‰ç±³')) return 'corn';
  if (lowerName.includes('vegetable') || lowerName.includes('è”¬èœ')) return 'vegetable';
  if (lowerName.includes('chocolate') || lowerName.includes('å·§å…‹åŠ›')) return 'chocolate';
  if (lowerName.includes('banana') || lowerName.includes('é¦™è•‰')) return 'banana';
  
  return null;
}

// çµåˆæ‰€æœ‰ç‰¹å¾µåšå‡ºæœ€çµ‚æ±ºç­–
function combinedFoodDecision(colorFeatures, fileNameHint, shapeFeatures) {
  // 1. å¦‚æœæ–‡ä»¶åæœ‰æ˜ç¢ºæç¤ºï¼Œå„ªå…ˆæ¡ç”¨
  if (fileNameHint) return fileNameHint;
  
  // 2. æ ¹æ“šé¡è‰²ç‰¹å¾µè­˜åˆ¥
  const averageColor = colorFeatures.averageColor;
  const { r, g, b } = averageColor;
  
  // è˜‹æœç‰¹å¾µæª¢æ¸¬ - ç´…è‰²æˆ–ç¶ è‰²ï¼Œé«˜åœ“å½¢åº¦
  if (((r > 150 && g < 100 && b < 100) || (r < 120 && g > 150 && b < 100)) && 
      shapeFeatures.roundnessScore > 0.6) {
    return 'apple';
  }
  
  // ç™½é£¯ç‰¹å¾µæª¢æ¸¬ - ç™½è‰²/æ·ºè‰²ï¼Œç´‹ç†å‡å‹»
  if (r > 180 && g > 180 && b > 180 && colorFeatures.colorVariance.r < 1000) {
    return 'rice';
  }
  
  // ç‰ç±³ç‰¹å¾µæª¢æ¸¬ - é»ƒè‰²ï¼Œç´‹ç†ä¸­ç­‰
  if (r > 180 && g > 150 && b < 100 && colorFeatures.colorVariance.r > 1000) {
    return 'corn';
  }
  
  // è”¬èœç‰¹å¾µæª¢æ¸¬ - ç¶ è‰²ç³»ï¼Œè¼ƒé«˜é‚Šç·£å¯†åº¦
  if (g > r && g > b && shapeFeatures.edgeDensity > 0.1) {
    return 'vegetable';
  }
  
  // å·§å…‹åŠ›ç‰¹å¾µæª¢æ¸¬ - æ·±è¤è‰²
  if (r > 100 && r < 150 && g < 100 && b < 80) {
    return 'chocolate';
  }
  
  // ä¾æ“šå¹³å‡é¡è‰²åšé€²ä¸€æ­¥åˆ¤æ–·
  if (r > 200 && g > 200 && b > 200) return 'rice'; // ç™½è‰²ç³»
  if (r > 180 && g > 150 && b < 110) return 'corn'; // é»ƒè‰²ç³»
  if (r > 150 && g < 100 && b < 100) return 'apple'; // ç´…è‰²ç³»
  if (r < 100 && g > 120 && b < 100) return 'vegetable'; // ç¶ è‰²ç³»
  if (r < 80 && g < 80 && b < 80) return 'chocolate'; // æ·±è‰²ç³»
  
  // 3. çµåˆå½¢ç‹€ç‰¹å¾µåšé€²ä¸€æ­¥åˆ¤æ–·
  
  // åœ“å½¢åº¦é«˜çš„å¯èƒ½æ˜¯è˜‹æœæˆ–å…¶ä»–æ°´æœ
  if (shapeFeatures.roundnessScore > 0.7) {
    if (r > g && r > b) return 'apple'; // åç´…çš„åœ“å½¢ç‰©é«”
    if (g > r && g > b) return 'apple'; // åç¶ çš„åœ“å½¢ç‰©é«”
    return 'fruit';
  }
  
  // é‚Šç·£å¯†åº¦ä½ï¼Œé¡è‰²å‡å‹»çš„å¯èƒ½æ˜¯ç±³é£¯
  if (shapeFeatures.edgeDensity < 0.05 && 
      colorFeatures.colorVariance.r < 500 && 
      colorFeatures.colorVariance.g < 500 && 
      colorFeatures.colorVariance.b < 500) {
    return 'rice';
  }
  
  // é‚Šç·£å¯†åº¦å¾ˆé«˜çš„å¯èƒ½æ˜¯è”¬èœæˆ–è‚‰é¡
  if (shapeFeatures.edgeDensity > 0.2) {
    if (g > r && g > b) return 'vegetable';
    if (r > g && r > b) return 'meat';
  }
  
  // é¡è‰²å€åŸŸåˆ†æ - æª¢æ¸¬é¡è‰²æ˜¯å¦é›†ä¸­æˆ–åˆ†æ•£
  let colorZoneVariance = 0;
  const zones = colorFeatures.colorZones;
  if (zones.length > 0) {
    let zoneRedSum = 0, zoneGreenSum = 0, zoneBlueSum = 0;
    zones.forEach(zone => {
      zoneRedSum += zone.color.r;
      zoneGreenSum += zone.color.g;
      zoneBlueSum += zone.color.b;
    });
    
    const zoneRedAvg = zoneRedSum / zones.length;
    const zoneGreenAvg = zoneGreenSum / zones.length;
    const zoneBlueAvg = zoneBlueSum / zones.length;
    
    zones.forEach(zone => {
      colorZoneVariance += Math.pow(zone.color.r - zoneRedAvg, 2);
      colorZoneVariance += Math.pow(zone.color.g - zoneGreenAvg, 2);
      colorZoneVariance += Math.pow(zone.color.b - zoneBlueAvg, 2);
    });
    
    colorZoneVariance /= zones.length * 3;
    
    // é¡è‰²å€åŸŸè®ŠåŒ–å¾ˆå¤§å¯èƒ½æ˜¯æ··åˆé£Ÿç‰©
    if (colorZoneVariance > 2000) {
      if (g > r && g > b) return 'vegetable';
      if (r > 150 && g > 100 && b < 100) return 'fruit';
    }
  }
  
  // é»˜èªè¿”å›æœ€ä½³çŒœæ¸¬
  // ä½¿ç”¨é¡è‰²ä½œç‚ºæœ€å¾Œæ±ºç­–ä¾æ“š
  const redGreenRatio = r / (g + 0.1); // é˜²æ­¢é™¤ä»¥é›¶
  const redBlueRatio = r / (b + 0.1);
  const greenRedRatio = g / (r + 0.1);
  
  if (redGreenRatio > 1.5 && redBlueRatio > 1.5) return 'apple'; // ç´…è‰²å¼·å‹¢
  if (greenRedRatio > 1.3) return 'vegetable'; // ç¶ è‰²å¼·å‹¢
  if (r > 200 && g > 180 && b < 100) return 'corn'; // é»ƒè‰²
  if (r > 180 && g > 180 && b > 180) return 'rice'; // ç™½è‰²
  
  return 'rice'; // é»˜èªå€¼
}

/* ---------- ç…§ç‰‡æ“ä½œ ---------------------------------- */
// ç…§ç‰‡é è¦½è™•ç†å‡½æ•¸
function handlePhotoPreview(index) {
  if (index < 0 || index >= photos.length) return;
  openPreviewModal(photos[index], index);
}

// åˆªé™¤ç…§ç‰‡åŠŸèƒ½ï¼Œé˜»æ­¢å†’æ³¡
function deletePhoto(event, index) {
  event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°é è¦½
  photos.splice(index, 1);
  renderPhotos();
  updateSugarSum();
}

// æ‰“é–‹ç·¨è¼¯æ¨¡æ…‹æ¡†ï¼Œé˜»æ­¢å†’æ³¡
function openEditModal(event, index) {
  if (event) {
    event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°é è¦½
  }
  
  if (index < 0 || index >= photos.length) return;
  
  const photo = photos[index];
  currentEditingPhotoIndex = index;
  
  // è¨­ç½®åœ–ç‰‡
  $('editImage').src = photo.url;
  
  // è¨­ç½®åˆ†æçµæœèªªæ˜
  if (photo.source === 'cloudflare-worker') {
    $('aiResult').textContent = `é›²ç«¯è­˜åˆ¥ç‚º: ${sugarValues[photo.label]?.name || photo.label}`;
  } else if (photo.source === 'local-detection' || photo.source === 'advanced-detection') {
    $('aiResult').textContent = `æœ¬åœ°è­˜åˆ¥ç‚º: ${sugarValues[photo.label]?.name || photo.label}`;
  } else {
    $('aiResult').textContent = '';
  }
  
  // è¨­ç½®ä¸‹æ‹‰æ¡†
  $('foodTypeSelect').value = photo.label || '';
  
  // è¨­ç½®ç³–åˆ†å€¼
  $('editSugarValue').value = photo.sugar || '';
  
  // é¡¯ç¤ºæ¨¡æ…‹æ¡†
  $('editModal').style.display = 'block';
}

// æ‰“é–‹ç…§ç‰‡é è¦½æ¨¡æ…‹æ¡†
function openPreviewModal(photo, index) {
  $('previewImg').src = photo.url;
  
  // è¨­ç½®æ¨™é¡Œ
  let caption = '';
  if (photo.label === 'non-food') {
    caption = 'éé£Ÿç‰© (0 g ç³–åˆ†)';
  } else if (photo.label && sugarValues[photo.label]) {
    caption = `${sugarValues[photo.label].name}: ${photo.sugar} g ç³–åˆ†/100g`;
  } else {
    caption = `ç³–åˆ†: ${photo.sugar} g/100g`;
  }
  $('previewCaption').textContent = caption;
  
  // æ·»åŠ ç·¨è¼¯åŠŸèƒ½
  if (index !== undefined) {
    $('previewEditBtn').style.display = 'block';
    $('previewEditBtn').onclick = function() {
      $('imgPreviewModal').style.display = 'none';
      openEditModal(null, index);
    };
  } else {
    $('previewEditBtn').style.display = 'none';
  }
  
  // é¡¯ç¤ºæ¨¡æ…‹æ¡†
  $('imgPreviewModal').style.display = 'block';
}

// æ¸²æŸ“ç…§ç‰‡ç¸®åœ–
function renderPhotos() {
  $('photosWrap').innerHTML = photos.map((p, i) => {
    let displayName = 'è¼‰å…¥ä¸­...';
    let displaySugar = '';
    
    if (p.state === 'done') {
      if (p.label === 'non-food') {
        displayName = 'éé£Ÿç‰©';
        displaySugar = '0 g';
      } else if (p.label && sugarValues[p.label]) {
        displayName = sugarValues[p.label].name;
        displaySugar = p.sugar + ' g';
      } else {
        displayName = p.label || 'æœªçŸ¥';
        displaySugar = p.sugar + ' g';
      }
    } else if (p.state === 'fail') {
      displayName = 'è­˜åˆ¥å¤±æ•—';
    }
    
    return `
    <div class="photo" data-index="${i}" onclick="handlePhotoPreview(${i})">
      <img src="${p.url}" alt="é£Ÿç‰©ç…§ç‰‡">
      <em>${p.state === 'loading' ? 'â³ è­˜åˆ¥ä¸­...' : displayName + '<br>' + displaySugar}</em>
      <span data-idx="${i}" onclick="deletePhoto(event, ${i})">âœ–</span>
      <span class="edit-sugar" data-edit="${i}" onclick="openEditModal(event, ${i})">âœï¸</span>
    </div>`;
  }).join('');
  
  // æ›´æ–°ç³–åˆ†ç¸½å’Œ
  updateSugarSum();
}

/* ---------- è¨˜éŒ„ç®¡ç† ---------------------------------- */
// ä¿å­˜æ–°è¨˜éŒ„
function saveNewRecord(e) {
  e.preventDefault();
  
  if (photos.some(p => p.state === 'loading')) {
    alert('ç›¸ç‰‡ä»åœ¨åˆ†æä¸­ï¼Œè«‹ç¨å€™');
    return;
  }
  
  // ä¿å­˜å€‹äººè³‡æ–™
  localStorage.setItem('dm_name', $('name').value.trim());
  localStorage.setItem('dm_age', $('age').value.trim());
  
  // æº–å‚™ç…§ç‰‡æ•¸æ“š
  const photoData = photos.map(p => ({
    url: p.url,
    state: 'done',
    sugar: p.sugar || 5.0,
    label: p.label || 'unknown',
    manual: p.manual || false,
    source: p.source || 'manual'
  }));
  
  // å‰µå»ºæ–°è¨˜éŒ„
  const newRecord = {
    id: Date.now(),
    name: $('name').value.trim(),
    age: $('age').value.trim(),
    date: $('date').value,
    meal: $('meal').value,
    sugarMmol: parseFloat($('sugarMmol').value) || null,
    photos: photoData,
    timestamp: new Date().toISOString(),
    sugarSum: calculateSugarSum(photoData) // ä¿å­˜ç³–åˆ†ç¸½å’Œ
  };
  
  // æ·»åŠ åˆ°è¨˜éŒ„åˆ—è¡¨
  records.unshift(newRecord);
  
  // ä¿å­˜è¨˜éŒ„
  if (saveRecords()) {
    alert('è¨˜éŒ„å·²æˆåŠŸå„²å­˜');
    
    // é‡ç½®è¡¨å–®
    $('sugarMmol').value = '';
    $('date').value = today();
    photos = [];
    renderPhotos();
    render();
  }
}

// ä¿å­˜è¨˜éŒ„åˆ°localStorage
function saveRecords() {
  try {
    localStorage.setItem('dm_records', JSON.stringify(records));
    return true;
  } catch (e) {
    console.error('ä¿å­˜è¨˜éŒ„å¤±æ•—', e);
    alert('è¨˜éŒ„ä¿å­˜å¤±æ•—ï¼š' + e.message);
    return false;
  }
}

// ç·¨è¼¯è¨˜éŒ„
function editRecord(recordId) {
  const record = records.find(r => r.id == recordId);
  if (!record) return;
  
  $('editRecordId').value = record.id;
  $('editName').value = record.name || '';
  $('editAge').value = record.age || '';
  $('editDate').value = record.date;
  $('editMeal').value = record.meal;
  $('editSugarMmol').value = record.sugarMmol || '';
  
  // é¡¯ç¤ºç…§ç‰‡
  let photosHtml = '';
  if (record.photos && record.photos.length) {
    photosHtml = record.photos.map((p, idx) => {
      let displayName = '';
      
      if (p.label === 'non-food') {
        displayName = 'éé£Ÿç‰©';
      } else if (p.label && sugarValues[p.label]) {
        displayName = sugarValues[p.label].name;
      } else {
        displayName = p.label || 'æœªçŸ¥';
      }
      
      return `
      <div class="photo" data-record-id="${record.id}" data-photo-index="${idx}" onclick="previewRecordPhoto(${record.id}, ${idx})">
        <img src="${p.url}" alt="é£Ÿç‰©ç…§ç‰‡">
        <em>${displayName}<br>${p.sugar ? p.sugar + ' g' : '0g'}</em>
        <span data-record-id="${record.id}" data-photo-idx="${idx}" class="delete-photo" onclick="deleteRecordPhoto(event, ${record.id}, ${idx})">âœ–</span>
        <span class="edit-sugar" data-record-id="${record.id}" data-photo-idx="${idx}" onclick="openRecordPhotoEditModal(event, ${record.id}, ${idx})">âœï¸</span>
      </div>`;
    }).join('');
    
    // æ·»åŠ ç³–åˆ†ç¸½å’Œ
    const sugarSum = calculateSugarSum(record.photos);
    photosHtml += `<div style="margin-top:10px;width:100%;text-align:right">
                     <strong>é£Ÿç‰©ç³–åˆ†ç¸½å’Œ: ${sugarSum} g</strong>
                   </div>`;
  } else {
    photosHtml = '<p>æ²’æœ‰é£Ÿç‰©ç…§ç‰‡</p>';
  }
  
  $('editPhotosWrap').innerHTML = photosHtml;
  
  $('editRecordModal').style.display = 'block';
}

// é è¦½è¨˜éŒ„ä¸­çš„ç…§ç‰‡
function previewRecordPhoto(recordId, photoIdx) {
  const record = records.find(r => r.id == recordId);
  if (record && record.photos && record.photos[photoIdx]) {
    const photo = record.photos[photoIdx];
    
    // æ‰“é–‹é è¦½
    $('previewImg').src = photo.url;
    
    // è¨­ç½®æ¨™é¡Œ
    let caption = '';
    if (photo.label === 'non-food') {
      caption = 'éé£Ÿç‰© (0 g ç³–åˆ†)';
    } else if (photo.label && sugarValues[photo.label]) {
      caption = `${sugarValues[photo.label].name}: ${photo.sugar} g ç³–åˆ†/100g`;
    } else {
      caption = `ç³–åˆ†: ${photo.sugar} g/100g`;
    }
    $('previewCaption').textContent = caption;
    
    // æ·»åŠ ç·¨è¼¯åŠŸèƒ½
    $('previewEditBtn').style.display = 'block';
    $('previewEditBtn').onclick = function() {
      $('imgPreviewModal').style.display = 'none';
      openRecordPhotoEditModal(null, recordId, photoIdx);
    };
    
    // é¡¯ç¤ºæ¨¡æ…‹æ¡†
    $('imgPreviewModal').style.display = 'block';
  }
}

// ä¿å­˜ç·¨è¼¯çš„è¨˜éŒ„
function saveEditedRecord() {
  const recordId = $('editRecordId').value;
  const recordIndex = records.findIndex(r => r.id == recordId);
  
  if (recordIndex === -1) return;
  
  const record = records[recordIndex];
  
  // æ›´æ–°è¨˜éŒ„
  record.name = $('editName').value.trim();
  record.age = $('editAge').value.trim();
  record.date = $('editDate').value;
  record.meal = $('editMeal').value;
  record.sugarMmol = parseFloat($('editSugarMmol').value) || null;
  
  // æ›´æ–°ç³–åˆ†ç¸½å’Œ
  record.sugarSum = calculateSugarSum(record.photos);
  
  // ä¿å­˜è¨˜éŒ„
  if (saveRecords()) {
    $('editRecordModal').style.display = 'none';
    render();
    alert('è¨˜éŒ„å·²æ›´æ–°');
  }
}

// è¨˜éŒ„ç…§ç‰‡ç·¨è¼¯å‡½æ•¸
function openRecordPhotoEditModal(event, recordId, photoIdx) {
  if (event) {
    event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
  }
  
  const record = records.find(r => r.id == recordId);
  if (!record || !record.photos || !record.photos[photoIdx]) return;
  
  const photo = record.photos[photoIdx];
  
  // è¨­ç½®åœ–ç‰‡
  $('editImage').src = photo.url;
  
  // è¨­ç½®åˆ†æçµæœèªªæ˜
  if (photo.source && photo.source !== 'manual') {
    $('aiResult').textContent = `è­˜åˆ¥ç‚º: ${sugarValues[photo.label]?.name || photo.label}`;
  } else {
    $('aiResult').textContent = '';
  }
  
  // è¨­ç½®ä¸‹æ‹‰æ¡†
  $('foodTypeSelect').value = photo.label || '';
  
  // è¨­ç½®ç³–åˆ†å€¼
  $('editSugarValue').value = photo.sugar || '';
  
  // è¨­ç½®ä¿å­˜æŒ‰éˆ•é»æ“Šè™•ç†
  $('saveSugarBtn').onclick = function() {
    const selectedFood = $('foodTypeSelect').value;
    const value = parseFloat($('editSugarValue').value);
    
    if (selectedFood) {
      photo.label = selectedFood;
      // å¦‚æœæœ‰å°æ‡‰çš„ç³–åˆ†æ•¸æ“šï¼Œä½¿ç”¨å®ƒ
      if (sugarValues[selectedFood] && !isNaN(sugarValues[selectedFood].sugar)) {
        photo.sugar = sugarValues[selectedFood].sugar;
      }
    }
    
    if (!isNaN(value)) {
      photo.sugar = value;
    }
    
    photo.state = 'done';
    photo.manual = true;
    
    // æ›´æ–°ç³–åˆ†ç¸½å’Œ
    record.sugarSum = calculateSugarSum(record.photos);
    
    // ä¿å­˜è¨˜éŒ„
    saveRecords();
    
    // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    render();
    
    // é—œé–‰ç·¨è¼¯æ¡†
    $('editModal').style.display = 'none';
  };
  
  // é¡¯ç¤ºæ¨¡æ…‹æ¡†
  $('editModal').style.display = 'block';
}

// åˆªé™¤è¨˜éŒ„ä¸­çš„ç…§ç‰‡
function deleteRecordPhoto(event, recordId, photoIdx) {
  event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
  
  const record = records.find(r => r.id == recordId);
  if (record && record.photos && record.photos[photoIdx]) {
    record.photos.splice(photoIdx, 1);
    record.sugarSum = calculateSugarSum(record.photos);
    saveRecords();
    
    // æ›´æ–°è¦–åœ–
    editRecord(recordId);
  }
}

// é¡¯ç¤ºåˆªé™¤ç¢ºèªå°è©±æ¡†
function showDeleteConfirm(recordId) {
  currentDeletingRecordId = recordId;
  $('deleteConfirmModal').style.display = 'block';
}

// åˆªé™¤è¨˜éŒ„
function deleteRecord(recordId) {
  const index = records.findIndex(r => r.id == recordId);
  if (index !== -1) {
    records.splice(index, 1);
    if (saveRecords()) {
      render();
      alert('è¨˜éŒ„å·²åˆªé™¤');
    }
  }
}

/* ---------- ç”¨æˆ·ç•Œé¢æ¸²æŸ“ ----------------------------- */
// æ¸²æŸ“ç”¨æˆ·ç•Œé¢
function render() {
  // è¨­ç½®æœˆä»½é¸æ“‡å™¨é è¨­å€¼ç‚ºç•¶å‰æœˆä»½
  if (!$('monthPick').value) {
    $('monthPick').value = today().substring(0, 7);
  }
  
  buildList();
  buildCal();
  if (chartShown) renderChart();
}

// æ§‹å»ºè¨˜éŒ„åˆ—è¡¨
function buildList() {
  const ym = $('monthPick').value;
  const filteredRecords = records.filter(r => !ym || r.date.startsWith(ym));
  
  if (filteredRecords.length === 0) {
    $('listBox').innerHTML = '<div style="text-align:center;color:#666;padding:2rem">ç•¶æœˆæ²’æœ‰è¨˜éŒ„</div>';
    return;
  }
  
  $('listBox').innerHTML = filteredRecords.map(r => {
    // è¨ˆç®—æˆ–ä½¿ç”¨å·²ä¿å­˜çš„ç³–åˆ†ç¸½å’Œ
    const sugarSum = r.sugarSum || calculateSugarSum(r.photos);
    
    return `
    <div class="list-card">
      <div class="list-actions">
        <button class="btn-edit" onclick="editRecord(${r.id})">ç·¨è¼¯</button>
        <button class="btn-delete" onclick="showDeleteConfirm(${r.id})">åˆªé™¤</button>
      </div>
      <h4>${formatDate(r.date)}ï¼ˆ${r.meal}ï¼‰</h4>
      ${r.name || r.age ? `<p>å§“åï¼š${r.name || '-'}ã€€å¹´é½¡ï¼š${r.age || '-'}</p>` : ''}
      ${r.sugarMmol != null ? `<p>è¡€ç³–ï¼š<strong>${r.sugarMmol}</strong> mmol/L</p>` : ''}
      ${r.photos && r.photos.length ? `<div class="attach">
        ${r.photos.map((p, idx) => {
          let displayName = '';
          
          if (p.label === 'non-food') {
            displayName = 'éé£Ÿç‰©';
          } else if (p.label && sugarValues[p.label]) {
            displayName = sugarValues[p.label].name;
          } else {
            displayName = p.label || 'æœªçŸ¥';
          }
          
          return `
          <figure onclick="previewRecordPhoto(${r.id}, ${idx})">
            <img src="${p.url}" alt="é£Ÿç‰©ç…§ç‰‡">
            <figcaption>${displayName}<br>${p.sugar ? p.sugar + ' g' : '0g'}</figcaption>
          </figure>`;
        }).join('')}
      </div>` : ''}
      ${r.photos && r.photos.length ? 
        `<div class="list-sugar-sum">é£Ÿç‰©ç³–åˆ†ç¸½å’Œ: <strong>${sugarSum} g</strong></div>` : ''}
    </div>`;
  }).join('');
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateStr) {
  const parts = dateStr.split('-');
  return `${parts[0]}å¹´${parts[1]}æœˆ${parts[2]}æ—¥`;
}

// æ§‹å»ºæœˆæ›†è¦–åœ–
function buildCal() {
  const ym = $('monthPick').value || today().substring(0, 7);
  const [y, m] = ym.split('-').map(Number);
  
  // ç²å–ç•¶æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå¹¾
  const first = new Date(y, m-1, 1);
  // ç²å–ç•¶æœˆå¤©æ•¸
  const days = new Date(y, m, 0).getDate();
  
  let html = '<table class="calendar"><thead><tr>' + 
    'æ—¥ä¸€äºŒä¸‰å››äº”å…­'.split('').map(d => `<th>${d}</th>`).join('') +
    '</tr></thead><tbody><tr>';
    
  // ç¬¬ä¸€é€±å¡«å……ç©ºç™½
  for (let i = 0; i < first.getDay(); i++) {
    html += '<td></td>';
  }
  
  // å¡«å……æ—¥æœŸ
  for (let d = 1; d <= days; d++) {
    const ds = `${ym}-${String(d).padStart(2, '0')}`;
    const dayRecords = records.filter(r => r.date === ds);
    
    html += `<td><strong>${d}</strong><br>`;
    
    if (dayRecords.length) {
      dayRecords.forEach(r => {
        const mealIcon = r.meal === 'æ—©é¤' ? 'ğŸŒ…' : r.meal === 'åˆé¤' ? 'â˜€ï¸' : 'ğŸŒ™';
        const sugarColor = r.sugarMmol 
          ? (r.sugarMmol > 10 ? 'color:red' : r.sugarMmol < 4 ? 'color:blue' : '') 
          : '';
        html += `<div style="font-size:0.7rem;${sugarColor}" onclick="editRecord(${r.id})">${mealIcon} ${r.sugarMmol ? r.sugarMmol + 'mmol/L' : 'ç„¡è¡€ç³–'}</div>`;
      });
    }
    
    html += '</td>';
    
    // æ›è¡Œ
    if ((first.getDay() + d) % 7 === 0 && d !== days) {
      html += '</tr><tr>';
    }
  }
  
  // æœ€å¾Œä¸€é€±å¡«å……ç©ºç™½
  const rem = (first.getDay() + days) % 7;
  if (rem) {
    html += `<td colspan="${7-rem}"></td>`;
  }
  
  html += '</tr></tbody></table>';
  $('calBox').innerHTML = html;
}

// æ¸²æŸ“è¡€ç³–åœ–è¡¨
function renderChart() {
  if (!chartShown) return;
  
  const ym = $('monthPick').value;
  const rows = records.filter(r => r.sugarMmol != null && (!ym || r.date.startsWith(ym)))
    .sort((a, b) => a.date.localeCompare(b.date) || mealOrder(a.meal) - mealOrder(b.meal));
  
  function mealOrder(meal) {
    return meal === 'æ—©é¤' ? 0 : meal === 'åˆé¤' ? 1 : 2;
  }
  
  if (!rows.length) {
    document.querySelector('.chartWrap').innerHTML = '<div style="text-align:center;color:#666;padding:2rem">æ²’æœ‰è¶³å¤ çš„è¡€ç³–æ•¸æ“šä¾†ç”Ÿæˆåœ–è¡¨</div>';
    return;
  }
  
  // ç¢ºä¿Chart.jså·²åŠ è¼‰
  if (typeof Chart === 'undefined') {
    document.querySelector('.chartWrap').innerHTML = '<div style="text-align:center;color:#666;padding:2rem">åœ–è¡¨åº«åŠ è¼‰å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢</div>';
    return;
  }
  
  try {
    // éŠ·æ¯€èˆŠåœ–è¡¨
    if (chart) {
      chart.destroy();
    }
    
    // å»ºç«‹æ–°åœ–è¡¨å®¹å™¨
    document.querySelector('.chartWrap').innerHTML = '<canvas id="sugarChart"></canvas>';
    
    // ç²å–ç¹ªåœ–ä¸Šä¸‹æ–‡
    const ctx = document.getElementById('sugarChart').getContext('2d');
    
    // å®šç¾©æ­£å¸¸ç¯„åœ
    const normalRange = {
      breakfast: { min: 4.0, max: 7.0 },
      lunch: { min: 4.0, max: 10.0 },
      dinner: { min: 4.0, max: 10.0 }
    };
    
    // å‰µå»ºæ–°åœ–è¡¨
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: rows.map(r => formatDate(r.date).substring(5) + ' ' + r.meal),
        datasets: [
          {
            label: 'è¡€ç³– (mmol/L)',
            data: rows.map(r => r.sugarMmol),
            borderColor: '#d32f2f',
            backgroundColor: 'rgba(211, 47, 47, 0.2)',
            tension: 0.3,
            pointRadius: 5,
            pointBackgroundColor: '#d32f2f',
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.raw;
                let meal = rows[context.dataIndex].meal;
                let range = meal === 'æ—©é¤' ? normalRange.breakfast :
                            meal === 'åˆé¤' ? normalRange.lunch : normalRange.dinner;
                
                let status = value < range.min ? 'åä½' : 
                            value > range.max ? 'åé«˜' : 'æ­£å¸¸';
                
                return [`è¡€ç³–å€¼: ${value} mmol/L`, `ç‹€æ…‹: ${status}`];
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            min: 3,
            max: Math.max(15, ...rows.map(r => r.sugarMmol)) + 1,
            title: {
              display: true,
              text: 'è¡€ç³–å€¼ (mmol/L)'
            }
          }
        }
      }
    });
  } catch (e) {
    console.error('åœ–è¡¨æ¸²æŸ“å¤±æ•—', e);
    document.querySelector('.chartWrap').innerHTML = `<div style="text-align:center;color:#666;padding:2rem">åœ–è¡¨æ¸²æŸ“å¤±æ•—: ${e.message}</div>`;
  }
}
<script>
function submitEditedFood() {
  const name = $('customName').value.trim();
  const amount = parseFloat($('amount').value) || 100;

  if (!photos.length) {
    alert("è«‹å…ˆä¸Šå‚³æˆ–æ‹æ”é£Ÿç‰©ç…§ç‰‡");
    return;
  }

  photos.forEach(p => {
    p.label = name || 'custom';
    p.sugar = (amount / 100) * (sugarValues[name]?.sugar || 5.0);
    p.manual = true;
    p.state = 'done';
  });

  renderPhotos();
  updateSugarSum();
  alert("å·²å¥—ç”¨è‡ªå®šç¾©è³‡æ–™");
}
</script>
</body>
</html>
