<!DOCTYPE html>
<!--  ç³–å°¿ç—…å¥åº·ç®¡ç†  v3.0  (2024-06-25)
     â€¢ ç›¸ç‰‡ â†’ AI è‡ªå‹•ä¼°æ¯ 100 g å«ç³–é‡ (TF.js + MobileNet + OpenFoodFacts)
     â€¢ è¡€ç³–åƒ…é¡¯ç¤º mmol/L
----------------------------------------------------------------- -->
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ç³–å°¿ç—…å¥åº·ç®¡ç†</title>
<style>
:root{--c1:#1976d2;--c2:#d32f2f;--r:8px;
      font-family:system-ui,-apple-system,"Noto Sans","Segoe UI",sans-serif}
*{box-sizing:border-box;margin:0}
body{background:#fafafa;color:#333;display:flex;flex-direction:column;min-height:100vh}
header{background:var(--c1);color:#fff;padding:1rem;text-align:center}
nav{display:flex}nav button{flex:1;padding:.7rem;border:0;background:#eee;font-size:1rem}
nav button.active{color:var(--c1);background:#fff;font-weight:700;border-bottom:3px solid var(--c1)}
main{flex:1;width:95%;max-width:900px;margin:1rem auto}
section{display:none}section.active{display:block}

form{background:#fff;padding:1rem;border-radius:var(--r);box-shadow:0 2px 6px #0001;display:flex;flex-direction:column;gap:.8rem}
label{display:flex;flex-direction:column;font-weight:600;font-size:.9rem}
input,select,button{padding:.55rem .6rem;font-size:1rem;border:1px solid #ccc;border-radius:var(--r)}
input[type=checkbox]{width:1.2rem;height:1.2rem;margin-right:.45rem}
.inline{flex-direction:row;align-items:center;gap:.45rem}

#photosWrap{display:flex;flex-wrap:wrap;gap:.45rem;margin-top:.4rem}
.photo-thumb{width:80px;height:80px;border:1px solid #ccc;border-radius:var(--r);position:relative;overflow:hidden}
.photo-thumb img{width:100%;height:100%;object-fit:cover}
.photo-thumb span.del{position:absolute;top:-6px;right:-6px;background:#fff;border:1px solid #999;border-radius:50%;font-size:.7rem;width:18px;height:18px;line-height:16px;text-align:center;cursor:pointer}
.photo-thumb span.edit{position:absolute;bottom:-6px;right:-6px;background:#fff;border:1px solid #999;border-radius:50%;font-size:.7rem;width:18px;height:18px;line-height:16px;text-align:center;cursor:pointer}
.photo-thumb em{position:absolute;left:0;right:0;bottom:0;background:#fff;color:#000;font-size:.9rem;font-weight:600;text-align:center;cursor:pointer}

#listTools{display:flex;align-items:center;gap:.7rem;margin-bottom:1rem}
#subTabs{display:flex;margin-bottom:1rem}
#subTabs button{flex:1;padding:.6rem;border:0;background:#eee;border-radius:var(--r)}
#subTabs button.active{background:var(--c1);color:#fff}

#listBox .card{background:#fff;padding:1rem;border-radius:var(--r);box-shadow:0 2px 4px #0001;margin-bottom:.9rem}
.card h4{margin-bottom:.35rem;color:var(--c1)}
.attach{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.4rem}
.attach figure{margin:0;position:relative}
.attach img{width:64px;height:64px;object-fit:cover;border-radius:var(--r);border:1px solid #ccc}
.attach figcaption{position:absolute;left:0;right:0;bottom:0;font-size:.9rem;font-weight:600;background:#fff;color:#000;text-align:center;border-radius:0 0 var(--r) var(--r)}

.calendar{width:100%;border-collapse:collapse}
.calendar th,.calendar td{border:1px solid #ddd;width:14.28%;height:88px;vertical-align:top;padding:2px;font-size:.74rem}
.calendar th{background:#f0f0f0}

.chartWrap{margin-top:1.2rem}
canvas{max-width:100%;height:250px!important}

/* Modal */
#camModal,#dlg{position:fixed;inset:0;background:#0008;display:none;justify-content:center;align-items:center;z-index:99}
#camModal video{width:100vw;height:100vh;object-fit:cover}
#camModal button{position:fixed;bottom:40px;left:50%;transform:translateX(-50%);width:72px;height:72px;border-radius:50%;border:4px solid #fff;background:#fff4;font-size:0}
#camClose{position:fixed;top:20px;right:20px;background:#fff;border:none;border-radius:50%;width:38px;height:38px;font-size:1.2rem;line-height:34px}
#dlgBox{background:#fff;padding:1.2rem;border-radius:var(--r);width:280px;display:flex;flex-direction:column;gap:.8rem}
</style>
</head>
<body>
<header><h1>ç³–å°¿ç—…å¥åº·ç®¡ç†</h1></header>

<nav>
  <button id="tabForm" class="active">æ–°å¢ç´€éŒ„</button>
  <button id="tabList">ç´€&nbsp;éŒ„</button>
</nav>

<main>
  <!-- ========= A. æ–°å¢ç´€éŒ„ ========= -->
  <section id="formSec" class="active">
    <form id="recordForm">
      <label class="inline">
        <input type="checkbox" id="showInfo"> é¡¯ç¤ºå€‹äººè³‡æ–™
      </label>

      <div class="personal">
        <label>å§“å <input id="name" required></label>
        <label>å¹´é½¡ <input id="age" type="number" min="1" max="120" required></label>
      </div>

      <label>æ—¥æœŸ <input id="date" type="date" required></label>

      <label>é¤æ¬¡
        <select id="meal"><option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option></select>
      </label>

      <label>è¡€ç³– (mmol/Lï¼Œå¯ç•™ç©º) <input id="sugarMmol" type="number" min="1" max="40" step="0.1"></label>

      <label class="inline">æ‹ç…§
        <button id="captureBtn" type="button">ğŸ“· æ‹ç…§</button>
        <input id="captureIn" type="file" accept="image/jpeg" capture="environment" hidden>
      </label>

      <label class="inline">ä¸Šè¼‰é£Ÿç‰©ç…§ç‰‡
        <button id="uploadBtn" type="button">ğŸ“‘ é¸æ“‡æª”æ¡ˆ</button>
        <input id="uploadIn" type="file" accept="image/*" multiple hidden>
      </label>
      <small style="color:#666">AI ä¼°å€¼å®Œæˆå‰æœƒé¡¯ç¤º â³ï¼Œå¦‚ä¸æº–å¯æ‰‹å‹•é» âœï¸ ä¿®æ­£ã€‚</small>

      <div id="photosWrap"></div>

      <button type="submit" style="background:var(--c1);color:#fff">å„²å­˜ç´€éŒ„</button>
    </form>
  </section>

  <!-- ========= B. ç´€éŒ„ ========= -->
  <section id="listSec">
    <div id="listTools">
      <label style="display:flex;flex-direction:column;font-weight:600;font-size:.9rem">
        æœˆä»½ <input id="filterMonth" type="month">
      </label>
      <button id="toggleChart" style="background:#eee;border:1px solid #ccc;border-radius:var(--r);padding:.45rem .9rem">åˆ†æåœ–è¡¨</button>
    </div>

    <div id="subTabs">
      <button id="subList" class="active">åˆ—è¡¨</button>
      <button id="subCal">æœˆæ›†</button>
    </div>

    <div id="listBox"></div>
    <div id="calBox" style="display:none"></div>

    <div class="chartWrap" style="display:none">
      <canvas id="sugarChart"></canvas>
    </div>
  </section>
</main>

<!-- ========= ç›¸æ©Ÿ ========= -->
<div id="camModal">
  <video id="camPrev" playsinline></video>
  <button id="shutter"></button>
  <button id="camClose">âœ•</button>
</div>

<!-- ========= ç³–ä»½è¼¸å…¥ ========= -->
<div id="dlg">
  <div id="dlgBox">
    <h3 style="margin:0;font-size:1.05rem">æ¯ 100 g å«ç³– (g)</h3>
    <input id="dlgInput" type="number" min="0" step="0.1">
    <div style="display:flex;gap:.6rem;justify-content:flex-end">
      <button id="dlgOK" style="background:var(--c1);color:#fff">ç¢ºå®š</button>
      <button id="dlgCancel">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- === ä¾åºè¼‰å…¥ï¼šTensorFlow.jsã€MobileNetã€Chart.js === -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.2.1/dist/mobilenet.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<script>
/* ========= å·¥å…· ========= */
const $=id=>document.getElementById(id);
const today=()=>new Date().toISOString().split('T')[0];

/* ========= å…¨å±€ç‹€æ…‹ ========= */
let photos=[],records=[],chart,chartVisible=false,stream,dlgIdx=-1;
let mobilenetModel; // AI æ¨¡å‹

/* ========= åˆå§‹åŒ– ========= */
document.addEventListener('DOMContentLoaded',async()=>{
  $('date').value=today();
  $('name').value=localStorage.getItem('dm_name')||'';
  $('age').value =localStorage.getItem('dm_age') ||'';
  $('showInfo').checked=false;
  togglePersonal();
  mobilenetModel=await mobilenet.load(); // è¼‰å…¥ AI æ¨¡å‹
  refresh();
});

/* ========= è¡¨å–®å€‹è³‡é¡¯ç¤º ========= */
$('showInfo').onchange=togglePersonal;
function togglePersonal(){
  const show=$('showInfo').checked;
  document.querySelector('.personal').style.display=show?'flex':'none';
  $('name').required=$('age').required=show;
}

/* ========= åˆ†é  ========= */
$('tabForm').onclick=()=>switchTab(true);$('tabList').onclick=()=>switchTab(false);
function switchTab(on){$('tabForm').classList.toggle('active',on);$('tabList').classList.toggle('active',!on);$('formSec').classList.toggle('active',on);$('listSec').classList.toggle('active',!on);refresh();}
$('subList').onclick=()=>toggleSub(true);$('subCal').onclick=()=>toggleSub(false);
function toggleSub(on){$('subList').classList.toggle('active',on);$('subCal').classList.toggle('active',!on);$('listBox').style.display=on?'block':'none';$('calBox').style.display=on?'none':'block';}

/* ========= ç›¸ç‰‡è™•ç† ========= */
$('captureBtn').onclick=()=>startCamera();$('uploadBtn').onclick=()=>$('uploadIn').click();
$('captureIn').onchange=e=>addFiles(e.target.files);$('uploadIn').onchange=e=>addFiles(e.target.files);
$('photosWrap').onclick=photoClick;

async function addFiles(fs){
  for(const f of fs){
    if(!f.type.startsWith('image/'))continue;
    const url=await compressFile(f);
    const p={url,sugarPer100:null,aiPending:true};
    photos.push(p);renderPhotos();
    estimateSugar(p); // AI ä¼°ç®—
  }
}
/* å£“ç¸® */
function compressFile(file){return new Promise(res=>{
  const img=new Image();img.onload=()=>{
    const max=1024;let {width:w,height:h}=img;if(Math.max(w,h)>max){const r=max/Math.max(w,h);w*=r;h*=r;}
    const c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);
    c.toBlob(b=>res(URL.createObjectURL(b)),'image/jpeg',0.75);};img.src=URL.createObjectURL(file);});}

/* AI ä¼°ç®—ç³–ä»½ */
async function estimateSugar(photo){
  try{
    const img=new Image();img.src=photo.url;await img.decode();
    const pred=await mobilenetModel.classify(img);
    const label=pred[0].className.split(',')[0];               // å– Top-1 æ¨™ç±¤
    const g=await fetchSugar(label);
    if(g!==null){photo.sugarPer100=g;}
  }catch{ /* ç„¡è«–æˆæ•—ï¼Œæœ€å¾Œéƒ½è¦å–æ¶ˆ pending */ }
  finally{photo.aiPending=false;renderPhotos();refresh();}
}
/* ç”±é£Ÿç‰©åç¨±æŸ¥ openfoodfactsï¼Œå›å‚³ç³– g/100gï¼ˆå–å¹³å‡ï¼‰*/
async function fetchSugar(keyword){
  try{
    const r=await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(keyword)}&search_simple=1&action=process&json=1&page_size=10`);
    const js=await r.json();
    const list=js.products.filter(p=>p.nutriments?.sugars_100g>0).map(p=>p.nutriments.sugars_100g);
    if(!list.length)return null;
    return +(list.reduce((s,v)=>s+v,0)/list.length).toFixed(1);
  }catch{return null;}
}

/* ç¸®åœ–æ¸²æŸ“ */
function renderPhotos(){
  $('photosWrap').innerHTML='';
  photos.forEach((p,i)=>{
    const txt=p.aiPending?'â³':(p.sugarPer100!==null?p.sugarPer100+' g':'? g');
    $('photosWrap').insertAdjacentHTML('beforeend',`
      <div class="photo-thumb">
        <img src="${p.url}">
        <span class="del"  data-del ="${i}">âœ–</span>
        <span class="edit" data-edit="${i}">âœï¸</span>
        <em data-edit="${i}">${txt}</em>
      </div>`);
  });
}

/* é»ç¸®åœ–ï¼šåˆª / æ‰‹æ”¹ */
function photoClick(e){
  if(e.target.dataset.del!==undefined){photos.splice(+e.target.dataset.del,1);renderPhotos();return;}
  if(e.target.dataset.edit!==undefined){
    dlgIdx=+e.target.dataset.edit;
    $('dlgInput').value=photos[dlgIdx].sugarPer100??'';
    $('dlg').style.display='flex';$('dlgInput').focus();
  }
}
$('dlgOK').onclick=()=>{const v=parseFloat($('dlgInput').value);if(!isNaN(v)&&v>=0){photos[dlgIdx].sugarPer100=v;photos[dlgIdx].aiPending=false;}$('dlg').style.display='none';renderPhotos();refresh();};
$('dlgCancel').onclick=()=>$('dlg').style.display='none';$('dlg').onclick=e=>{if(e.target===$('dlg'))$('dlg').style.display='none';};

/* ========= ç›¸æ©Ÿ ========= */
async function startCamera(){
  if(location.protocol!=='https:'&&location.hostname!=='localhost'){ $('captureIn').click();return;}
  try{stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});$('camPrev').srcObject=stream;await $('camPrev').play();$('camModal').style.display='flex';}catch{$('captureIn').click();}
}
$('shutter').onclick=takeShot;$('camPrev').onclick=takeShot;$('camClose').onclick=closeCam;
function takeShot(){
  const v=$('camPrev');if(!v.videoWidth)return;
  const max=1024,r=max/Math.max(v.videoWidth,v.videoHeight),w=r<1?v.videoWidth*r:v.videoWidth,h=r<1?v.videoHeight*r:v.videoHeight;
  const c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(v,0,0,w,h);
  c.toBlob(async b=>{const url=URL.createObjectURL(b);const p={url,sugarPer100:null,aiPending:true};photos.push(p);renderPhotos();estimateSugar(p);closeCam();},'image/jpeg',0.75);
}
function closeCam(){stream?.getTracks().forEach(t=>t.stop());$('camModal').style.display='none';}

/* ========= å„²å­˜ ========= */
$('recordForm').onsubmit=e=>{
  e.preventDefault();
  if(photos.some(p=>p.aiPending)){alert('ä»æœ‰ç›¸ç‰‡åœ¨åˆ†æä¸­ï¼Œè«‹ç¨å€™');return;}
  localStorage.setItem('dm_name',$('name').value.trim());localStorage.setItem('dm_age',$('age').value);
  records.unshift({name:$('name').value.trim(),age:+$('age').value,date:$('date').value,meal:$('meal').value,sugarMmol:parseFloat($('sugarMmol').value)||null,photos:JSON.parse(JSON.stringify(photos))});
  $('recordForm').reset();$('name').value=localStorage.getItem('dm_name');$('age').value=localStorage.getItem('dm_age');$('date').value=today();photos=[];renderPhotos();refresh();alert('å·²å„²å­˜ï¼');
};

/* ========= åˆ—è¡¨ ========= */
function buildList(){
  const ym=$('filterMonth').value;$('listBox').innerHTML='';
  records.filter(r=>!ym||r.date.startsWith(ym)).forEach(r=>{
    const card=document.createElement('div');card.className='card';
    card.innerHTML=`<h4>${r.date}ï¼ˆ${r.meal}ï¼‰</h4><p>å§“åï¼š${r.name}ã€€å¹´é½¡ï¼š${r.age}</p>${r.sugarMmol?`<p>è¡€ç³–ï¼š<strong>${r.sugarMmol}</strong> mmol/L</p>`:'<p>æœªé‡è¡€ç³–</p>'}`;
    if(r.photos.length){const wrap=document.createElement('div');wrap.className='attach';
      r.photos.forEach(p=>wrap.insertAdjacentHTML('beforeend',`<figure><img src="${p.url}"><figcaption>${p.sugarPer100!==null?p.sugarPer100+' g':'? g'}</figcaption></figure>`));card.appendChild(wrap);}
    $('listBox').appendChild(card);
  });
}

/* ========= æœˆæ›† ========= */
function buildCalendar(){
  const ym=$('filterMonth').value||today().slice(0,7);const [y,m]=ym.split('-').map(Number);
  const first=new Date(y,m-1,1),total=new Date(y,m,0).getDate();
  let html='<table class="calendar"><thead><tr>'+'æ—¥ä¸€äºŒä¸‰å››äº”å…­'.split('').map(d=>`<th>${d}</th>`).join('')+'</tr></thead><tbody><tr>';
  for(let i=0;i<first.getDay();i++)html+='<td></td>';
  for(let d=1;d<=total;d++){
    const ds=`${ym}-${String(d).padStart(2,'0')}`,rows=records.filter(r=>r.date===ds),avg= (()=>{const arr=rows.flatMap(r=>r.photos.map(p=>p.sugarPer100).filter(v=>v!==null));return arr.length?(arr.reduce((s,v)=>s+v,0)/arr.length).toFixed(1):''})();
    html+=`<td><strong>${d}</strong><br>${rows.length?`ç­†:${rows.length}<br>${avg?'Avg:'+avg+'g':''}`:''}</td>`;
    if((first.getDay()+d)%7===0&&d!==total)html+='</tr><tr>';
  }
  const rest=(first.getDay()+total)%7;if(rest)html+=`<td colspan="${7-rest}"></td>`;html+='</tr></tbody></table>';$('calBox').innerHTML=html;
}

/* ========= åœ–è¡¨ (mmol/L) ========= */
$('toggleChart').onclick=()=>{if(!chartVisible && records.every(r=>!r.sugarMmol)){alert('ç›®å‰æ²’æœ‰è¡€ç³–æ•¸æ“š');return;}chartVisible=!chartVisible;$('toggleChart').textContent=chartVisible?'éš±è—åœ–è¡¨':'åˆ†æåœ–è¡¨';buildChart();};
function buildChart(){
  if(!chartVisible){$('chartWrap').style.display='none';return;}
  const rows=records.filter(r=>(!$('filterMonth').value||r.date.startsWith($('filterMonth').value))&&r.sugarMmol);
  if(!rows.length){$('chartWrap').style.display='none';alert('è©²æœˆä»½æ²’æœ‰è¡€ç³–æ•¸æ“š');chartVisible=false;$('toggleChart').textContent='åˆ†æåœ–è¡¨';return;}
  $('chartWrap').style.display='block';chart?.destroy();
  chart=new Chart($('sugarChart'),{type:'line',
    data:{labels:rows.map(r=>r.date+' '+r.meal),datasets:[{label:'è¡€ç³– (mmol/L)',data:rows.map(r=>r.sugarMmol),borderColor:'#d32f2f',backgroundColor:'#d32f2f33',tension:.25,pointRadius:4,pointBackgroundColor:'#d32f2f'}]},
    options:{maintainAspectRatio:false}});
}

/* ========= refresh ========= */
function refresh(){buildList();buildCalendar();if(chartVisible)buildChart();}
</script>
</body>
</html>
