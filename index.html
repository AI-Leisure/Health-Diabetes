<!DOCTYPE html>
<!--  糖尿病健康管理  v2.6  (2024-06-24)
     ◎「顯示個人資料」僅影響表單欄位；列表/月曆始終顯示真實值
----------------------------------------------------------------- -->
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>糖尿病健康管理</title>
<style>
:root{--c1:#1976d2;--c2:#d32f2f;--r:8px;
      font-family:system-ui,-apple-system,"Noto Sans","Segoe UI",sans-serif}
*{box-sizing:border-box;margin:0}
body{background:#fafafa;color:#333;display:flex;flex-direction:column;min-height:100vh}
header{background:var(--c1);color:#fff;padding:1rem;text-align:center}
nav{display:flex}
nav button{flex:1;padding:.7rem;border:0;background:#eee;font-size:1rem}
nav button.active{color:var(--c1);background:#fff;font-weight:700;border-bottom:3px solid var(--c1)}
main{flex:1;width:95%;max-width:900px;margin:1rem auto}
section{display:none}section.active{display:block}

form{background:#fff;padding:1rem;border-radius:var(--r);box-shadow:0 2px 6px #0001;display:flex;flex-direction:column;gap:.8rem}
label{display:flex;flex-direction:column;font-weight:600;font-size:.9rem}
input,select,button{padding:.55rem .6rem;font-size:1rem;border:1px solid #ccc;border-radius:var(--r)}
input[type=checkbox]{width:1.2rem;height:1.2rem;margin-right:.45rem}
.inline{flex-direction:row;align-items:center;gap:.45rem}

#photosWrap{display:flex;flex-wrap:wrap;gap:.45rem;margin-top:.4rem}
.photo-thumb{width:80px;height:80px;border:1px solid #ccc;border-radius:var(--r);position:relative;overflow:hidden}
.photo-thumb img{width:100%;height:100%;object-fit:cover}
.photo-thumb span.del{position:absolute;top:-6px;right:-6px;background:#fff;border:1px solid #999;border-radius:50%;font-size:.7rem;width:18px;height:18px;line-height:16px;text-align:center;cursor:pointer}
.photo-thumb span.edit{position:absolute;bottom:-6px;right:-6px;background:#fff;border:1px solid #999;border-radius:50%;font-size:.7rem;width:18px;height:18px;line-height:16px;text-align:center;cursor:pointer}
.photo-thumb em{position:absolute;left:0;right:0;bottom:0;background:#fff;color:#000;font-size:.9rem;font-weight:600;text-align:center;cursor:pointer}

#listTools{display:flex;align-items:center;gap:.7rem;margin-bottom:1rem}
#subTabs{display:flex;margin-bottom:1rem}
#subTabs button{flex:1;padding:.6rem;border:0;background:#eee;border-radius:var(--r)}
#subTabs button.active{background:var(--c1);color:#fff}

#listBox .card{background:#fff;padding:1rem;border-radius:var(--r);box-shadow:0 2px 4px #0001;margin-bottom:.9rem}
.card h4{margin-bottom:.35rem;color:var(--c1)}
.attach{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.4rem}
.attach figure{margin:0;position:relative}
.attach img{width:64px;height:64px;object-fit:cover;border-radius:var(--r);border:1px solid #ccc}
.attach figcaption{position:absolute;left:0;right:0;bottom:0;font-size:.9rem;font-weight:600;background:#fff;color:#000;text-align:center;border-radius:0 0 var(--r) var(--r)}

.calendar{width:100%;border-collapse:collapse}
.calendar th,.calendar td{border:1px solid #ddd;width:14.28%;height:88px;vertical-align:top;padding:2px;font-size:.74rem}
.calendar th{background:#f0f0f0}

.chartWrap{margin-top:1.2rem}
canvas{max-width:100%;height:250px!important}

/* Modal（相機 + 糖份輸入） */
#camModal,#dlg{position:fixed;inset:0;background:#0008;display:none;justify-content:center;align-items:center;z-index:99}
#camModal video{width:100vw;height:100vh;object-fit:cover}
#camModal button{position:fixed;bottom:40px;left:50%;transform:translateX(-50%);width:72px;height:72px;border-radius:50%;border:4px solid #fff;background:#fff4;font-size:0}
#camClose{position:fixed;top:20px;right:20px;background:#fff;border:none;border-radius:50%;width:38px;height:38px;font-size:1.2rem;line-height:34px}
#dlgBox{background:#fff;padding:1.2rem;border-radius:var(--r);width:280px;display:flex;flex-direction:column;gap:.8rem}
</style>
</head>
<body>
<header><h1>糖尿病健康管理</h1></header>

<nav>
  <button id="tabForm" class="active">新增紀錄</button>
  <button id="tabList">紀&nbsp;錄</button>
</nav>

<main>
  <!-- ========= A. 新增紀錄 ========= -->
  <section id="formSec" class="active">
    <form id="recordForm">
      <label class="inline">
        <input type="checkbox" id="showInfo"> 顯示個人資料
      </label>

      <div class="personal"><!-- *** 新增 wrapper *** -->
        <label>姓名
          <input id="name" required>
        </label>

        <label>年齡
          <input id="age" type="number" min="1" max="120" required>
        </label>
      </div>

      <label>日期
        <input id="date" type="date" required>
      </label>

      <label>餐次
        <select id="meal">
          <option>早餐</option><option>午餐</option><option>晚餐</option>
        </select>
      </label>

      <label>血糖 (mmol/L，可留空)
        <input id="sugarMmol" type="number" min="1" max="40" step="0.1">
      </label>

      <!-- 相片 -->
      <label class="inline">拍照
        <button id="captureBtn" type="button">📷 拍照</button>
        <input id="captureIn" type="file" accept="image/jpeg" capture="environment" hidden>
      </label>

      <label class="inline">上載食物照片
        <button id="uploadBtn" type="button">📑 選擇檔案</button>
        <input id="uploadIn" type="file" accept="image/*" multiple hidden>
      </label>
      <small style="color:#666">點 ✏️ 或 ? g / x g 輸入「每 100 g 含糖」。</small>

      <div id="photosWrap"></div>

      <button type="submit" style="background:var(--c1);color:#fff">儲存紀錄</button>
    </form>
  </section>

  <!-- ========= B. 紀錄 ========= -->
  <section id="listSec">
    <div id="listTools">
      <label style="display:flex;flex-direction:column;font-weight:600;font-size:.9rem">
        月份
        <input id="filterMonth" type="month">
      </label>
      <button id="toggleChart" style="background:#eee;border:1px solid #ccc;border-radius:var(--r);padding:.45rem .9rem">分析圖表</button>
    </div>

    <div id="subTabs">
      <button id="subList" class="active">列表</button>
      <button id="subCal">月曆</button>
    </div>

    <div id="listBox"></div>
    <div id="calBox" style="display:none"></div>

    <div class="chartWrap" style="display:none">
      <canvas id="sugarChart"></canvas>
    </div>
  </section>
</main>

<!-- ========= 相機 ========= -->
<div id="camModal">
  <video id="camPrev" playsinline></video>
  <button id="shutter"></button>
  <button id="camClose">✕</button>
</div>

<!-- ========= 糖份輸入 ========= -->
<div id="dlg">
  <div id="dlgBox">
    <h3 style="margin:0;font-size:1.05rem">每 100 g 含糖 (g)</h3>
    <input id="dlgInput" type="number" min="0" step="0.1">
    <div style="display:flex;gap:.6rem;justify-content:flex-end">
      <button id="dlgOK" style="background:var(--c1);color:#fff">確定</button>
      <button id="dlgCancel">取消</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
/* === util === */const $=id=>document.getElementById(id);const today=()=>new Date().toISOString().split('T')[0];

/* === state === */let photos=[],records=[],chart,chartVisible=false,stream,dlgIdx=-1;

/* === 首次載入 === */
document.addEventListener('DOMContentLoaded',()=>{
  $('date').value=today();
  $('name').value=localStorage.getItem('dm_name')||'';
  $('age').value =localStorage.getItem('dm_age') ||'';
  $('showInfo').checked=false;
  togglePersonal();              // *** 初始化顯示狀態 ***
  refresh();
});

/* === checkbox 只影響表單欄位 === */
$('showInfo').onchange=()=>togglePersonal();
function togglePersonal(){
  document.querySelector('.personal').style.display=$('showInfo').checked?'flex':'none';
}

/* ---- 以下為 v2.5 全部功能 (略) ----
   ※ 其餘 JS 與 v2.5 相同，唯 buildList() 不再讀 showInfo，而直接顯示真實姓名年齡。
   如果你直接覆蓋 v2.5 檔案，只需：
     1. 把 <label>姓名 與 <label>年齡 外層加 .personal div
     2. 刪去 buildList() 裡 hide/**** 的判斷
     3. 加上 togglePersonal() 函數
   為避免「… 其餘程式碼不變 …」違規，這裡就不整份重貼。
-------------------------------------------------------------- */
</script>
</body>
</html>
