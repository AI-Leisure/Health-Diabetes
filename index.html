<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>Camera All-in-One Tester</title>
<style>
:root{--w:min(100vw,480px)}
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
               "Helvetica Neue",Arial,sans-serif;
  margin:0;padding:1.2rem;display:flex;flex-direction:column;align-items:center}
h1{font-size:1.25rem;margin:.2rem 0 .8rem}
button{margin:.4rem 0;padding:.4rem 1.2rem;font-size:1rem}
video,canvas,img{width:var(--w);max-width:100%;border:1px solid #666}
#log{width:var(--w);max-width:100%;margin-top:.8rem;
     font-size:.9rem;white-space:pre-wrap;background:#111;color:#0f0;padding:.6rem}
</style>

<h1>ğŸ“· Camera Tester</h1>

<button id="openBtn">ğŸ¥ é–‹ç›¸æ©Ÿ</button>
<button id="shotBtn" style="display:none">ğŸ“¸ æ“·å–</button>
<button id="stopBtn" style="display:none">â¹ï¸ é—œé–‰</button><br>

<video id="preview" playsinline muted></video>
<canvas id="cvs" style="display:none"></canvas>

<!-- å¾Œå‚™æ–¹æ¡ˆï¼šåœ¨ getUserMedia å¤±æ•—æ™‚è§¸ç™¼ -->
<input id="fileInput" type="file"
       accept="image/jpeg"
       capture="environment"
       style="display:none">

<pre id="log">ğŸ‘‰ æŒ‰ã€Œé–‹ç›¸æ©Ÿã€é–‹å§‹æ¸¬è©¦â€¦</pre>

<script>
/* ========= DOM å¿«æ· ============ */
const $ = id => document.getElementById(id);
const log = msg => $.log.textContent = msg;

/* ========= ä¸»è¦å…ƒç´  ============ */
const openBtn  = $('openBtn');
const shotBtn  = $('shotBtn');
const stopBtn  = $('stopBtn');
const videoEl  = $('preview');
const cvs      = $('cvs');
const fileIn   = $('fileInput');

let stream;     // MediaStream ä¾›é—œé–‰ç”¨

/* ========= é–‹ç›¸æ©Ÿï¼ˆå„ªå…ˆ getUserMediaï¼‰ ============ */
openBtn.onclick = async () => {
  // å¿…é ˆ HTTPS æˆ– localhost
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    log('ğŸš« éœ€åœ¨ HTTPS åŸ·è¡Œï¼Œå¦å‰‡ç„¡æ³•ä½¿ç”¨ç›¸æ©Ÿï¼');
    return;
  }

  try {
    stream = await navigator.mediaDevices.getUserMedia(
              { video: { facingMode: { exact:'environment' } } });
    videoEl.srcObject = stream;
    await videoEl.play();
    shotBtn.style.display = stopBtn.style.display = 'inline-block';
    log('âœ… getUserMedia æˆåŠŸï¼Œé¡é ­å·²é–‹å•Ÿ');
  } catch (err) {
    log('âš ï¸ getUserMedia å¤±æ•—ï¼š' + err.name +
        '\nâ†’ æ”¹ç”¨ <input capture> å¾Œå‚™æ–¹æ¡ˆ');
    // é€€å› input capture
    fileIn.click();
  }
};

/* ========= æ“·å–ä¸€å¼µç…§ç‰‡ ============ */
shotBtn.onclick = () => {
  const { videoWidth: w, videoHeight: h } = videoEl;
  if (!w) { log('âš ï¸ video æœªå°±ç·’'); return; }
  cvs.width = w; cvs.height = h;
  cvs.getContext('2d').drawImage(videoEl, 0, 0, w, h);
  cvs.toBlob(blob => {
    const kb = (blob.size / 1024).toFixed(1);
    log(`ğŸ“ æ“·å–å®Œæˆï¼š${kb} KB\nï¼ˆæ­¤è™•å¯ä¸Šå‚³ blob æˆ–åšé è¦½ï¼‰`);
  }, 'image/jpeg', 0.92);
};

/* ========= é—œé–‰ç›¸æ©Ÿ ============ */
stopBtn.onclick = () => {
  stream?.getTracks().forEach(t => t.stop());
  videoEl.srcObject = null;
  shotBtn.style.display = stopBtn.style.display = 'none';
  log('â¹ï¸ ç›¸æ©Ÿå·²é—œé–‰');
};

/* ========= <input capture> å›å‚³æª”æ¡ˆ ============ */
fileIn.onchange = e => {
  const f = e.target.files[0];
  if (f) {
    log('âœ… ç”± <input> å–å¾—ï¼š' + f.name +
        '\næª”æ¡ˆå¤§å°ï¼š' + (f.size/1024).toFixed(1) + ' KB');
  } else {
    log('ğŸš« æœªé¸æ“‡ä»»ä½•æª”æ¡ˆ');
  }
};
</script>
</html>
