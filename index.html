<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Food Sugar Checker</title>

  <!-- 簡易樣式，直接寫在頁面方便複製 -->
  <style>
    *{box-sizing:border-box;font-family:system-ui,Helvetica,Arial,sans-serif}
    body{margin:0;padding:2rem;text-align:center;background:#f9fafb;color:#222}
    h1{margin:0 0 1rem;font-size:1.6rem}
    #uploader{margin:1rem 0}
    #canvas{display:none;border:1px solid #ccc;margin:1rem auto}
    #result{margin-top:1rem;font-size:1.1rem;min-height:3.5rem}
    .api{font-size:.8rem;color:#666;margin-top:2rem}
    .loading{opacity:.5;pointer-events:none}
  </style>
</head>
<body>

  <h1>🍩 Food Sugar Checker</h1>

  <!-- 1. 上載圖片 -->
  <input id="uploader" type="file" accept="image/*">

  <!-- 2. Canvas 讓 MobileNet 用來預處理 -->
  <canvas id="canvas" width="224" height="224"></canvas>

  <!-- 3. 結果顯示 -->
  <div id="result">Select a food picture…</div>

  <div class="api">
    Powered by TensorFlow JS MobileNet &amp; OpenFoodFacts API
  </div>

  <!-- 4. 載入 TensorFlow 與 MobileNet -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.2.0"></script>

  <script>
  /* ---------------- 可編輯設定 ---------------- */
  // 把 YOUR_WORKER_URL 換成你的 Cloudflare Worker 完整網址
  const WORKER = 'https://off-proxy.leisure9654.workers.dev/
  /* ------------------------------------------ */

  const fileInput  = document.getElementById('uploader');
  const canvas     = document.getElementById('canvas');
  const resultBox  = document.getElementById('result');
  const ctx        = canvas.getContext('2d');

  let model;

  // 1. 載入 MobileNet
  async function loadModel(){
    resultBox.textContent = 'Loading MobileNet model…';
    model = await mobilenet.load();
    resultBox.textContent = 'Model ready ✅';
  }
  loadModel();

  // 2. 使用者選擇圖片
  fileInput.addEventListener('change', async e=>{
    const file=e.target.files[0];
    if(!file) return;

    // UI 鎖定
    document.body.classList.add('loading');
    resultBox.textContent='Analyzing image…';

    // 讀圖→畫到 224×224 canvas
    const img = new Image();
    img.onload = ()=> {
      ctx.drawImage(img, 0, 0, 224, 224);
      classifyAndQuery();
    };
    img.src = URL.createObjectURL(file);
  });

  // 3. 影像分類 + 查糖份
  async function classifyAndQuery(){
    try{
      // (1) MobileNet 取前 3 個 label
      const predictions = await model.classify(canvas);
      console.log('predictions', predictions);
      if(!predictions.length){
        resultBox.textContent='Could not recognise food 🙈';
        return;
      }
      // 取最可能的一個標籤
      const label = predictions[0].className.split(',')[0].trim();
      resultBox.textContent = `🔍 Searching sugar info for “${label}”…`;

      // (2) 呼叫你的 CORS Worker → OpenFoodFacts
      const url = encodeURIComponent(
        `https://world.openfoodfacts.org/api/v2/search?categories_tags_en=${label}&fields=product_name,nutriments&json=1&page_size=1`);
      const resp = await fetch(`${WORKER}?url=${url}`);
      const data = await resp.json();

      const product = data.products?.[0];
      const sugar = product?.nutriments?.['sugars_100g'];

      if(sugar!=null){
        resultBox.innerHTML =
          `🌟 ${product.product_name || label}<br>🧁 Sugar ≈ <b>${sugar} g / 100 g</b>`;
      }else{
        resultBox.textContent='No sugar data found 😢';
      }
    }catch(err){
      console.error(err);
      resultBox.textContent='Error 😵‍💫 – open console for details';
    }finally{
      document.body.classList.remove('loading');
    }
  }
  </script>
</body>
</html>
